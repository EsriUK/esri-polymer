// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/Evented","dojo/Deferred","dojo/keys","dojo/on","dojo/query","dojo/uacss","dojo/dom","dojo/dom-attr","dojo/dom-class","dojo/dom-style","dojo/dom-construct","dojo/i18n!../nls/jsapi","dojo/text!./Search/templates/Search.html","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_FocusMixin","dijit/a11yclick","dijit/focus","../lang","../InfoTemplate","../kernel","../SpatialReference","../graphic","../promiseList","../symbols/PictureMarkerSymbol","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/TextSymbol","../symbols/Font","../geometry/Point","../geometry/Extent","../geometry/scaleUtils","../tasks/locator","../tasks/query","../Color","../styles/basic"],function(e,t,s,i,r,a,o,n,h,c,u,l,d,g,f,m,p,y,_,v,S,x,w,b,R,N,M,I,L,C,P,O,F,E,T,A,j,k,D,B,W){function G(e,t,s,i){var r,a;switch(s){case"point":r=new C,r.setColor(t),r.setSize(null!==i?i:e.size),a=new P,a.setColor(e.outline.color),a.setWidth(e.outline.width),r.setOutline(a);break;case"line":r=new P,r.setColor(t),r.setWidth(null!==i?i:e.width);break;case"polygon":r=new O,r.setColor(t),a=new P,a.setColor(e.outline.color),a.setWidth(e.outline.width),r.setOutline(a)}return r}var H=t([y,_,v,r],{declaredClass:"esri.dijit.Search",templateString:p,reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,constructor:function(t,i){this.css={searchGroup:"searchGroup",searchInput:"searchInput",searchInputGroup:"searchInputGroup",searchBtn:"searchBtn",searchSubmit:"searchSubmit",searchIcon:"searchIcon esri-icon-search",searchButtonText:"searchButtonText",searchToggle:"searchToggle",searchToggleIcon:"searchIcon esri-icon-down-arrow",searchMenu:"searchMenu",searchMenuHeader:"menuHeader",searchClear:"searchClear",searchClearIcon:"searchIcon esri-icon-close searchClose",searchSpinner:"searchIcon esri-icon-loading-indicator searchSpinner",searchSourceName:"sourceName",suggestionsMenu:"suggestionsMenu",sourcesMenu:"sourcesMenu",activeSource:"active",hasValue:"hasValue",hasButtonMode:"hasButtonMode",hasMultipleSources:"hasMultipleSources",showSuggestions:"showSuggestions",showSources:"showSources",showNoResults:"showNoResults",searchLoading:"searchLoading",latLonHeader:"searchLatLongHeader",searchMoreResults:"moreResults",searchMoreResultsList:"resultsList",searchMoreResultsHeader:"moreHeader",searchMoreResultsItem:"moreItem",searchMoreResultsListHeader:"popupHeader",searchShowMoreResults:"showMoreResults",searchNoResultsMenu:"noResultsMenu",searchNoResultsBody:"noResultsBody",searchNoResultsHeader:"noResultsHeader",searchNoValueIcon:"noValueIcon esri-icon-notice-triangle",searchNoValueText:"noValueText",searchNoResultsText:"noResultsText",searchExpandContainer:"searchExpandContainer",searchAnimateContainer:"searchAnimate",searchExpanded:"searchExpanded",searchCollapsed:"searchCollapsed",searchClearFloat:"searchClearFloat"},this._allIndex="all",this._objectIdIdentifier="_objectId",this._deferreds=[],this.defaultSource={locator:new k("//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"),singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],name:m.widgets.Search.main.esriLocatorName,localSearchOptions:{minScale:3e5,distance:5e4},placeholder:m.widgets.Search.main.placeholder,highlightSymbol:new L(e.toUrl("./Search/images/search-pointer.png"),36,36).setOffset(9,18)},this.options={map:null,theme:"arcgisSearch",visible:!0,value:"",allPlaceholder:"",sources:[this.defaultSource],activeSourceIndex:0,suggestionDelay:150,enableSourcesMenu:!0,enableSuggestionsMenu:!0,enableInfoWindow:!0,showInfoWindowOnSelect:!0,enableSuggestions:!0,enableButtonMode:!1,autoNavigate:!0,autoSelect:!0,addLayersFromMap:!1,zoomScale:1e3,graphicsLayer:null,enableHighlight:!0,highlightGraphic:null,enableLabel:!1,labelSymbol:(new F).setColor(new B([181,56,46,.9])).setFont(new E("14px",E.STYLE_NORMAL,E.VARIANT_NORMAL,E.WEIGHT_BOLD,"Arial")),labelGraphic:null,infoTemplate:new b(m.widgets.Search.main.searchResult,'<div class="${searchTheme}"><div id="${searchMoreResultsId}" class="${searchMoreResults}"><div class="${searchMoreResultsItem}">${searchResult}</div><div>${searchMoreResultsHtml}</div></div></div>'),searchResults:null,suggestResults:null,selectedResult:null,magicKey:null,expanded:!1,maxLength:128,maxResults:6,maxSuggestions:6,locationToAddressDistance:1500,minCharacters:1,enableSearchingAll:!0};var r=s.mixin({},this.options,t);this.set(r),this._updateActiveSource(),this._i18n=m,this._defaultSR=new N(4326),this.domNode=i},startup:function(){this.inherited(arguments),this.sources||(this.sources=[]),this._mapLoaded().then(s.hitch(this,this._init))},postCreate:function(){var e=this;this.inherited(arguments),this._moreResultsId=this.id+"_more_results",this.own(n(this.submitNode,S,s.hitch(this,this._searchButton))),this.own(n(this.sourcesBtnNode,S,s.hitch(this,this._toggleSourcesMenu))),this.own(n(this.inputNode,S,s.hitch(this,this._inputClick))),this.own(n(this.clearNode,S,s.hitch(this,this._clearButton))),this.own(n(this.formNode,"submit",s.hitch(this,function(e){e.preventDefault(),this._cancelSuggest(),this.search()}))),this.own(n(this.inputNode,"keyup",s.hitch(this,function(e){this._inputKey(e)}))),this.own(n(this.sourcesBtnNode,"keyup",s.hitch(this,function(e){this._sourceBtnKey(e)}))),this.own(n(this.suggestionsNode,"li:click, li:keyup",function(t){e._suggestionsEvent(t,this)})),this.own(n(this.sourcesNode,"li:click, li:keyup",function(t){e._sourcesEvent(t,this)})),this.own(n(this.inputNode,"input, paste",s.hitch(this,function(){this._suggestDelay()}))),this.map&&this.map.infoWindow&&this.map.infoWindow.domNode&&this.enableInfoWindow&&(this.own(n(this.map.infoWindow.domNode,"#"+this._moreResultsId+"_show:click",s.hitch(this,function(e){this._showMoreResultsClick(e)}))),this.own(n(this.map.infoWindow.domNode,"#"+this._moreResultsId+"_list li a:click",s.hitch(this,function(e){this._moreResultsClick(e)}))),this.own(n(this.map.infoWindow.domNode,"#"+this._moreResultsId+" [data-switch-coordinates]:click",s.hitch(this,function(e){this._switchCoordinatesClick(e)})))),this.value&&this._checkStatus(),this._hideMenus(),this._updateVisible(),this._insertSources(this.sources),this._setPlaceholder(this.activeSourceIndex),this._updateButtonMode(this.enableButtonMode),this.toggle(this.expanded)},destroy:function(){this.clear(),f.empty(this.domNode),this.inherited(arguments)},clear:function(){this.clearGraphics(),l.get(this.inputNode,"value")&&l.set(this.inputNode,"value",""),this._changeAttrValue("value",""),this.set("searchResults",null),this.set("suggestResults",null),this.set("selectedResult",null),this.set("magicKey",null),d.remove(this.containerNode,this.css.hasValue),l.set(this.clearNode,"title",""),this._hideMenus(),this._closePopup(),this._hideLoading(),this.emit("clear-search")},show:function(){g.set(this.domNode,"display","block")},hide:function(){g.set(this.domNode,"display","none")},expand:function(){this.enableButtonMode&&(d.add(this.containerNode,this.css.searchExpanded),d.remove(this.containerNode,this.css.searchCollapsed),this._hideMenus(),this.set("expanded",!0))},collapse:function(){this.enableButtonMode&&(d.remove(this.containerNode,this.css.searchExpanded),d.add(this.containerNode,this.css.searchCollapsed),this._hideMenus(),this.set("expanded",!1))},toggle:function(e){this.enableButtonMode&&("undefined"==typeof e&&(e=!this.expanded),e?this.expand():this.collapse())},search:function(e){var t=new a;return this._mapLoaded().then(s.hitch(this,function(){this._searchDeferred(e).then(s.hitch(this,function(e){var s=e.results;this.set("searchResults",s),0===e.numResults&&(this._noResults(e.value),this._showNoResultsMenu()),this._hideLoading(),this.emit("search-results",e),this._selectFirstResult(s,e.activeSourceIndex),t.resolve(s)}),s.hitch(this,function(e){t.reject(e)}))})),t.promise},suggest:function(e){var t=new a;return this._mapLoaded().then(s.hitch(this,function(){this._suggestDeferred(e).then(s.hitch(this,function(e){if(e){var s=e.results;this.set("suggestResults",s),this._insertSuggestions(s,e.value),this.emit("suggest-results",e),t.resolve(s)}}),s.hitch(this,function(e){t.reject(e)}))})),t.promise},select:function(e){var t,i=this._getDefaultSymbol(e),r=this.labelSymbol,a=this.sources,o=this.activeSourceIndex,n=this.enableHighlight,h=this.enableLabel,c=this.autoNavigate,u=this.showInfoWindowOnSelect,l=this.enableInfoWindow,d=this.infoTemplate,g=new M(e.feature.toJson());if(o===this._allIndex){var f=this._getSourceIndexOfResult(e);null!==f&&(t=a[f],o=f)}else t=a[o];if(t&&(t.hasOwnProperty("highlightSymbol")&&(i=t.highlightSymbol),t.hasOwnProperty("labelSymbol")&&(r=t.labelSymbol),t.hasOwnProperty("enableHighlight")&&(n=t.enableHighlight),t.hasOwnProperty("enableLabel")&&(h=t.enableLabel),t.hasOwnProperty("autoNavigate")&&(c=t.autoNavigate),t.hasOwnProperty("showInfoWindowOnSelect")&&(u=t.showInfoWindowOnSelect),t.hasOwnProperty("enableInfoWindow")&&(l=t.enableInfoWindow),t.hasOwnProperty("infoTemplate")?d=t.infoTemplate:t.featureLayer&&t.featureLayer.infoTemplate&&(d=t.featureLayer.infoTemplate)),this._hideMenus(),this._hideLoading(),g){var m=this.highlightGraphic,p=this.graphicsLayer,y=this.labelGraphic,_=s.mixin({},g.attributes,{searchTheme:this.theme,searchResult:this._searchResultHTML(e),searchMoreResults:this.css.searchMoreResults,searchMoreResultsItem:this.css.searchMoreResultsItem,searchMoreResultsId:this._moreResultsId,searchMoreResultsHtml:this._moreResultsHTML(e)}),v=null;if(l&&(v=d),y?(y.setGeometry(g.geometry),y.setAttributes(_),y.setSymbol(r)):(y=new M(g.geometry,r,_),h&&(p?p.add(y):this.map&&this.map.graphics&&this.map.graphics.add(y))),y&&y.symbol&&"textsymbol"===y.symbol.type&&y.symbol.setText(e.name),m?(m.setGeometry(g.geometry),m.setAttributes(_),m.setInfoTemplate(v),m.setSymbol(i)):(m=new M(g.geometry,i,_,v),n&&(p?p.add(m):this.map&&this.map.graphics&&this.map.graphics.add(m))),m&&m.symbol&&"textsymbol"===m.symbol.type&&m.symbol.setText(e.name),this.map&&this.map.infoWindow&&l&&u){this.map.infoWindow.setFeatures([m]);var S=this._getPointFromGeometry(m.geometry);this.map.infoWindow.show(S)}this.map&&c&&e&&e.hasOwnProperty("extent")&&"function"==typeof this.map.setExtent&&this.map.setExtent(e.extent),this.set("highlightGraphic",m),this.set("labelGraphic",y)}this.set("selectedResult",e),this.emit("select-result",{result:e,source:t,sourceIndex:o})},focus:function(){x.focus(this.inputNode)},blur:function(){x.curNode&&x.curNode.blur()},clearGraphics:function(){var e=this.highlightGraphic,t=this.graphicsLayer,s=this.labelGraphic;e&&(t?t.remove(e):this.map&&this.map.graphics&&this.map.graphics.remove(e)),s&&(t?t.remove(s):this.map&&this.map.graphics&&this.map.graphics.remove(s)),this.set("labelGraphic",null),this.set("highlightGraphic",null)},_mapLoaded:function(){var e=new a;return this.map?this.map.loaded?e.resolve():n.once(this.map,"load",s.hitch(this,function(){e.resolve()})):e.resolve(),e.promise},_init:function(){this._getMapLayers().then(s.hitch(this,function(){this.set("loaded",!0),this.emit("load")}))},_clearButton:function(){this.clear(),x.focus(this.inputNode)},_error:function(e){return new Error(this.declaredClass+" "+e)},_searchDeferred:function(e){var t,i=new a,r=this.value,o=this.activeSourceIndex;e&&e.hasOwnProperty("index")&&(o=e.index),this._showLoading(),this._hideMenus(),this._closePopup(),this.clearGraphics();var n={magicKey:this.magicKey,text:r};return e?"string"==typeof e?(n.text=e,t=this._searchQueries(n)):t=this._searchQueries("object"==typeof e&&e.hasOwnProperty("magicKey")?e:"object"==typeof e&&e.hasOwnProperty("geometry")?{geometry:e}:"object"==typeof e&&e.hasOwnProperty(this._objectIdIdentifier)?e:"object"==typeof e&&"point"===e.type?{point:e}:e instanceof Array&&2===e.length?{latlon:e}:n):t=this._searchQueries(n),t.always(s.hitch(this,function(e){var t=this._formatResults(e,o,r);i.resolve(t)})),i.promise},_suggestDeferred:function(e){var t,i=new a;this._deferreds.push(i),e||(e=this.value);var r=this.activeSourceIndex;return t=this._suggestQueries({text:e}),t.always(s.hitch(this,function(t){var s;if(t)for(var a=0;a<t.length;a++)t[a]&&(s=!0);if(s){var o=this._formatResults(t,r,e);i.resolve(o)}else i.resolve()})),i.promise},_getDefaultSymbol:function(e){var t,s,i,r,a;return this.map&&(a=this.map.getBasemap()),a||(a="topo"),e&&e.feature&&e.feature.geometry&&(r=e.feature.geometry.type),r&&(s=W.getSchemes({theme:"default",basemap:a,geometryType:r}),s&&(i=s.primaryScheme),i&&(i.color&&i.hasOwnProperty("opacity")&&(i.color.a=i.opacity),t=G(i,i.color,r,i.size))),t},_selectFirstResult:function(e,t){if(this.autoSelect&&e){var s;t===this._allIndex?s=this._getFirstResult(e):e[t]&&e[t][0]&&(s=e[t][0]),s&&this.select(s)}},_getSourceIndexOfResult:function(e){var t=this.searchResults;if(t)for(var s in t)if(t[s]&&t[s].length)for(var i=0;i<t[s].length;i++)if(t[s][i]===e)return parseInt(s,10);return null},_getFirstResult:function(e){if(e)for(var t in e)if(e[t]&&e[t][0])return e[t][0];return!1},_onFocus:function(){this.map&&"function"==typeof this.map.disableKeyboardNavigation&&this.map.disableKeyboardNavigation(),this.emit("focus"),this.inherited(arguments)},_onBlur:function(){this._hideMenus(),this.map&&"function"==typeof this.map.enableKeyboardNavigation&&this.map.enableKeyboardNavigation(),this.enableButtonMode&&this.loaded&&this.collapse(),this.emit("blur"),this.inherited(arguments)},_getMapLayers:function(){var e=new a;if(this.addLayersFromMap&&this.map){var t=[],i=this.map.graphicsLayerIds;if(i&&i.length){for(var r=0;r<i.length;r++){var o=this.map.getLayer(i[r]);o&&t.push(this._featureLayerLoaded(o))}I(t).always(s.hitch(this,function(t){for(var s,i=t,r=this.sources,a=0;a<i.length;a++)i[a]&&i[a].loaded&&"Feature Layer"===i[a].type&&(r.push({featureLayer:i[a],enableSuggestions:!0}),s=!0);s&&this.set("sources",r),e.resolve()}))}else e.resolve()}else e.resolve();return e.promise},_switchCoordinatesClick:function(e){e.preventDefault();var t=e.target,s=l.get(t,"data-switch-coordinates");s&&(this._cancelSuggest(),this.set("value",s),this.search())},_moreResultsClick:function(e){e.preventDefault();var t=e.target,s=parseInt(l.get(t,"data-source-index"),10),i=parseInt(l.get(t,"data-index"),10),r=this.searchResults;if(r&&r[s]){var a=r[s][i];a&&this.select(a)}},_showMoreResultsClick:function(e){e.preventDefault();var t=u.byId(this._moreResultsId);if(t){d.toggle(t,this.css.searchShowMoreResults);var s=u.byId(this._moreResultsId+"_show");s&&(d.contains(t,this.css.searchShowMoreResults)?l.set(s,"textContent",m.widgets.Search.main.hideMoreResults):l.set(s,"textContent",m.widgets.Search.main.showMoreResults))}},_featureLayerLoaded:function(e){var t=new a;if(e.loaded)t.resolve(e);else if(e.loadError)t.reject(this._error("Layer failed to load."));else{var i,r;i=n.once(e,"load",s.hitch(this,function(){r.remove(),t.resolve(e)})),r=n.once(e,"error",s.hitch(this,function(){i.remove(),t.reject(this._error("Layer could not be loaded."))}))}return t.promise},_getObjectSize:function(e){var t,s=0;for(t in e)e.hasOwnProperty(t)&&s++;return s},_sourcesEvent:function(e,t){var s=l.get(t,"data-index"),r=h("li",this.sourcesNode),a=i.indexOf(r,t);s!==this._allIndex&&(s=parseInt(s,10));var n;"click"===e.type||e.keyCode===o.ENTER?(this.set("activeSourceIndex",s),x.focus(this.inputNode),this._hideSourcesMenu()):e.keyCode===o.UP_ARROW?(e.stopPropagation(),e.preventDefault(),n=a-1,x.focus(0>n?this.sourcesBtnNode:r[n])):e.keyCode===o.DOWN_ARROW?(e.stopPropagation(),e.preventDefault(),n=a+1,x.focus(n>=r.length?this.sourcesBtnNode:r[n])):e.keyCode===o.ESCAPE&&(this._hideSourcesMenu(),x.focus(this.inputNode))},_suggestionsEvent:function(e,t){var s=l.get(t,"data-source-index"),r=parseInt(l.get(t,"data-index"),10),a=h("li",this.suggestionsNode),n=this.sources,c=i.indexOf(a,t);s!==this._allIndex&&(s=parseInt(s,10));var u;if(this._clearQueryTimeout(),"click"===e.type||e.keyCode===o.ENTER){var d,g=this.suggestResults;if(g&&g[s]&&g[s][r]&&(d=g[s][r]),d){if(d.index=s,n[s].featureLayer){var f=n[s].featureLayer.objectIdField;d[this._objectIdIdentifier]=d.feature.attributes[f]}else d.magicKey&&d.text&&(this.set("value",d.text),this.set("magicKey",d.magicKey));this.search(d),x.focus(this.inputNode)}}else e.keyCode===o.BACKSPACE||e.keyCode===o.DELETE?x.focus(this.inputNode):e.keyCode===o.UP_ARROW?(e.stopPropagation(),e.preventDefault(),u=c-1,x.focus(0>u?this.inputNode:a[u])):e.keyCode===o.DOWN_ARROW?(e.stopPropagation(),e.preventDefault(),u=c+1,x.focus(u>=a.length?this.inputNode:a[u])):e.keyCode===o.ESCAPE&&(this._hideMenus(),x.focus(this.inputNode))},_getResultName:function(e){var t;return e.hasOwnProperty("name")&&null!==e.name&&(t=e.name.toString()),t||(t=m.widgets.Search.main.untitledResult),t},_getSuggestionName:function(e){var t,s;return e.hasOwnProperty("name")&&(s=e.name.toString()),t=e.text||s,t||(t=m.widgets.Search.main.untitledResult),t},_searchResultHTML:function(e){var t="";if(e.feature&&e.feature.attributes&&e.feature.attributes.Addr_type&&"LatLong"===e.feature.attributes.Addr_type){var s,i,r=e.name.split(" ");if(2===r.length&&(s=r[0],i=r[1]),i&&s){var a=parseFloat(s),o=parseFloat(i),n=a+", "+o,h=o+", "+a;t+='<div class="'+this.css.searchMoreResultsItem+'">',t+='<div class="'+this.css.latLonHeader+'">'+m.widgets.Search.main.lonlat+"</div>",t+=n,t+="</div>",t+='<div class="'+this.css.searchMoreResultsItem+'">',a===o||a>90||-90>a||o>180||-180>o||(t+='<div class="'+this.css.latLonHeader+'">'+m.widgets.Search.main.reverseLonLatHeader+"</div>",t+='<a data-switch-coordinates="'+h+'" tabindex="0" href="#">'+h+"</a>",t+="</div>")}else t=e.name}else t=e.name;return t},_moreResultsHTML:function(e){var t="",s="",i=this.searchResults,r=this.sources,a=0;if(i){s+='<div class="'+this.css.searchMoreResultsItem+'">',s+='<a href="#" id="'+this._moreResultsId+'_show">'+m.widgets.Search.main.showMoreResults+"</a>",s+="</div>",s+='<div class="'+this.css.searchMoreResultsList+'">',s+='<div id="'+this._moreResultsId+'_list">';for(var o in i)if(i[o]){var n=i[o].length;if(n){var h=1===n&&i[o][0]===e;if(this._getObjectSize(i)>1&&!h){var c=this._getSourceName(o);s+='<div class="'+this.css.searchMoreResultsListHeader+'">'+c+"</div>"}if(n&&!h){s+="<ul>";var u,l=r[o].maxResults||this.maxResults;for(u=0;n>u&&l>u;++u)if(i[o][u]!==e){var d=this._getResultName(i[o][u]);s+='<li><a tabindex="0" data-index="'+u+'" data-source-index="'+o+'" href="#">'+d+"</a></li>",a++}s+="</ul>"}}}s+="</div>",s+="</div>"}return a&&(t+=s),t},_validField:function(e,t){return e.getField(t)},_validFields:function(e,t){if(e&&t&&t.length){for(var s=0;s<t.length;s++){var i=this._validField(e,t[s]);if(!i)return!1}return!0}return!1},_getCodedName:function(e,t){if(e&&e.length)for(var s=0,i=e.length;i>s;s++){var r=e[s];if(r.code===t)return r.name}},_getCodedValue:function(e,t,s){if(e&&e.length)for(var i=0,r=e.length;r>i;i++){var a=e[i],o=a.name,n=t;if(s||(o=o.toLowerCase(),n=n.toLowerCase()),o===n)return a.code}return!1},_whereClause:function(e,t,s,i){var r=null;if(e){var a="";if(this.reHostedFS.test(t.url)&&this._containsNonLatinCharacter(e)&&(a="N"),s&&s.length)for(var o=0,n=s.length;n>o;o++){var h="",c=e.replace(/\'/g,"''"),u=s[o],l=t.getField(u),d=t.getDomain(u);if(d&&"codedValue"===d.type&&(c=this._getCodedValue(d.codedValues,c,i)),c!==!1){var g=l.type;if("esriFieldTypeString"===g||"esriFieldTypeDate"===g)h=i?u+" = "+a+"'"+c+"'":"UPPER("+u+") LIKE "+a+"'%"+c.toUpperCase()+"%'";else if("esriFieldTypeSmallInteger"===g||"esriFieldTypeInteger"===g||"esriFieldTypeSingle"===g||"esriFieldTypeDouble"===g){var f=parseFloat(c);h=isNaN(f)?!1:u+" = "+f}else h=u+" = "+c;h&&(r?r+=" or ":r="",r+=h)}}}return r},_suggest:function(e){e||(e={index:this.activeSourceIndex,text:this.value});var t=new a,r=this.sources,o=e.index,n=r[o],h=this.enableSuggestions;n.hasOwnProperty("enableSuggestions")&&(h=n.enableSuggestions);var c,u=0;e.hasOwnProperty("text")&&e.text&&(c=s.trim(e.text),u=e.text.length);var l=n.minCharacters||this.minCharacters;if(h&&c&&u>=l&&this._supportsPagination(n)){var d="";n.prefix&&(d+=n.prefix),d+=c,n.suffix&&(d+=n.suffix);var g=this._defaultSR;this.map&&(g=this.map.spatialReference);var f={};if(n.locator){if(n.categories&&(f.categories=n.categories),n.locator.outSpatialReference=g,this.map&&n.localSearchOptions&&n.localSearchOptions.hasOwnProperty("distance")&&n.localSearchOptions.hasOwnProperty("minScale")){var m=this._getScale();(!n.localSearchOptions.minScale||m&&m<=parseFloat(n.localSearchOptions.minScale))&&(f.location=this.map.extent.getCenter(),f.distance=n.localSearchOptions.distance)}f.text=d,n.useMapExtent&&this.map&&this.map.extent&&(f.searchExtent=this.map.extent),n.searchExtent&&(f.searchExtent=n.searchExtent),f.maxSuggestions=n.maxSuggestions||this.maxSuggestions,n.sourceCountry&&(f.countryCode=n.sourceCountry),n.countryCode&&(f.countryCode=n.countryCode),n.locator.suggestLocations(f).then(s.hitch(this,function(e){t.resolve(e)}),s.hitch(this,function(e){e||(e=this._error("Locator suggestLocations could not be performed.")),t.reject(e)}))}else n.featureLayer?this._featureLayerLoaded(n.featureLayer).then(s.hitch(this,function(){var e=this._getDisplayField(n),r=n.searchFields||[e],a=[];n.suggestionTemplate?n.suggestionTemplate.replace(/(?:\$\{([^}]+)\})/g,function(){var e=arguments[1];a.push(e)}):a=[e];var h=i.indexOf(a,n.featureLayer.objectIdField);-1===h&&a.push(n.featureLayer.objectIdField);var c=this._validField(n.featureLayer,e),u=this._validFields(n.featureLayer,a),l=this._validFields(n.featureLayer,r);if(c&&u&&l){var f=new D;n.hasOwnProperty("suggestQueryParams")&&s.mixin(f,n.suggestQueryParams),f.outSpatialReference=g,f.returnGeometry=!1,f.num=n.maxSuggestions||this.maxSuggestions,f.outFields=a,n.useMapExtent&&this.map&&this.map.extent&&(f.geometry=this.map.extent),n.searchExtent&&(f.geometry=n.searchExtent);var m,p=this._whereClause(d,n.featureLayer,r,!1);p&&(f.where=p,m=!0),m?n.featureLayer.queryFeatures(f,s.hitch(this,function(e){var s,i=e.features;i&&(s=this._hydrateResults(i,o,!0)),t.resolve(s)}),s.hitch(this,function(e){e||(e=this._error("FeatureLayer queryFeatures errored with suggestions")),t.reject(e)})):t.resolve()}else t.reject(this._error("Invalid FeatureLayer field"))})):t.reject(this._error("Invalid source"))}else t.resolve();return t.promise},_supportsPagination:function(e){var t;return e.locator?t=!0:e.featureLayer&&e.featureLayer.advancedQueryCapabilities&&e.featureLayer.advancedQueryCapabilities.supportsPagination&&(t=!0),t},_suggestQueries:function(e){var t,s=this.sources,i=this.activeSourceIndex,r=[];if(i===this._allIndex)for(var a=0;a<s.length;a++){var o=e;o.index=a,t=this._suggest(o),r.push(t)}else{var n=e;n.index=i,t=this._suggest(n),r.push(t)}return I(r)},_getPointFromGeometry:function(e){var t;switch(e.type){case"extent":t=e.getCenter();break;case"multipoint":t=e.getExtent().getCenter();break;case"point":t=e;break;case"polygon":t=e.getExtent().getCenter();break;case"polyline":t=e.getExtent().getCenter()}return t},_searchQueries:function(e){e.hasOwnProperty("index")||(e.index=this.activeSourceIndex);var t,s=[];if(e.index===this._allIndex)for(var i=this.sources,r=0;r<i.length;r++){var a=e;a.index=r,t=this._search(a),s.push(t)}else{var o=this._search(e);s.push(o)}return I(s)},_searchButton:function(){this.enableButtonMode&&!this.expanded?(this.expand(),x.focus(this.inputNode)):(this._cancelSuggest(),this.search())},_search:function(e){e||(e={text:this.value,magicKey:null,geometry:null,point:null,index:this.activeSourceIndex,latlon:null});var t,i,r=new a,o=e.index,n=this.sources[o];if(e.hasOwnProperty("text")&&e.text&&(i=s.trim(e.text)),n){var h="";n.prefix&&!e.magicKey&&(h+=n.prefix),h+=i,n.suffix&&!e.magicKey&&(h+=n.suffix);var c=this._defaultSR;if(this.map&&(c=this.map.spatialReference),n.locator)if(e.hasOwnProperty("text")&&i){var u={};if(n.categories&&(u.categories=n.categories),c&&(n.locator.outSpatialReference=c),this.map&&n.localSearchOptions&&n.localSearchOptions.hasOwnProperty("distance")&&n.localSearchOptions.hasOwnProperty("minScale")){var l=this._getScale();(!n.localSearchOptions.minScale||l&&l<=parseFloat(n.localSearchOptions.minScale))&&(u.location=this.map.extent.getCenter(),u.distance=n.localSearchOptions.distance)}u.address={},u.maxLocations=n.maxResults||this.maxResults,n.useMapExtent&&this.map&&this.map.extent&&(u.searchExtent=this.map.extent),n.searchExtent&&(u.searchExtent=n.searchExtent),n.sourceCountry&&(u.countryCode=n.sourceCountry),n.countryCode&&(u.countryCode=n.countryCode),e.magicKey&&(u.magicKey=e.magicKey),n.singleLineFieldName?u.address[n.singleLineFieldName]=h:u.address["Single Line Input"]=h,n.outFields&&(u.outFields=n.outFields),n.locator.addressToLocations(u).then(s.hitch(this,function(e){var t=this._hydrateResults(e,o,!1);r.resolve(t)}),s.hitch(this,function(e){e||(e=this._error("Locator addressToLocations could not be performed")),r.reject(e)}))}else if(e.geometry)t=this._getPointFromGeometry(e.geometry.geometry),t?this._reverseGeocodePoint(o,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}):r.reject(this._error("Invalid point to reverse geocode"));else if(e.point)this._reverseGeocodePoint(o,e.point).then(function(e){r.resolve(e)},function(e){r.reject(e)});else if(e.latlon){var d=new T(e.latlon,this._defaultSR);this._reverseGeocodePoint(o,d).then(function(e){r.resolve(e)},function(e){r.reject(e)})}else e.hasOwnProperty("text")&&!i?r.resolve([]):r.reject(this._error("Invalid query type for Locator"));else n.featureLayer?this._featureLayerLoaded(n.featureLayer).then(s.hitch(this,function(){var a=this._getDisplayField(n),u=n.searchFields||[a],l=this._validField(n.featureLayer,a),d=this._validFields(n.featureLayer,u);if(l&&d){var g=new D;if(n.hasOwnProperty("searchQueryParams")&&s.mixin(g,n.searchQueryParams),c){g.outSpatialReference=c;var f=j.getUnitValueForSR(c);f&&(g.maxAllowableOffset=f)}g.returnGeometry=!0,n.outFields&&(g.outFields=n.outFields);var m;e.hasOwnProperty(this._objectIdIdentifier)||(this._supportsPagination(n)&&(g.num=n.maxResults||this.maxResults),n.useMapExtent&&this.map&&this.map.extent&&(g.geometry=this.map.extent),n.searchExtent&&(g.geometry=n.searchExtent),m=n.exactMatch);var p;if(e.hasOwnProperty("text")&&i){var y=this._whereClause(h,n.featureLayer,u,m);y?(g.where=y,p=!0):p=!1}else e.hasOwnProperty(this._objectIdIdentifier)?(g.objectIds=[e[this._objectIdIdentifier]],p=!0):e.geometry?(g.geometry=e.geometry,p=!0):e.point?(g.geometry=e.point,p=!0):e.latlon?(t=new T(e.latlon,this._defaultSR),g.geometry=t,p=!0):e.hasOwnProperty("text")&&!i?(r.resolve([]),p=!1):(r.reject(this._error("Invalid query type for FeatureLayer")),p=!1);p?n.featureLayer.queryFeatures(g,s.hitch(this,function(e){var t,s=e.features;s&&(t=this._hydrateResults(s,o,!1)),r.resolve(t)}),s.hitch(this,function(e){e||(e=this._error("FeatureLayer queryFeatures could not be performed")),r.reject(e)})):r.resolve()}else r.reject(this._error("Invalid FeatureLayer field"))})):r.reject(this._error("Invalid source"))}else r.reject(this._error("Source is undefined"));return r.promise},_clearQueryTimeout:function(){this._queryTimer&&clearTimeout(this._queryTimer)},_formatResults:function(e,t,s){var i={activeSourceIndex:t,value:s,numResults:0,numErrors:0,errors:null,results:null},r={},a={};if(e)if(t===this._allIndex)for(var o=0;o<e.length;o++)e[o]&&(e[o]instanceof Error?(r[o]=e[o],i.numErrors++):(a[o]=e[o],i.numResults+=e[o].length));else e[0]&&(e[0]instanceof Error?(r[t]=e[0],i.numErrors++):(a[t]=e[0],i.numResults+=e[0].length));return i.numErrors&&(i.errors=r),i.numResults&&(i.results=a),i},_reverseGeocodePoint:function(e,t){var i=new a,r=this.sources,o=r[e];if(t&&o){var n=o.locationToAddressDistance||this.locationToAddressDistance;o.locator.outSpatialReference=this._defaultSR,this.map&&(o.locator.outSpatialReference=this.map.spatialReference),o.locator.locationToAddress(t,n,s.hitch(this,function(t){var s=this._hydrateResults([t],e,!1);i.resolve(s)}),s.hitch(this,function(e){e||(e=this._error("Locator locationToAddress could not be performed")),i.reject(e)}))}else i.reject(this._error("No point or source defined for reverse geocoding"));return i.promise},_cancelDeferreds:function(){if(this._deferreds&&this._deferreds.length)for(var e=0;e<this._deferreds.length;e++)this._deferreds[e].cancel(this.declaredClass+" cancelling request");this._deferreds=[]},_sourceBtnKey:function(e){if(e){var t=h("li",this.sourcesNode);if(e.keyCode===o.UP_ARROW){e.stopPropagation(),e.preventDefault(),this._showSourcesMenu();var s=t.length;s&&x.focus(t[s-1])}else e.keyCode===o.DOWN_ARROW&&(e.stopPropagation(),e.preventDefault(),this._showSourcesMenu(),t[0]&&x.focus(t[0]))}},_inputKey:function(e){if(e){var t=h("li",this.suggestionsNode),s=this.suggestResults;if(e.keyCode===o.TAB||e.keyCode===o.ESCAPE)this._cancelSuggest(),this._hideMenus();else if(e.keyCode===o.UP_ARROW){e.stopPropagation(),e.preventDefault(),this._cancelSuggest(),s&&this._showSuggestionsMenu();var i=t.length;i&&x.focus(t[i-1])}else if(e.keyCode===o.DOWN_ARROW)e.stopPropagation(),e.preventDefault(),this._cancelSuggest(),s&&this._showSuggestionsMenu(),t[0]&&x.focus(t[0]);else{if(e.ctrlKey||e.metaKey||e.keyCode===o.copyKey||e.keyCode===o.LEFT_ARROW||e.keyCode===o.RIGHT_ARROW||e.keyCode===o.ENTER)return e;this._suggestDelay()}}},_cancelSuggest:function(){this._cancelDeferreds(),this._clearQueryTimeout()},_suggestDelay:function(){this._cancelSuggest(),this._changeValue(),this._queryTimer=setTimeout(s.hitch(this,function(){this.suggest()}),this.suggestionDelay)},_changeValue:function(){this.set("magicKey",null),this._changeAttrValue("value",this.inputNode.value),this._checkStatus()},_inputClick:function(){this._hideSourcesMenu(),this._hideNoResultsMenu()},_getSourceName:function(e){var t=this.sources,s=t[e].name;return!s&&t[e].featureLayer&&(s=t[e].featureLayer.name),s||(s=m.widgets.Search.main.untitledSource),s},_insertSuggestions:function(e,t){if(this.enableSuggestionsMenu&&this.suggestionsNode){this._hideSourcesMenu(),this._hideNoResultsMenu();var s,i=this.sources;if(e){s=f.create("div");for(var r in e)if(e[r]&&e[r].length){var a=this._getSourceName(r);i.length>1&&this.activeSourceIndex===this._allIndex&&f.create("div",{className:this.css.searchMenuHeader,textContent:a},s);for(var o=f.create("ul",{role:"menu"},s),n=i[r].maxSuggestions||this.maxSuggestions,h=0;h<e[r].length&&n>h;++h)for(var c=f.create("li",{"data-index":h,"data-source-index":r,role:"menuitem",tabindex:0},o),u=new RegExp("("+t+")","gi"),l=this._getSuggestionName(e[r][h]),d=l.replace(u,"|$1|"),g=d.split("|"),m=g.length,p=0;m>p;p++){var y=g[p];if(y.toLowerCase()===t.toLowerCase())f.create("strong",{textContent:y},c);else{var _=document.createTextNode(y);f.place(_,c)}}}}s?(f.place(s,this.suggestionsNode,"only"),this._showSuggestionsMenu()):(f.empty(this.suggestionsNode),this._hideSuggestionsMenu())}},_insertSources:function(e){if(this.enableSourcesMenu&&e&&e.length>1){var t,s,i=this.activeSourceIndex,r=f.create("ul",{role:"menu"});if(this.enableSearchingAll){var a="";i===this._allIndex&&(a="active"),f.create("li",{"data-index":this._allIndex,role:"menuitem",className:a,tabIndex:0,textContent:m.widgets.Search.main.all},r)}for(s=0;s<e.length;s++){t="",s===i&&(t=this.css.activeSource);var o=this._getSourceName(s);f.create("li",{"data-index":s,role:"menuitem",className:t,tabIndex:0,textContent:o},r)}d.add(this.containerNode,this.css.hasMultipleSources),f.place(r,this.sourcesNode,"only")}else d.remove(this.containerNode,this.css.hasMultipleSources),f.empty(this.sourcesNode)},_showLoading:function(){d.add(this.containerNode,this.css.searchLoading)},_hideLoading:function(){d.remove(this.containerNode,this.css.searchLoading)},_checkStatus:function(){this.value?(d.add(this.containerNode,this.css.hasValue),l.set(this.clearNode,"title",m.widgets.Search.main.clearButtonTitle)):this.clear()},_closePopup:function(){this.enableInfoWindow&&this.map&&this.map.infoWindow&&this.map.infoWindow.hide()},_noResults:function(e){var t;e&&(t=s.trim(e));var i=f.create("div",{className:this.css.searchNoResultsBody});
if(e&&t)f.create("div",{className:this.css.searchNoResultsHeader,textContent:m.widgets.Search.main.noResults},i),f.create("div",{className:this.css.searchNoResultsText,textContent:w.substitute({value:'"'+e+'"'},m.widgets.Search.main.noResultsFound)},i);else{var r=f.create("div",{},i);f.create("span",{"aria-hidden":"true",className:this.css.searchNoValueIcon},r),f.create("span",{className:this.css.searchNoValueText,textContent:m.widgets.Search.main.emptyValue},r)}f.place(i,this.noResultsMenuNode,"only")},_hideMenus:function(){this._hideSourcesMenu(),this._hideSuggestionsMenu(),this._hideNoResultsMenu()},_hideNoResultsMenu:function(){d.remove(this.containerNode,this.css.showNoResults)},_showNoResultsMenu:function(){this._hideSourcesMenu(),this._hideSuggestionsMenu(),d.add(this.containerNode,this.css.showNoResults)},_hideSourcesMenu:function(){d.remove(this.containerNode,this.css.showSources)},_hideSuggestionsMenu:function(){d.remove(this.containerNode,this.css.showSuggestions)},_showSourcesMenu:function(){this._hideSuggestionsMenu(),this._hideNoResultsMenu(),d.add(this.containerNode,this.css.showSources)},_showSuggestionsMenu:function(){this._hideSourcesMenu(),this._hideNoResultsMenu(),d.add(this.containerNode,this.css.showSuggestions)},_toggleSourcesMenu:function(){this._hideSuggestionsMenu(),this._hideNoResultsMenu(),d.toggle(this.containerNode,this.css.showSources)},_getFirstStringField:function(e){if(e){var t=e.fields;if(t&&t.length)for(var s=0;s<t.length;s++){var i=t[s];if("esriFieldTypeString"===i.type)return i.name}}return""},_getDisplayField:function(e){return e.displayField||e.featureLayer.displayField||this._getFirstStringField(e.featureLayer)},_validExtent:function(e){return e&&e.xmin&&"NaN"!==e.xmin&&e.ymin&&"NaN"!==e.ymin&&e.xmax&&"NaN"!==e.xmax&&e.ymax&&"NaN"!==e.ymax?!0:!1},_hydrateResult:function(e,t,s){var i,r,a={},o=this._defaultSR,n=this.sources,h=n[t];if(this.map&&(o=this.map.spatialReference),e.hasOwnProperty("text")&&e.hasOwnProperty("magicKey"))return e;if(e.hasOwnProperty("geometry")){var c=new M(e.toJson());a.feature=c,r=a.feature.geometry,r&&r.setSpatialReference(o)}else if(e.hasOwnProperty("location")){var u=new T(e.location.x,e.location.y,o);i={},e.hasOwnProperty("attributes")&&(i=e.attributes),e.hasOwnProperty("score")&&(i.score=e.score),a.feature=new M(u,null,i,null)}else a.feature=null;if(e.hasOwnProperty("extent")&&this._validExtent(e.extent))a.extent=new A(e.extent),a.extent.setSpatialReference(o);else if(a.feature&&a.feature.geometry)switch(a.feature.geometry.type){case"extent":a.extent=a.feature.geometry;break;case"multipoint":a.extent=a.feature.geometry.getExtent();break;case"polygon":a.extent=a.feature.geometry.getExtent();break;case"polyline":a.extent=a.feature.geometry.getExtent();break;case"point":if(this.map){var l=this.zoomScale;h&&h.zoomScale&&(l=h.zoomScale),a.extent=this._getScale()>l?j.getExtentForScale(this.map,l).centerAt(a.feature.geometry):this.map.extent.centerAt(a.feature.geometry)}else a.extent=new A({xmin:a.feature.geometry.x-.25,ymin:a.feature.geometry.y-.25,xmax:a.feature.geometry.x+.25,ymax:a.feature.geometry.y+.25,spatialReference:this._defaultSR})}else a.extent=null;if(a.name="",h.featureLayer)if(h.suggestionTemplate&&s)a.name=w.substitute(e.attributes,h.suggestionTemplate);else if(h.searchTemplate)a.name=w.substitute(e.attributes,h.searchTemplate);else{var d=this._getDisplayField(h),g=h.featureLayer.getDomain(d);if(d&&e.hasOwnProperty("attributes")&&e.attributes.hasOwnProperty(d)){var f=e.attributes[d];a.name=g&&"codedValue"===g.type?this._getCodedName(g.codedValues,f):f}}else e.address&&h.searchTemplate?a.name=w.substitute(e.address,h.searchTemplate):e.hasOwnProperty("name")?a.name=e.name:e.hasOwnProperty("attributes")&&"object"==typeof e.attributes&&e.attributes.Match_addr?(a.name=e.attributes.Match_addr,e.attributes.Addr_type&&"POI"===e.attributes.Addr_type&&e.attributes.StAddr&&e.attributes.City&&(a.name+=" - "+e.attributes.StAddr+", "+e.attributes.City)):e.hasOwnProperty("address")&&"string"==typeof e.address?a.name=e.address:e.hasOwnProperty("address")&&"object"==typeof e.address&&e.address.hasOwnProperty("Address")?a.name=e.address.Address:a.feature&&a.feature.geometry&&(a.name=a.feature.geometry.x+","+a.feature.geometry.y);return a},_getScale:function(){var e;return this.map&&"function"==typeof this.map.getScale&&(e=this.map.getScale()),e},_hydrateResults:function(e,t,s){var i=[],r=0;if(e&&e.length)for(r;r<e.length;r++){var a=this._hydrateResult(e[r],t,s);i.push(a)}return i},_containsNonLatinCharacter:function(e){for(var t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1},_setPlaceholder:function(e){var t="",s=this.sources,i=s[e];e===this._allIndex?t=this.allPlaceholder||m.widgets.Search.main.allPlaceholder:i&&i.placeholder&&(t=i.placeholder);var r=m.widgets.Search.main.all;i&&(r=this._getSourceName(e)),l.set(this.sourceNameNode,"textContent",r),l.set(this.inputNode,"placeholder",t),l.set(this.inputNode,"title",t)},_updateActiveSource:function(){var e,t=this.sources,s=this.activeSourceIndex;t&&t[s]&&(e=t[s]),e?this.set("activeSource",e):this.set("activeSource",null)},_updateVisible:function(){this.visible?this.show():this.hide()},_updateButtonMode:function(e){e?(d.toggle(this.containerNode,this.css.searchExpanded,this.expanded),d.toggle(this.containerNode,this.css.searchCollapsed,!this.expanded),d.add(this.containerNode,this.css.hasButtonMode)):(d.remove(this.containerNode,this.css.searchExpanded),d.remove(this.containerNode,this.css.searchCollapsed),d.remove(this.containerNode,this.css.hasButtonMode))},_setDefaultActiveSourceIndex:function(){var e=this.sources;e&&1===e.length||!this.enableSearchingAll?this.set("activeSourceIndex",0):this.set("activeSourceIndex",this._allIndex)},_setEnableSourcesMenuAttr:function(e){this._set("enableSourcesMenu",e),this._created&&this._insertSources(this.sources)},_setEnableSearchingAllAttr:function(e){this._set("enableSearchingAll",e),this._created&&(this._setDefaultActiveSourceIndex(),this._hideMenus(),this._insertSources(this.sources))},_setSourcesAttr:function(e){this._set("sources",e),this._created&&(this._setDefaultActiveSourceIndex(),this._hideMenus(),this._insertSources(e))},_setAllPlaceholderAttr:function(e){this._set("allPlaceholder",e),this._created&&this._setPlaceholder(this.activeSourceIndex)},_setActiveSourceIndexAttr:function(e){this._set("activeSourceIndex",e),this._updateActiveSource(),this._created&&(this._setPlaceholder(e),this._hideMenus(),this._insertSources(this.sources))},_setMaxLengthAttr:function(e){this._set("maxLength",e),this._created&&l.set(this.inputNode,"maxLength",e)},_setValueAttr:function(e){this.set("magicKey",null),this._set("value",e),this._created&&(l.set(this.inputNode,"value",e),this._checkStatus())},_setVisibleAttr:function(e){this._set("visible",e),this._created&&this._updateVisible()},_setEnableButtonModeAttr:function(e){this._set("enableButtonMode",e),this._created&&this._updateButtonMode(e)},_setThemeAttr:function(e){this._created&&(d.remove(this.domNode,this.theme),d.add(this.domNode,e)),this._set("theme",e)}});return c("extend-esri")&&s.setObject("dijit.Search",H,R),H});