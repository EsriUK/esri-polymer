// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/on","dojo/json","dijit/form/VerticalSlider","dojox/form/VerticalRangeSlider","dijit/form/VerticalRule","dijit/form/VerticalRuleLabels","dijit/form/HorizontalSlider","dojox/form/HorizontalRangeSlider","dijit/form/HorizontalRule","dijit/form/HorizontalRuleLabels","dijit/_Widget","dijit/_Templated","dojox/timing/_base","dojo/_base/array","dojo/Deferred","dojo/DeferredList","../layers/MosaicRule","../layers/DimensionalDefinition","../kernel","../lang","./_EventedWidget","dojo/text!./templates/MultidimensionalSlider_vertical.html","dojo/text!./templates/MultidimensionalSlider_horizontal.html","dojo/i18n!../nls/jsapi","dojo/dom-class","dojo/dom-style","dojo/dom-geometry"],function(i,e,t,s,n,a,l,o,h,u,r,d,m,c,_,f,g,p,v,V,y,b,R,S,C,D,I,x,L,N){var O={LAYOUT_VERTICAL:"vertical",LAYOUT_HORIZONTAL:"horizontal"},j=i([S,c,_],{declaredClass:"esri.dijit.MultidimensionalSlider",widgetsInTemplate:!0,templateString:C,nLabels:10,_thumbCount:1,useRanges:!1,loop:!0,useLayersDimSlices:!0,prefetch:!0,prefetchedValues:{},showPlayButton:!0,prefetchFactor:2,_hasUnitConflict:!1,_update:!0,playDirectionAscending:!0,unitSymbols:{meter:"m",pascal:"Pa"},_eventMap:{"dimension-value-change":!0,play:!0,pause:!0,next:!0,previous:!0,change:!0,"dimension-array-create":!0},onChange:function(){},onPlay:function(){},onPause:function(){},onDimensionValueChange:function(){},_onPlay:function(){this.playing=!this.playing,this._updateUI(),this.playing?(this._timer.start(),this.onPlay()):(this._timer.stop(),this.onPause())},constructor:function(e){i.safeMixin(this,e),this.playing=!1,this._iconClass="mdsButton mdsPlayButton",this.map&&this._getImageLayers(),this.layout===O.LAYOUT_HORIZONTAL&&(this.templateString=D),this.thumbMovingRate=this.thumbMovingRate||3e3,this._i18n=I,this.prefetchImgNodes={}},postCreate:function(){this.inherited(arguments)},startup:function(){this.inherited(arguments);var i=this;this._getAllLayersMDInfo().then(function(){i._sortDimensionValues(),i.dimensionValues=i.dimensionValues&&i.dimensionValues.length&&!i.useLayersDimValues?i.dimensionValues:i._mapSortedDimensionValues,i.getUnit(),i._setupSlider(!0)}),this.showPlayButton?L.set(this.playPauseBtn.domNode,"display","block"):(L.set(this.playPauseBtn.domNode,"display","none"),this.playPauseBtnRow&&L.set(this.playPauseBtnRow,"display","none")),this._timer=new f.Timer,this._timer.setInterval(this.thumbMovingRate),this._timer.onTick=e.hitch(this,function(){this._bumpSlider(this.playDirectionAscending?1:-1)}),this.layout===O.LAYOUT_VERTICAL&&(this.computeSliderStyle(),this.on("resize",e.hitch(this,"computeSliderStyle")))},increment:function(){var i=1;!this.playDirectionAscending&&this.playing&&(i=-1),this._bumpSlider(i)},decrement:function(){var i=-1;!this.playDirectionAscending&&this.playing&&(i=1),this._bumpSlider(i)},_setDimensionAttr:function(i){var e=R.isDefined(e)?!1:!0;this._slider&&(i.dimension&&(this.dimension=i.dimension),this.dimensionValues=i.dimensionValues&&i.dimensionValues.length?i.dimensionValues:[],this.update(!1))},update:function(i){var e=this;this._mapSortedDimensionValues=[],this._getImageLayers(),this.value=i?this.dimensionValues[this._slider.value]:null,this._getAllLayersMDInfo().then(function(){e._sortDimensionValues(),e.getUnit(),e.dimensionValues&&e.dimensionValues.length&&!e.useLayersDimSlices||(e.dimensionValues=e._mapSortedDimensionValues),e._setupSlider(i)})},pause:function(){this.playing=!1,this._updateUI(),this._timer.stop()},play:function(i){this.playing!==!0&&(i=i?!0:!1,this.playing=!1,this._onPlay())},_setupSlider:function(i){this._destroySlider(),this.dimensionValues&&this.dimensionValues.length&&(this.sliderNode=document.createElement("div"),this._getDimensionAlias(),this._layers&&this._layers.length&&1===this._layers.length&&i&&this._readMosaicRule(),this._createRule(),this._createLabels(),this._createSlider(),this._slider.onChange(this._slider.value))},_createLabels:function(){this.layout===O.LAYOUT_HORIZONTAL?this._createHorizontalLabels():this._createVerticalLabels()},_createRule:function(){this.layout===O.LAYOUT_HORIZONTAL?this._createHorizontalRule():this._createVerticalRule()},_createVerticalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new h({labels:this._filterLabels(),labelStyle:"font-size: 83%; padding-left: 5px;"},this.labelsNode)},_createVerticalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new o({count:this.dimensionValues.length,style:"width:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new m({labels:this._filterLabels(),labelStyle:"font-size: 83%"},this.labelsNode)},_createHorizontalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new d({count:this.dimensionValues.length,style:"height:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalSingleSlider:function(i){i=i?i:this.playDirectionAscending?0:this.dimensionValues.length-1,this._slider=new u({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width: 100%;",increment:e.hitch(this,"increment"),decrement:e.hitch(this,"decrement"),value:i||0,onChange:e.hitch(this,this._onSingleSliderChange),showButtons:this.showPlayButton},this.sliderNode),this._slider.startup()},_createHorizontalRangeSlider:function(i){i=i?i:this.playDirectionAscending?[0,1]:[this.dimensionValues.length-2,this.dimensionValues.length-1],this._slider=new r({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width:100%;",increment:e.hitch(this,"increment"),decrement:e.hitch(this,"decrement"),value:i||[0,1],onChange:e.hitch(this,this._onRangeSliderChange),showButtons:this.showPlayButton},this.sliderNode),this._slider.startup(),s(this._slider.incrementButton,"click",this._slider.increment),s(this._slider.decrementButton,"click",this._slider.decrement),this._slider._typematicCallback=function(){}},_createVerticalSingleSlider:function(i){i=i?i:this.playDirectionAscending?0:this.dimensionValues.length-1,this._slider=new a({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:e.hitch(this,"increment"),decrement:e.hitch(this,"decrement"),value:i||0,onChange:e.hitch(this,this._onSingleSliderChange),showButtons:this.showPlayButton},this.sliderNode),this._slider.startup()},_createVerticalRangeSlider:function(i){i=i?i:this.playDirectionAscending?[0,1]:[this.dimensionValues.length-2,this.dimensionValues.length-1],this._slider=new l({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:e.hitch(this,"increment"),decrement:e.hitch(this,"decrement"),value:i||[0,1],onChange:e.hitch(this,this._onRangeSliderChange),showButtons:this.showPlayButton},this.sliderNode),this._slider.startup(),this._slider._typematicCallback=function(){}},_onSingleSliderChange:function(i){var e=this.dimensionValues[i];this.setDimensionInfoText(e),g.forEach(this._layers,function(t){this._updateMosaicRule(t,e),this.prefetch&&this.playing&&this._prefetchData(i,t)},this),this._oldValue=i,this.value=e,this.onChange(e)},_onRangeSliderChange:function(i){if(this._update){this._snap&&(i=this._snapToNearestRange(i));var t=[this.dimensionValues[i[1]],this.dimensionValues[i[0]]];t.sort(this._sortCompareFunction),this.value=t,this.setDimensionInfoText(t),g.forEach(this._layers,function(e){this._updateMosaicRule(e,t),this.prefetch&&this.playing&&this._prefetchData(i,e)},this),this._update=!0,this._oldValue=e.clone(i),this.onChange(t)}},destroy:function(){this.inherited(arguments),this._timer.stop()},_destroySlider:function(){this._slider&&(this._slider.destroy(),this._slider=null)},_createSlider:function(){var i;this.mdSliderCell.appendChild(this.sliderNode),this.value&&this.value.length?i=g.indexOf(this.dimensionValues,this.value[0])>=0&&g.indexOf(this.dimensionValues,this.value[1])>=0?[g.indexOf(this.dimensionValues,this.value[0]),g.indexOf(this.dimensionValues,this.value[1])]:[0,1]:this.value&&(i=g.indexOf(this.dimensionValues,this.value)>=0?g.indexOf(this.dimensionValues,this.value):0),2===this._thumbCount?this.layout===O.LAYOUT_HORIZONTAL?this._createHorizontalRangeSlider(i):this._createVerticalRangeSlider(i):this.layout===O.LAYOUT_HORIZONTAL?this._createHorizontalSingleSlider(i):this._createVerticalSingleSlider(i)},_getMultidimensionalInfo:function(i){function e(){i.getMultidimensionalInfo().then(function(e){i.multidimensionalInfo=e,t.resolve(i)},function(i){t.reject(i)})}var t=new p;return i.multidimensionalInfo?t.resolve(i):i.loaded?e():i.on("load",function(){e()}),t},_getAllLayersMDInfo:function(){var i=[];g.forEach(this._layers,function(e){i.push(this._getMultidimensionalInfo(e))},this);var e=new v(i);return e},_getImageLayers:function(){var i,e=this.map.layerIds.concat(this.map.graphicsLayerIds);return this._layers=[],g.forEach(e,function(e){i=this.map.getLayer(e),("esri.layers.ArcGISImageServiceLayer"===i.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===i.declaredClass||"esri.layers.RasterLayer"===i.declaredClass)&&this._layers.push(i)},this),this._layers},_sortCompareFunction:function(i,e){return R.isDefined(i)&&R.isDefined(e)?i-e:!1},_getDimensionObjects:function(){function i(i){if(i&&i.values&&i.hasRanges){var e=[];g.forEach(i.values,function(i){i.length?e=t(e.sort(this._sortCompareFunction),i):e.push.apply(t(e.sort(this._sortCompareFunction),[i]))},this),i.decodedValues=e}return i}var t=this._merge;this._allRangeValues=!0,this._thumbCount=1,this._snap=!1,this._dimensionObjects=[],this._layers=this._filterLayers(),g.forEach(this._layers,function(i){i.multidimensionalInfo&&g.some(i.multidimensionalInfo.variables,function(i){g.some(i.dimensions,function(i){return i.name!==this.dimension||i.hasRanges?void 0:void(this._allRangeValues=!1)},this)},this)},this),this.useRanges?(this._thumbCount=2,this._snap=!1):this._allRangeValues&&this.useLayersDimSlices?(this._thumbCount=2,this._snap=!0):this._snap=!1,g.forEach(this._layers,function(t){t.multidimensionalInfo&&g.some(t.multidimensionalInfo.variables,function(t){g.some(t.dimensions,function(t){t.name===this.dimension&&(this._allRangeValues&&t.hasRanges||this.useRanges?this._dimensionObjects.push(i(e.clone(t))):!this._allRangeValues&&t.hasRanges||this._dimensionObjects.push(e.clone(t)))},this)},this)},this)},_merge:function(i,e){for(var t=[],s=0,n=0;s<i.length&&n<e.length;)i[s]<e[n]?t.push(i[s++]):i[s]>e[n]?t.push(e[n++]):(t.push(e[n++]),s++);return t=t.concat(i.slice(s)).concat(e.slice(n)),t=g.filter(t,function(i,e,t){return t.indexOf(i)===e})},_mergeRangeArrays:function(i,e){for(var t=[],s=0,n=0;s<i.length&&n<e.length;)i[s][0]<e[n][0]||i[s][0]===e[n][0]&&i[s][1]<e[n][1]?t.push(i[s++]):i[s][0]>e[n][0]||i[s][0]===e[n][0]&&i[s][1]>e[n][1]?t.push(e[n++]):(t.push(e[n++]),s++);return t=t.concat(i.slice(s)).concat(e.slice(n)),t=g.filter(t,function(i,e,t){return t.indexOf(i)===e},this)},_sortDimensionValues:function(){var i=0,e=this._merge,t=this._mergeRangeArrays;if(this._getDimensionObjects(),this._dimensionObjects.length>=1&&(this._mapSortedDimensionValues=this._dimensionObjects[0].decodedValues||this._dimensionObjects[0].values,this._allRangeValues&&(this._dimensionRangeValues=this._dimensionObjects[0].values)),this._dimensionObjects.length>1)for(i=1;i<this._dimensionObjects.length;i++)this._mapSortedDimensionValues=e(this._mapSortedDimensionValues,this._dimensionObjects[i].decodedValues||this._dimensionObjects[i].values),this._allRangeValues&&(this._dimensionRangeValues=t(this._dimensionRangeValues,this._dimensionObjects[i].values))},_createDimensionalDefinition:function(i,e){var t=[i],s=new y({variableName:e,dimensionName:this.dimension,values:t,isSlice:1===t.length});return s},_updateMosaicRule:function(i,e){var t=!1,s=i.mosaicRule||i.defaultMosaicRule||new V({multidimensionalDefinition:[]}),n=s.multidimensionalDefinition||[];e.length&&e.sort(this._sortCompareFunction),g.forEach(n,function(i){i.dimensionName===this.dimension&&(i.values=[e],i.isSlice=!this.useRanges,t=!0)},this),t||g.some(i.multidimensionalInfo.variables,function(i){return g.some(i.dimensions,function(i){return i.name===this.dimension?!0:void 0},this)?!0:void 0},this)&&(n.push(this._createDimensionalDefinition(e,"")),t=!0),t&&(s.multidimensionalDefinition=n,i.setMosaicRule(s))},_prefetchData:function(i,t){if(t&&t.mosaicRule){var s,a,l,o,h,u=!1,r=this;for(this.prefetchedValues[t.id]||(this.prefetchedValues[t.id]=[]),this.prefetchImgNodes[t.id]=[],a=e.clone(t._params),l=e.clone(t.mosaicRule),s=1;s<=this.prefetchFactor;s++)u=!1,g.forEach(l.multidimensionalDefinition,function(e){e.dimensionName===this.dimension&&(this.playDirectionAscending?i.length?(this.snap?(o=this._getNextRangeIndex(i)||i,e.values=[this.dimensionValues[o[0]],this.dimensionValues[o[1]]]):e.values=[this.dimensionValues[(i[0]+s)%this.dimensionValues.length],this.dimensionValues[(i[1]+s)%this.dimensionValues.length]],e.values.sort(this._sortCompareFunction)):e.values=[this.dimensionValues[(i+s)%this.dimensionValues.length]]:i.length?(this.snap?(o=this._getNextRangeIndex(i,-1)||i,e.values=[this.dimensionValues[o[0]],this.dimensionValues[o[1]]]):e.values=[this.dimensionValues[(this.dimensionValues.length+i[0]-s)%this.dimensionValues.length],this.dimensionValues[(this.dimensionValues.length+i[1]-s)%this.dimensionValues.length]],e.values.sort(this._sortCompareFunction)):e.values=[this.dimensionValues[(this.dimensionValues.length+i-s)%this.dimensionValues.length]],g.some(this.prefetchedValues[t.id],function(i){return n.stringify(i)===n.stringify(e.values)?!0:void 0})||(u=!0,this.prefetchedValues[t.id].push(e.values)))},this),u&&(a.mosaicRule=n.stringify(l.toJson()),t.getImageUrl(this.map.extent,this.map.width,this.map.height,function(i){h=new Image,r.prefetchImgNodes[t.id].push(h),h.src=i},a))}},setDimensionInfoText:function(i){if(R.isDefined(i)){var t=this.unitSymbol||this.unit;if("number"!=typeof i){var s=e.clone(i.sort(this._sortCompareFunction));(s[0]%1!==0||s[1]%1!==0)&&(s[0]=parseFloat(s[0].toFixed(2)),s[1]=parseFloat(s[1].toFixed(2))),i="["+s[0]+", "+s[1]+"]"}else i%1!==0&&(i=i.toFixed(2));this.dimensionInfo.innerHTML=this.unitSymbol?"<label style='font-weight:700;'>"+this.dimensionAlias+" ("+t+")</label>":"<label style='font-weight:700;'>"+this.dimensionAlias+"</label>",this.dimensionInfo.innerHTML+=this.layout===O.LAYOUT_HORIZONTAL?": "+i:"<br/> "+i}},setLabels:function(){},_filterLabels:function(){if(this.nLabels&&this.dimensionValues&&this.dimensionValues.length){var i=Math.ceil(this.dimensionValues.length/this.nLabels),e=g.map(this.dimensionValues,function(e,t){return t%i===0||t===this.dimensionValues.length-1?(e%1!==0&&(e=parseFloat(e.toFixed(2))),e):""},this);return e}},_filterLayers:function(){return g.filter(this._layers,function(i){return i.multidimensionalInfo&&i.visible&&i.useMapDimensionValue&&g.some(i.multidimensionalInfo.variables,function(i){return g.some(i.dimensions,function(i){return i.name===this.dimension?!0:void 0},this)?!0:void 0},this)?!0:void 0},this)},_updateUI:function(){x.remove(this.playPauseBtn.iconNode,this._iconClass),this._iconClass=this.playing?"mdsButton mdsPauseButton":"mdsButton mdsPlayButton",x.add(this.playPauseBtn.iconNode,this._iconClass)},_bumpSlider:function(i){var e=this._slider.value;i>=0?!this._snap&&(0>e||e>=this.dimensionValues.length-1||e[0]>=this.dimensionValues.length-1||e[1]>=this.dimensionValues.length-1)?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},this.prefetchImgNodes={},2===this._thumbCount?this._snap?this._slider.set("value",this._getNextRangeIndex(e)):this._slider.set("value",[0,Math.abs(e[0]-e[1])]):this._slider.set("value",0),this._timer.start(),this.playing=!0):this.pause()):2===this._thumbCount&&!this._snap&&e[0]<this.dimensionValues.length-1&&e[1]<this.dimensionValues.length-1?this._slider.set("value",[e[0]+1,e[1]+1]):1===this._thumbCount&&e<this.dimensionValues.length-1?this._slider.set("value",e+1):this._snap&&this._slider.set("value",this._getNextRangeIndex(e)):0>=e||e[0]<=0||e[1]<=0?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},2===this._thumbCount?this._snap?this._slider.set("value",this._getNextRangeIndex(e,-1)):this._slider.set("value",[this.dimensionValues.length-1,this.dimensionValues.length-1-Math.abs(e[0]-e[1])]):this._slider.set("value",this.dimensionValues.length-1),this._timer.start(),this.playing=!0):this.pause()):(e>=0||e[1]>=0)&&(2===this._thumbCount&&e[1]>0&&e[0]>0?this._snap?this._slider.set("value",this._getNextRangeIndex(e,-1)):this._slider.set("value",[e[0]-1,e[1]-1]):1===this._thumbCount&&e>0&&this._slider.set("value",e-1))},setThumbMovingRate:function(i){this.thumbMovingRate=i,this._timer&&this._timer.setInterval(this.thumbMovingRate)},getFullDimensionRange:function(i){i=i||this.dimension;var e,t;return g.forEach(this._layers,function(s){s.multidimensionalInfo&&s.multidimensionalInfo.variables&&g.forEach(s.multidimensionalInfo.variables,function(s){g.forEach(s.dimensions,function(s){s.name===i&&s.extent&&s.extent.length&&s.extent.length>1&&((!R.isDefined(e)||s.extent[0]<e)&&(e=s.extent[0]),(!R.isDefined(t)||s.extent[1]>t)&&(t=s.extent[1]))},this)},this)},this),[e,t]},setThumbCount:function(i){this._thumbCount=2==i?2:1,this.value=this.dimensionValues[this._slider.value],this._setupSlider()},clearDimensionalDefinition:function(i){var e,t,s=[];i&&i.mosaicRule&&i.mosaicRule.multidimensionalDefinition&&(t=i.mosaicRule,e=t.multidimensionalDefinition,g.forEach(e,function(i){i.dimensionName!==this.dimension&&s.push(i)},this),t.multidimensionalDefinition=s,i.setMosaicRule(t))},getUnit:function(){var i=null,e=!1;return this.unit=null,g.forEach(this._layers,function(t){t.multidimensionalInfo&&g.forEach(t.multidimensionalInfo.variables,function(t){g.forEach(t.dimensions,function(t){if(t.name===this.dimension&&t.unit)if(null!=i||e){if(R.isDefined(t.unit)&&t.unit.replace("esri","").toLowerCase()!==i.toLowerCase())return i=null,void(e=!0)}else i=t.unit.replace("esri","")},this)},this)},this),i&&(i=i.replace("esri","")),this.unit=i,this.unitSymbol=this.getUnitSymbol(),this._hasUnitConflict=e,i},_getDimensionAlias:function(){this.dimensionAlias=this.dimension,g.some(this._layers,function(i){return i.fields&&i.fields.length&&g.some(i.fields,function(i){return i.name&&i.name===this.dimension&&i.alias?(this.dimensionAlias=i.alias,!0):void 0},this)?!0:void 0},this)},_readMosaicRule:function(){var i;g.forEach(this._layers,function(e){e.mosaicRule&&e.mosaicRule.multidimensionalDefinition&&g.forEach(e.mosaicRule.multidimensionalDefinition,function(e){e&&e.dimensionName===this.dimension&&e.values&&(i=e.values.length&&e.values[0]&&e.values[0].length?e.values[0]:e.values)},this)},this),i&&(1===i.length?(this._thumbCount=1,this.useRanges=!1,this.value=i[0]):(this._thumbCount=2,this.useRanges=!0,this.value=i))},hasUnitConflict:function(){return this.getUnit(),this._hasUnitConflict},resizeSlider:function(i,e){L.set(this.domNode,{height:i+"px",width:e+"px"}),L.set(this.mdSliderTable,{height:i+"px",width:e+"px"}),this.computeSliderStyle()},computeSliderStyle:function(){var i,e;return i=N.getContentBox(this.domNode).h-N.getContentBox(this.dimensionInfo).h,t("ie")<=10&&(i-=53),this.showPlayButton&&(i-=35),e="height: "+i+"px;",this._slider&&this._slider.domNode&&L.set(this._slider.domNode,"height",i+"px"),e},getUnitSymbol:function(){if(!R.isDefined(this.unit))return null;var i=this.unit.toLowerCase();return"meters"===i||"meter"===i?this.unitSymbols.meter:"pascal"===i||"pascals"===i?this.unitSymbols.pascal:void 0},_snapToNearestRange:function(i){if(i&&i.length&&this._snap){var t,s,n,a,l,o,h,u,r=this;return a=[this.dimensionValues[i[1]],this.dimensionValues[i[0]]],a.sort(this._sortCompareFunction),g.some(this._dimensionObjects,function(i){return g.some(i.values,function(i){return i&&i.length&&i[0]===a[0]&&i[1]===a[1]?!0:void 0})?!0:void 0},this)?i:(g.some(this._dimensionObjects,function(i){return g.some(i.values,function(i){return i&&i.length&&i[0]===a[0]?(t=e.clone(i.sort(this._sortCompareFunction)),!0):void 0},this)?!0:void 0},this)&&(g.some(this.dimensionValues,function(i,e){i===t[0]&&(s=e),i===t[1]&&(n=e)}),h=Math.abs(i[0]-s),l=[s,n]),g.some(this._dimensionObjects,function(i){return g.some(i.values,function(i){return i&&i.length&&i[1]===a[1]?(t=e.clone(i.sort(this._sortCompareFunction)),!0):void 0},this)?!0:void 0},this)&&(g.some(this.dimensionValues,function(i,e){i===t[1]&&(n=e),i===t[0]&&(s=e)}),u=Math.abs(i[1]-n),o=[s,n]),i=h&&u?this._oldValue&&this._oldValue.length&&this._arraysEqual(this._oldValue,l)?o:this._oldValue&&this._oldValue.length&&this._arraysEqual(this._oldValue,o)?l:u>=h?l:o:l||o||i,this._update=!1,setTimeout(function(){r._slider.set("value",i)},100),i)}},_arraysEqual:function(i,e){var t;if(!R.isDefined(i)||!R.isDefined(e))return!1;if(i===e)return!0;if(i.length!==e.length)return!1;for(i.sort(this._sortCompareFunction),e.sort(this._sortCompareFunction),t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0},_getNextRangeIndex:function(i,e){if(!this._dimensionRangeValues||!this._dimensionRangeValues.length)return null;var t,s,n,a,l;return e=R.isDefined(e)?e:1,g.some(this._dimensionRangeValues,function(e,s){return this._arraysEqual(e,[this.dimensionValues[i[0]],this.dimensionValues[i[1]]])?(t=s,!0):void 0},this),s=e>0?(t+1)%this._dimensionRangeValues.length:(this._dimensionRangeValues.length+t-1)%this._dimensionRangeValues.length,n=this._dimensionRangeValues[s],g.some(this.dimensionValues,function(i,e){return i===n[0]&&(a=e),i===n[1]&&(l=e),a&&l?!0:void 0},this),[a,l]}});return e.mixin(j,O),t("extend-esri")&&e.setObject("dijit.MultidimensionalSlider",j,b),j});