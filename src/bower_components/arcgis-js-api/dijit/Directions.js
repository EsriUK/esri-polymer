// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/array","dojo/_base/Color","dijit/a11yclick","dijit/_TemplatedMixin","dijit/form/Select","dojo/store/Memory","dojo/data/ObjectStore","dojo/keys","dojo/has","dojo/on","dojo/mouse","dojo/dom","dojo/dom-geometry","dojo/dom-style","dojo/dom-class","dojo/dom-attr","dojo/query","dojo/number","dojo/i18n!../nls/jsapi","dojo/text!./templates/Directions.html","./Search","dojo/dom-construct","dojo/promise/all","dojo/Deferred","dojo/dnd/Source","../kernel","../graphic","../units","../InfoTemplate","../SpatialReference","../layers/ArcGISDynamicMapServiceLayer","../layers/GraphicsLayer","../geometry/webMercatorUtils","../geometry/geodesicUtils","../arcgis/utils","../geometry/Point","../geometry/Extent","../geometry/Polyline","../geometry/mathUtils","../symbols/SimpleMarkerSymbol","../symbols/PictureMarkerSymbol","../symbols/CartographicLineSymbol","../symbols/TextSymbol","../symbols/Font","./_EventedWidget","../tasks/FeatureSet","../tasks/RouteTask","../tasks/RouteParameters","../tasks/GeometryService","../tasks/DistanceParameters","../tasks/PrintTask","../tasks/PrintParameters","../tasks/PrintTemplate","../toolbars/edit","../config","../tasks/ProjectParameters","dojo/uacss"],function(t,e,s,i,o,r,n,a,h,c,l,u,d,p,_,g,m,f,v,y,S,w,b,T,C,M,L,D,N,E,R,x,P,O,k,I,A,G,W,U,B,j,F,H,q,K,V,$,z,J,Q,Z,Y,X,te,ee,se,ie,oe,re){var ne=e("esri.dijit.Directions",[z,a],{templateString:T,mapClickActive:!1,_eventMap:{activate:!0,deactivate:!1,load:!0,"directions-start":!0,"directions-finish":["result"],"directions-clear":!0,"segment-select":["graphic"],"segment-highlight":["graphic"],error:["error"],"stops-update":["stops"]},_emptyStop:{name:""},constructor:function(e,i){if(!e.map)throw Error('Required "map" parameter is missing. Cannot instantiate Directions Widget.');if(!i)throw Error('Required "srcNodeRef" parameter is missing. Cannot instantiate Directions Widget.');this._i18n=b,this._css={widgetContainerClass:"esriDirectionsContainer",searchSourceContainerClass:"esriSearchSourceContainer",stopsContainerClass:"esriStopsContainer",stopsTableContainerClass:"esriStopsTableContainer",stopsTableCoverClass:"esriStopsTableCover",reverseStopsClass:"esriStopsReverse",addStopsClass:"esriStopsAdd",stopsClass:"esriStops",stopsRemovableClass:"esriStopsRemovable",stopsButtonContainerClass:"esriStopsButtons",stopsOptionsButtonClass:"esriStopsOptionsButton",stopsAddDestinationClass:"esriStopsAddDestination",stopsAddDestinationBtnClass:"esriStopsAddDestinationBtn",stopsGetDirectionsContainerClass:"esriStopsGetDirectionsContainer",stopsGetDirectionsClass:"esriStopsGetDirections",stopsClearDirectionsClass:"esriStopsClearDirections",stopsInnerGeocoderClass:"esriInnerGeocoder",stopsOptionsOptionsEnabledClass:"esriStopsOptionsEnabled",stopsOptionsMenuClass:"esriStopsOptionsMenu",stopsFindOptimalOrderClass:"esriFindOptimalOrderOption",stopsUseTrafficClass:"esriUseTrafficOption",stopsReturnToStartClass:"esriReturnToStartOption",stopsOptionsCheckboxesClass:"esriOptionsCheckboxes",stopsOptionsToggleContainerClass:"esriOptionsToggleContainer",stopsOptionsUnitsContainerClass:"esriOptionsUnitsContainer",stopsOptionsUnitsMiClass:"esriOptionsUnitsMi",stopsOptionsUnitsKmClass:"esriOptionsUnitsKm",stopsOptionsImpedanceContainerClass:"esriOptionsImpedanceContainer",stopsOptionsImpedanceTimeClass:"esriOptionsImpedanceTime",stopsOptionsImpedanceDistanceClass:"esriOptionsImpedanceDistance",stopClass:"esriStop",stopOriginClass:"esriStopOrigin",stopDestinationClass:"esriStopDestination",stopUnreachedFirstOrLastClass:"esriStopUnreachedFirstOrLast",stopUnreachedClass:"esriStopUnreached",esriStopGeocoderColumnClass:"esriStopGeocoderColumn",esriStopReverseColumnClass:"esriStopReverseColumn",stopDnDHandleClass:"esriStopDnDHandle",stopDnDHandleClassHidden:"esriStopDnDHandleHidden",stopIconColumnClass:"esriStopIconColumn",stopIconClass:"esriStopIcon",stopIconRemoveColumnClass:"esriStopIconRemoveColumn",stopIconRemoveClass:"esriStopIconRemove",stopIconRemoveClassHidden:"esriStopIconRemoveHidden",resultsContainerClass:"esriResultsContainer",resultsLoadingClass:"esriResultsLoading",resultsPrintClass:"esriResultsPrint",resultsSummaryClass:"esriResultsSummary",resultsViewFullRouteClass:"esriResultsViewFullRoute",resultsRouteNameClass:"esriResultsRouteName",resultsRouteButtonContainerClass:"esriResultsButtonsContainer",routesContainerClass:"esriRoutesContainer",routesClass:"esriRoutes",routesErrorClass:"esriRoutesError",routeClass:"esriRoute",routeTextColumnClass:"esriRouteTextColumn",routeTextClass:"esriRouteText",routeLengthClass:"esriRouteLength",routeOriginClass:"esriDMTStopOrigin",routeDestinationClass:"esriDMTStopDestination",routeLastClass:"esriDMTStopLast",routeInfoClass:"esriRouteInfo",routeIconColumnClass:"esriRouteIconColumn",routeIconClass:"esriRouteIcon",infoWindowRouteClass:"esriInfoWindowRoute",routeZoomClass:"esriRouteZoom",esriPrintPageClass:"esriPrintPage",esriPrintBarClass:"esriPrintBar",esriPrintButtonClass:"esriPrintButton",esriCloseButtonClass:"esriCloseButton",esriPrintMainClass:"esriPrintMain",esriPrintHeaderClass:"esriPrintHeader",esriPrintLogoClass:"esriPrintLogo",esriPrintMapClass:"esriPrintMap",esriPrintNameClass:"esriPrintName",esriPrintNotesClass:"esriPrintNotes",esriPrintLengthClass:"esriPrintLength",esriPrintDirectionsClass:"esriPrintDirections",esriPrintFooterClass:"esriPrintFooter",esriPrintStopLabelClass:"esriPrintStopLabel",clearClass:"esriClear",dndDragBodyClass:"esriDndDragDirection",stopsButtonClass:"esriDirectionsButton",stopsButtonTabClass:"esriDirectionsTabButton",stopsButtonTabLastClass:"esriDirectionsTabLastButton",stopsPressedButtonClass:"esriDirectionsPressedButton",linkButtonClass:"esriLinkButton",activateButtonClass:"esriActivateButton",travelModesContainerClass:"esriTravelModesContainer"},this.options={map:null,autoSolve:!0,minStops:2,maxStops:20,theme:"simpleDirections",alphabet:"1234567890",directions:null,returnToStart:!1,optimalRoute:!1,routeTaskUrl:location.protocol+"//route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",printTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",geometryTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",routeParams:{},stops:["",""],searchOptions:{},stopsInfoTemplate:new P(b.widgets.directions.stop,"${address}${error}"),waypointInfoTemplate:new P(b.widgets.directions.maneuver,b.widgets.directions.waypoint),segmentInfoTemplate:new P(b.widgets.directions.maneuver,'<div class="${maneuverType}"><div class="'+this._css.routeIconClass+" "+this._css.infoWindowRouteClass+'"><strong>${step}.</strong> ${formattedText}</div></div>'),textSymbolFont:new $("11px",$.STYLE_NORMAL,$.VARIANT_NORMAL,$.WEIGHT_NORMAL,"Arial, Helvetica, sans-serif"),textSymbolColor:new r([255,255,255]),textSymbolOffset:{x:0,y:10.875},fromSymbol:new q({url:t.toUrl("./images/Directions/greenPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),fromSymbolDrag:new q({url:t.toUrl("./images/Directions/greenPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),stopSymbol:new q({url:t.toUrl("./images/Directions/bluePoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),stopSymbolDrag:new q({url:t.toUrl("./images/Directions/bluePointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),toSymbol:new q({url:t.toUrl("./images/Directions/redPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),toSymbolDrag:new q({url:t.toUrl("./images/Directions/redPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),unreachedSymbol:new q({url:t.toUrl("./images/Directions/grayPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),unreachedSymbolDrag:new q({url:t.toUrl("./images/Directions/grayPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),waypointSymbol:new H({color:[255,255,255,255],size:10,type:"esriSMS",style:"esriSMSCircle",outline:{color:[20,89,127,255],width:2.5,type:"esriSLS",style:"esriSLSSolid"}}),maneuverSymbol:new H({color:[255,255,255,255],size:4,type:"esriSMS",style:"esriSMSCircle",outline:{color:[30,99,137,255],width:1,type:"esriSLS",style:"esriSLSSolid"}}),routeSymbol:(new K).setColor(new r([20,89,127,1])).setWidth(10).setCap(K.CAP_ROUND).setJoin(K.JOIN_ROUND),segmentSymbol:(new K).setColor(new r([255,255,255,1])).setWidth(6).setCap(K.CAP_ROUND).setJoin(K.JOIN_ROUND),printPage:"",printTemplate:"",focusOnNewStop:!0,dragging:!0,canModifyStops:!0,canModifyWaypoints:!0,directionsLengthUnits:null,directionsLanguage:null,traffic:!1,trafficLayer:null,showPrintPage:!0,showSegmentPopup:!1,showSegmentHighlight:!0,showReverseStopsButton:!0,showReturnToStartOption:!0,showOptimalRouteOption:!0,showTravelModesOption:!0,showMilesKilometersOption:!0,showClearButton:!1,showActivateButton:!0};var o={_waypointName:"DWWP",_solveInProgress:!1,_moveInProgress:!1,_stopSequence:1e3};this.defaults=s.mixin({},this.options,e,o),this.domNode=i},postCreate:function(){this.inherited(arguments),this.own(p(this._activateButtonNode,n,s.hitch(this,function(){this.mapClickActive?this.deactivate():this.activate()}))),this.own(p(this._addDestinationNode,n,s.hitch(this,this._addStopButton))),this.own(p(this._optionsButtonNode,n,s.hitch(this,this._toggleOptionsMenu))),this.own(p(this._findOptimalOrderNode,n,s.hitch(this,this._toggleCheckbox))),this.own(p(this._returnToStartNode,n,s.hitch(this,this._toggleCheckbox))),this.own(p(this._useTrafficNode,n,s.hitch(this,this._toggleCheckbox))),this.own(p(this._useMilesNode,n,s.hitch(this,this._toggleUnits))),this.own(p(this._useKilometersNode,n,s.hitch(this,this._toggleUnits))),this.own(p(this._getDirectionsButtonNode,n,s.hitch(this,this.getDirections))),this.own(p(this._clearDirectionsButtonNode,n,s.hitch(this,function(){this.clearDirections()}))),this._symbolEventPaddingDirections=(new K).setColor(new r([0,255,0,0])).setWidth(20).setCap(K.CAP_ROUND),this._stopLayer=new I({id:"directions_stopLayer_"+this.id,displayOnPan:!0}),this._routeLayer=new I({id:"directions_routeLayer_"+this.id,displayOnPan:!0}),this._waypointsEventLayer=new I({id:"directions_waypointsEventLayer_"+this.id,displayOnPan:!0}),this.map.addLayer(this._routeLayer),this.map.addLayer(this._stopLayer),this._snappingManager=this.map.enableSnapping({layerInfos:[{layer:this._waypointsEventLayer,snapToVertex:!1,snapToPoint:!0,snapToEdge:!0}],tolerance:15}),this._setWidgetProperties();var t=new R(null,this.waypointSymbol,{}),e=s.hitch(this,function(){!this._moveInProgress&&t._isShown()&&(this.editToolbar.deactivate(),this._stopLayer.remove(t),clearTimeout(t._solveTimeout),t._solveTimeout=null,t.attributes.isWaypoint=!0,t._isStopIcon&&this.stopGraphics[t._index]&&(this._stopLayer.add(this.stopGraphics[t._index]),this._stopLayer.add(this.textGraphics[t._index]))),t._showTooltip()});this._handle=s.mixin(t,{_isHandle:!0,_tooltip:M.create("div",{className:this.theme+" esriDirectionsRouteTooltip",onmouseover:e},this.map.container),_showTooltip:s.hitch(this,function(e){t._tooltip.style.display=!e||e instanceof MouseEvent?"none":"inline",e&&(e="string"==typeof e?e:"<table class='esriRoutesTooltip'>"+this._renderDirectionsItemTR(e)+"</table>",t._tooltip.innerHTML!==e&&(t._tooltip.innerHTML=e))}),_isShown:s.hitch(this,function(){return this._stopLayer.graphics.indexOf(t)>-1}),_remove:e}),this._activate(this.mapClickActive)},startup:function(){return this.inherited(arguments),this._enqueue(this._init)},destroy:function(){this.deactivate(),this.map.removeLayer(this._routeLayer),this.map.removeLayer(this._stopLayer),this.map.removeLayer(this._waypointsEventLayer),this._disconnectEvents(),M.empty(this.domNode),this.inherited(arguments)},activate:function(){return this._enqueue(function(){this.set("mapClickActive",!0)})},deactivate:function(){return this._enqueue(function(){this.set("mapClickActive",!1)})},clearDirections:function(){return this._enqueue(function(){return this.clearErrors(),this._clearDirections()})},reset:function(){return this._enqueue(this._reset)},modifyStopSequence:function(t,e){return this._enqueue(function(){this._modifyStopSequence(t,e)})},onActivate:function(){},onDeactivate:function(){},onLoad:function(){},onDirectionsStart:function(){this._clearDisplayBeforeSolve(),this.set("solving",!0),this._showLoadingSpinner(!0)},onDirectionsFinish:function(){this._showLoadingSpinner(!1),this.set("solving",!1)},onDirectionsClear:function(){},onSegmentSelect:function(){},onSegmentHighlight:function(){},onStopsUpdate:function(){},onError:function(){},removeStops:function(){return this.reset()},removeStop:function(t,e,s){return this._enqueue(function(){return this.clearErrors(),this._removeStop(t,e,s)})},updateStops:function(t){return this._enqueue(function(){return this._updateStops(t)})},addStops:function(t,e){return this._enqueue(function(){return this._addStops(t,e)}).then(s.hitch(this,this.zoomToFullRoute))},addStop:function(t,e){return this._enqueue(function(){return this._addStop(t,e)})},updateStop:function(t,e,s){return this._enqueue(function(){return this._updateStop(t,e,s)})},clearErrors:function(){this.errors=[],this._errorNode&&(this._errorNode.innerHTML="")},getDirections:function(t){return this._enqueue(function(){return this._getDirections().then(s.hitch(this,function(){t!==!0&&this.zoomToFullRoute()}))})},selectSegment:function(t){if(!(!this.directions||!this.directions.features||0>t||t>=this.directions.features.length))for(var e=S("[data-segment]",this._resultsNode),s=0;s<e.length;s++){var i=parseInt(y.get(e[s],"data-segment"),10);if(t===i&&e[s]!==this._focusedDirectionsItem){this._focusedDirectionsItem=e[s],this.centerAtSegmentStart(t),this.onSegmentSelect(this.directions.features[t]),e[s].focus();break}}},unhighlightSegment:function(t){var e=this._segmentGraphics;if(e&&(!this._focusedDirectionsItem||t)){for(var s=0;s<e.length;s++)this._routeLayer.remove(e[s]);this._segmentGraphics=[]}},highlightSegment:function(t,e){if(!(this._focusedDirectionsItem&&!e||t>=this.directions.features.length)){t=t||0;var i=s.hitch(this,function(t){var e=this.map.toMap({x:0,y:0});return this.map.toScreen(e.offset(t,0)).x}),o=s.hitch(this,function(t){for(var e=0,s=0;s<t.length;s++)for(var o=1;o<t[s].length;o++){var r=t[s][o-1],n=t[s][o];e+=i(Math.sqrt((r[0]-n[0])*(r[0]-n[0])+(r[1]-n[1])*(r[1]-n[1])))}return e}),n=s.hitch(this,function(t){var e=this.map.toMap({x:0,y:0});return this.map.toMap({x:t,y:0}).x-e.x}),a=function(t,e,s){e=Math.max(1,e);for(var o,r,n,a,h=s?t[0].length-1:0,c=0,l=[[t[0][s?h:0]]];s&&h>0||!s&&h<t[0].length-1;){if(r=t[0][s?h-1:h],n=t[0][s?h:h+1],o=i(Math.sqrt((r[0]-n[0])*(r[0]-n[0])+(r[1]-n[1])*(r[1]-n[1])))){if(!(e>c+o)){a=(e-c)/o,s?l[0].splice(0,0,[n[0]-(n[0]-r[0])*a,n[1]-(n[1]-r[1])*a]):l[0].push([r[0]+(n[0]-r[0])*a,r[1]+(n[1]-r[1])*a]);break}s?l[0].splice(0,0,r):l[0].push(n),c+=o}h+=s?-1:1}return c+o>0?l:t},h=this.get("directions").features[t],c=new j(h.geometry),l=50,u=15,d=22,p=40*Math.PI/180;if(s.mixin(h.attributes,{_index:t}),t){var _=a(this.get("directions").features[t-1].geometry.paths,l/2,!0),g="esriDMTStop"!==h.attributes.maneuverType?a(c.paths,l/2,!1):_,m=g!==_?[_[0].concat(g[0])]:g,f=new j(g).getExtent();if(g[0].length>1&&i(Math.max(f.getWidth(),f.getHeight()))>=u){for(var v,y=Math.cos(p/2)*u,S=Math.sin(p/2)*u,w=g[0].length-2,b=g[0][w+1],T=0;w>=0&&!T;)v=g[0][w],T=i(Math.sqrt((v[0]-b[0])*(v[0]-b[0])+(v[1]-b[1])*(v[1]-b[1]))),w--;if(d>T){var C=T+(d-T)/3,M=T+2*(d-T)/3,L=[b[0]-C/T*(b[0]-v[0]),b[1]-C/T*(b[1]-v[1])],D=[v[0]+M/T*(b[0]-v[0]),v[1]+M/T*(b[1]-v[1])];v=L,b=D,T=d}var N,E,x=y/T,P=[b[0]-(b[0]-v[0])*x,b[1]-(b[1]-v[1])*x];v[1]!==b[1]?(x=(b[0]-v[0])/(b[1]-v[1]),N=n(S/Math.sqrt(1+x*x)),E=x*N):(N=0,E=n(S)),1/0===Math.abs(N)||1/0===Math.abs(E)||isNaN(N)||isNaN(E)||(m[0].push(b),m[0].push([P[0]-N,P[1]+E]),m[0].push([P[0]+N,P[1]-E]),m[0].push(b))}else m=a(m,2*o(g),!0);c.paths=m}this.unhighlightSegment(this._segmentGraphics&&this._segmentGraphics.length);var O=s.clone(this.routeSymbol).setWidth(this.segmentSymbol.width).setColor(new r([parseInt(.9*this.segmentSymbol.color.r),parseInt(.9*this.segmentSymbol.color.g),parseInt(.9*this.segmentSymbol.color.b)]));this._segmentGraphics=[new R(h.geometry,O,h.attributes,this.get("segmentInfoTemplate")),new R(c,this.routeSymbol,h.attributes,this.get("segmentInfoTemplate")),new R(c,this.segmentSymbol,h.attributes,this.get("segmentInfoTemplate"))],this.get("showSegmentHighlight")&&(this._routeLayer.add(this._segmentGraphics[0]),this._routeLayer.add(this._segmentGraphics[1]),this._routeLayer.add(this._segmentGraphics[2]));var k=s.hitch(this,function(t){if(t>0&&t<this.directions.features.length)for(var e=this.directions.features[t]._associatedFeaturesWithWaypoints,s=0;s<e.length;s++)e[s]._associatedSnapFeature&&e[s]._associatedSnapFeature.getDojoShape()&&e[s]._associatedSnapFeature.getDojoShape().moveToFront()});k(t-1),k(t),this.onSegmentHighlight(this.directions.features[t])}},zoomToSegment:function(t){var e,i=new D;return this.directions&&this.directions.features?(e=Math.max(0,Math.min(this.directions.features.length-1,t||0)),this.map.setExtent(this.get("directions").features[e].geometry.getExtent(),!0).promise.always(s.hitch(this,function(){this.highlightSegment(e),i.resolve()}))):i.reject("No directions."),i.promise},centerAtSegmentStart:function(t){var e,i=new D;if(this.directions&&this.directions.features){e=Math.max(0,Math.min(this.directions.features.length-1,t||0));var o=this.directions.features[e];this.map.centerAt(o.geometry.getPoint(0,0)).promise.always(s.hitch(this,function(){this.highlightSegment(e,!0),this._showSegmentPopup(o,e),i.resolve()}))}else i.reject("No directions.");return i.promise},zoomToFullRoute:function(){var t=new D;return this.directions&&this.directions.features?(this._clearInfoWindow(),this.unhighlightSegment(),this.get("map").setExtent(this.get("directions").extent,!0).promise.always(t.resolve)):t.reject("No directions."),t.promise},setListIcons:function(){var t,e=this._dnd.getAllNodes();for(t=0;t<e.length;t++){var s=S("."+this._css.stopIconClass,e[t])[0];s&&(s.innerHTML=this._getLetter(t)),v.remove(e[t],this._css.stopOriginClass+" "+this._css.stopDestinationClass+" "+this._css.stopUnreachedClass+" "+this._css.stopUnreachedFirstOrLastClass);var i=this.stopGraphics&&this.stopGraphics[t]&&this.stopGraphics[t].attributes?this.stopGraphics[t].attributes.Status:void 0,o=i>0&&6>i;0===t?v.add(e[t],o?this._css.stopUnreachedFirstOrLastClass:this._css.stopOriginClass):t!==e.length-1||this._startReturn?o&&v.add(e[t],this._css.stopUnreachedClass):v.add(e[t],o?this._css.stopUnreachedFirstOrLastClass:this._css.stopDestinationClass)}var r=S("[data-reverse-td]",this._dndNode)[0];M.destroy(r),this.get("showReverseStopsButton")&&M.create("td",{"data-reverse-td":"true",rowspan:e.length,className:this._css.esriStopReverseColumnClass,innerHTML:'<div role="button" class="'+this._css.reverseStopsClass+'" data-reverse-stops="true" title="'+b.widgets.directions.reverseDirections+'"></div>',onmouseover:function(t){t.stopPropagation()},onmouseout:function(t){t.stopPropagation()}},e[0])},addRouteSymbols:function(){if(this.stopGraphics.length){this._moveLayersToFront();for(var t=0;t<this.stopGraphics.length;t++)if(this.stopGraphics[t]&&(!this._handle._isShown()||this._handle._isShown()&&this._handle._index!==t)){this._stopLayer.add(this.stopGraphics[t]);var e=this.stopGraphics[t].getDojoShape();e&&e.moveToFront(),this._stopLayer.add(this.textGraphics[t]);var s=this.textGraphics[t].getDojoShape();s&&s.moveToFront()}this._moveInProgress&&!this._handle.attributes.isWaypoint&&this._handle.getDojoShape()&&this._handle.getDojoShape().moveToFront()}},createRouteSymbols:function(){this._clearStopGraphics();for(var t=this.get("stops"),e=0;e<t.length;e++){var s=t[e];if(s&&s.feature){var i=s.feature.attributes,o=i?i.Status:void 0,r=this._isStopAWaypoint(s)?this.waypointSymbol:this._getStopSymbol(e,t.length+(this._startReturn?1:0),!1,o),n=null;this._isStopAWaypoint(s)||(n=new V(this._getLetter(e),this.get("textSymbolFont"),this.get("textSymbolColor")),this.get("textSymbolOffset")&&n.setOffset(this.get("textSymbolOffset").x,this.get("textSymbolOffset").y));var a=new R(s.feature.geometry,n,{address:s.name},this.get("stopsInfoTemplate"));a._isStopLabel=!0,a._index=e;var h=new R(s.feature.geometry,r,{address:s.name,Status:void 0===o?0:o,CurbApproach:i&&i.CurbApproach?i.CurbApproach:null,isWaypoint:this._isStopAWaypoint(s)},this.get(this._isStopAWaypoint(s)?"waypointInfoTemplate":"stopsInfoTemplate"));h._isStopIcon=!0,h._index=e,this.stopGraphics[e]=h,this.textGraphics[e]=a}}this.set("stopGraphics",this.stopGraphics),this.set("textGraphics",this.textGraphics),this.addRouteSymbols(),this.setListIcons()},setTravelMode:function(t){return this._enqueue(function(){return this.clearErrors(),this._travelModeSelector.setValue(t),this._setTravelMode(t)})},getSupportedTravelModeNames:function(){var t=[],e=this.serviceDescription;if(e&&e.supportedTravelModes&&e.supportedTravelModes.length)for(var s=e.supportedTravelModes,i=0;i<s.length;i++)t.push(s[i].name);return t},setDirectionsLengthUnits:function(){var t=1===arguments.length?arguments[0]:this.get("directionsLengthUnits");return this._enqueue(function(){return this.clearErrors(),this._setDirectionsLengthUnits(t)})},setDirectionsLanguage:function(){var t=1===arguments.length?arguments[0]:this.get("directionsLanguage");return this._enqueue(function(){return this.clearErrors(),this._setDirectionsLanguage(t)})},useMyCurrentLocation:function(t){return this.clearErrors(),this._createLocateButton(this.geocoders[t],!0,!0)},_reset:function(){var t=this.mapClickActive;return this._setWidgetProperties(),this._init().then(s.hitch(this,function(){this.mapClickActive=t,this._searchSourceSelector&&this._searchSourceSelector.setValue("all")}))},_activate:function(){var t=this.get("mapClickActive"),e=s.hitch(this,function(t){for(var e=t?[this.textGraphics,this.stopGraphics,this.displayedManeuverPointGraphics,this.displayedRouteGraphics]:[this.displayedRouteGraphics,this.displayedManeuverPointGraphics,this.stopGraphics,this.textGraphics],s=0;s<e.length;s++)for(var i=e[s],o=0;o<i.length;o++){var r=i[o].getDojoShape();r&&r[t?"moveToBack":"moveToFront"].call(r)}});this._addStopOnMapClickListener&&this._addStopOnMapClickListener.remove(),t?(this.map.activeDirectionsWidget&&this.map.activeDirectionsWidget!==this&&this.map.activeDirectionsWidget.deactivate(),this.map.activeDirectionsWidget=this,this._addStopOnMapClickListener=p(this.map,"click",s.hitch(this,function(t){this.canModifyStops&&!this._solveInProgress&&(this.map.infoWindow.hide(),this.addStop(new R(t.mapPoint)))})),this.map.addLayer(this._waypointsEventLayer),this._moveLayersToFront(),v.add(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onActivate()):(this.map.removeLayer(this._waypointsEventLayer),v.remove(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onDeactivate()),e(!t),this.emit("map-click-active",{mapClickActive:this.mapClickActive})},_moveLayersToFront:function(){var t=this.get("map"),e=t.graphicsLayerIds.length-1;t.reorderLayer(this._routeLayer,e),t.reorderLayer(this._waypointsEventLayer,e),t.reorderLayer(this._stopLayer,e)},_destroyGeocoders:function(){var t=this.get("geocoders");if(t&&t.length)for(var e=0;e<t.length;e++)t[e]&&t[e].destroy();this.set("geocoders",[])},_disconnectEvents:function(){var t,e=this._clearDirections(!0);if(this._watchEvents&&this._watchEvents.length)for(t=0;t<this._watchEvents.length;t++)this._watchEvents[t].unwatch();if(this._onEvents&&this._onEvents.length)for(t=0;t<this._onEvents.length;t++)this._onEvents[t].remove();if(this._geocoderEvents)for(t=0;t<this._geocoderEvents.length;t++)this._geocoderEvents[t].value.unwatch(),this._geocoderEvents[t].select.remove(),this._geocoderEvents[t].suggest.remove();return this._onEvents=[],this._watchEvents=[],this._geocoderEvents=[],this._disconnectResults(),this._destroyGeocoders(),this._destroyGlobalGeocoder(),this._destroyDnD(),e},_getDirections:function(){this._removeEmptyStops();var t=new D;return this._getStopCount()>=this.minStops?(this.onDirectionsStart(),this.clearErrors(),this._dnd.sync(),this._sortGeocoders(),this._getCandidates(this.get("stops")).then(s.hitch(this,function(e){this.stops=e,this._setStops();var i=this._validateStops(e);if(i.error){var o=b.widgets.directions.error.locator,r=this.get("geocoders")[i.index];r&&(o=b.widgets.directions.error.unknownStop.replace("<name>",r.get("value"))),this._resultError(o),this.set("directions",null),this._clearRouteGraphics(),t.reject(o),this.onDirectionsFinish(new Error([o]))}else this._configureRoute().always(s.hitch(this,function(e){t.resolve(e)}))}),s.hitch(this,function(e){this.set("directions",null),this._clearRouteGraphics(),t.reject(e),this.onDirectionsFinish(e)}))):this._clearDirections(!0).always(s.hitch(this,function(){this.createRouteSymbols(),t.reject(b.widgets.directions.error.notEnoughStops)})),t.promise},_clearDirections:function(){var t=new D;return this._handle&&this._handle._remove(),this.get("routeParams")&&this.get("routeParams").stops?this.get("routeParams").stops.features.length?(this.get("routeParams").stops.features=[],this.onDirectionsClear(),t.resolve()):arguments.length?t.resolve():this._reset().then(t.resolve,t.reject):t.resolve(),this.set("directions",null),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this._removeTrafficLayer(),t.promise},_setTravelMode:function(t){var e,s=new D,i=this.serviceDescription,o=function(){s.resolve(t)};if(i&&i.supportedTravelModes&&i.supportedTravelModes.length){var r=i.supportedTravelModes,n=!1;for(e=0;e<r.length;e++)if(r[e].name===t){n=!0,!this.routeParams.travelMode||this.routeParams.travelMode&&this.routeParams.travelMode.name!==t?(this.routeParams.travelMode=r[e].impedanceAttributeName?r[e]:r[e].itemId,this._solveAndZoom().always(o)):s.resolve(t),this._updateTrafficCheckbox();break}n||s.reject(t)}else s.reject(t);return s.promise},_updateTrafficCheckbox:function(){if(this.serviceDescription){for(var t=this.routeParams.travelMode,e=this.routeParams.impedanceAttribute,s=this.serviceDescription.impedance,i=t?t.impedanceAttributeName:e?e:s,o=this.serviceDescription.networkDataset.networkAttributes,r=!1,n=0;n<o.length;n++)if(o[n].name===i){r=void 0!==o[n].trafficSupport&&"esriNTSNone"!==o[n].trafficSupport||void 0===o[n].trafficSupport&&"TravelTime"===i;break}this._useTrafficNode.disabled=!r,this._useTrafficNode.checked=this._useTrafficNode.checked&&r,r||this._removeTrafficLayer()}},_setDirectionsLengthUnits:function(t){var e=new D;return v.remove(this._useMilesNode,this._css.stopsPressedButtonClass),v.remove(this._useKilometersNode,this._css.stopsPressedButtonClass),t===x.KILOMETERS?v.add(this._useKilometersNode,this._css.stopsPressedButtonClass):t===x.MILES&&v.add(this._useMilesNode,this._css.stopsPressedButtonClass),t===x.KILOMETERS||t===x.METERS||t===x.MILES||t===x.FEET||t===x.NAUTICAL_MILES?(this.directionsLengthUnits=t,e.resolve(t)):e.reject(t),e.promise},_setDirectionsLanguage:function(t){var e=new D;return t=this._setDirectionsLanguageByLocale(t),this._solveAndZoom().always(function(){e.resolve(t)},e.reject),e.promise},_showLoadingSpinner:function(t){void 0===t&&(t=this._requestQueueTail&&!this._requestQueueTail.isFulfilled()||this._moveInProgress),t?v.add(this._widgetContainer,this._css.resultsLoadingClass):v.remove(this._widgetContainer,this._css.resultsLoadingClass)},_enqueue:function(t){var e=new D;return this._requestQueueTail||(this._requestQueueTail=new D,this._requestQueueTail.resolve()),this._requestQueueTail.promise.always(s.hitch(this,function(){try{var i=t.call(this);i&&"object"==typeof i&&i.hasOwnProperty("isFulfilled")?i.then(s.hitch(this,function(t){e.resolve(t),this._showLoadingSpinner()}),s.hitch(this,function(t){e.reject(t),this._showLoadingSpinner()})):(e.resolve(i),this._showLoadingSpinner())}catch(o){e.reject(o),this._showLoadingSpinner()}})),this._requestQueueTail=e,this._showLoadingSpinner(),e.promise},_createDnD:function(){this._dnd=new N(this._dndNode,{skipForm:!0,withHandles:!0})},_destroyDnD:function(){M.empty(this._dndNode),this._dnd&&(this._dnd.destroy(),this._dnd=null)},_usingAGOL:function(){return this.get("routeTaskUrl").search(/^(https?:)*\/\/route*[^.]*\.arcgis\.com.*$/i)>-1},_setSearchOptions:function(){var t={maxResults:1,locationToAddressDistance:100},e={map:this.get("map"),autoNavigate:!1,enableInfoWindow:!1,enableHighlight:!1,enableSourcesMenu:!1};this.searchOptions=s.mixin(t,this.defaults.searchOptions,e)},_setDefaultUnits:function(){if(!this.get("directionsLengthUnits")){var t="EN-US"===i.locale.toUpperCase()?x.MILES:x.KILOMETERS;this.defaults.directionsLengthUnits&&(t=this.defaults.directionsLengthUnits),this.set("directionsLengthUnits",t)}this._setDirectionsLengthUnits(this.directionsLengthUnits)},_setTrafficOptions:function(){this.set("showTrafficOption",!(!this.defaults.showTrafficOption&&this.defaults.hasOwnProperty("showTrafficOption")||"esriNTSHistoricalAndLive"!==this.serviceDescription.trafficSupport&&"esriNTSHistorical"!==this.serviceDescription.trafficSupport&&"esriNTSLive"!==this.serviceDescription.trafficSupport)),this._usingAGOL()&&this.get("showTrafficOption")&&(this.get("trafficLayer")||this.set("trafficLayer",new k(location.protocol+"//traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",{opacity:.4}))),this._optionsMenu()},_updateCanModifyStops:function(){this.canModifyStops||this.canModifyWaypoints||this.set("mapClickActive",!1),arguments[1]||!this.canModifyStops||this.canModifyWaypoints||this.set("mapClickActive",!0),this._showAddDestination(),this._showMapClickActiveButton(),this._stopsTableCover.style.display=this.canModifyStops?"none":"inline"},_updateCanAddWaypoints:function(){this.canModifyStops||this.canModifyWaypoints||this.set("mapClickActive",!1),arguments[1]||this.canModifyStops||!this.canModifyWaypoints||this.set("mapClickActive",!0),this._showMapClickActiveButton(),this._handle._remove()},_setWidgetProperties:function(){this._disconnectEvents(),this.set("loaded",!1),this.set(this.defaults),this.set("stops",[]),this._updateCanModifyStops()},_updateStops:function(t){var e=new D;return t?this.get("loaded")?this._reset().then(s.hitch(this,function(){this._addStops(t).then(e.resolve,e.reject)}),e.reject):this._addStops(t).then(e.resolve,e.reject):e.reject(),e.promise},_removeStop:function(t,e,i,o){var r=new D,n=s.hitch(this,function(t){this.stops.splice(t,1);var e=this._dnd.getAllNodes()[t],s=this.get("geocoders");s[t].destroy(),s.splice(t,1),this.set("geocoders",s),this._geocoderEvents[e.id]&&(this._geocoderEvents[e.id].select.remove(),this._geocoderEvents[e.id].suggest.remove(),this._geocoderEvents[e.id].value.unwatch()),M.destroy(e),this._dnd.sync(),this._stopsRemovable(),this._optionsMenu(),this._checkMaxStops(),this.setListIcons(),this._sortGeocoders()});(0>t||t>=this.stops.length||"undefined"===t)&&(t=this.stops.length-1);for(var a=t,h=!1,c=this.stopGraphics[a]&&this._isStopAWaypoint(this.stops[a])||o;!h;)n(a),c?h=!0:(a-=0>=a||a<this.stops.length&&this._isStopAWaypoint(this.stops[a])?0:1,h=!this._isStopAWaypoint(this.stops[a]));for(;this.stops.length<this.minStops;)this._addStop();return this._setStops(),this.createRouteSymbols(),i?(this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this.createRouteSymbols(),r.resolve()):this._solveAndZoom(e).then(r.resolve,r.reject),r.promise},_removeTrafficLayer:function(){var t=this.get("trafficLayer"),e=this.get("map");t&&e&&e.removeLayer(t),this._trafficLayerAdded=!1},_addStops:function(t,e){var i=new D,o=[],r=this.autoSolve;this.autoSolve=!1,void 0===e&&(e=this._getStopCount());for(var n=0;n<Math.min(t.length,this.maxStops-this._getStopCount());n++){var a=new D;this._addStop(t[n],e+n,!0).always(a.resolve),o.push(a)}return L(o).always(s.hitch(this,function(){this.autoSolve=r,this._getDirections().always(function(){i.resolve(t)
})})),i.promise},_addStop:function(t,e,i){var o=new D;return this._checkMaxStops(),this.maxStopsReached?(this._resultError(b.widgets.directions.error.maximumStops),o.reject(b.widgets.directions.error.maximumStops)):(void 0===t&&void 0===e&&(e=this.stops.length),t instanceof R&&t.attributes&&t.attributes.isWaypoint&&(!e||e===this.stops.length||this._getStopCount()<2)&&!i?(this._resultError(b.widgets.directions.error.waypointShouldBeInBetweenStops),o.reject(b.widgets.directions.error.waypointShouldBeInBetweenStops)):this._getCandidate(t).then(s.hitch(this,function(t){this._insertStop(t,e),this.autoSolve&&""!==t.name?this._getDirections().always(function(){o.resolve(t,e)}):o.resolve(t,e)}),s.hitch(this,function(t){o.reject(t)}))),o.promise},_removeEmptyStops:function(){for(var t=0,e=this.stops.length-this._getWaypointCount()-this.minStops;t<this.stops.length&&e>0;)this.stops[t]&&this.stops[t].name?t++:(this._removeStop(t,!0,!0,!0),e--,this._moveInProgress&&this._handle._index>=t&&this._handle._isStopIcon&&this._handle._index--)},_setReverseGeocode:function(t,e,s){if(t.feature.geometry&&s>-1){var i={address:t.name};if(this.stopGraphics[s]&&(this.stopGraphics[s].setAttributes(i),this.stopGraphics[s].setGeometry(e)),this.textGraphics[s]&&(this.textGraphics[s].setAttributes(i),this.textGraphics[s].setGeometry(e)),this.set("stopGraphics",this.stopGraphics),this.set("textGraphics",this.textGraphics),this.get("geocoders")[s]){var o=this.get("geocoders")[s];o.value=t.name,o.inputNode.value=t.name}return this.stops[s]=t,this.stops[s].feature.setGeometry(e),this._setStops(),this._enqueue(function(){return this._getDirections()})}},_insertStop:function(t,e){var s,i;if(void 0===e){for(s=0;s<this.geocoders.length;s++)if(!this.geocoders[s].get("value")){i=this.geocoders[s];break}}else s=e,this.geocoders[s]&&!this.geocoders[s].get("value")&&(i=this.geocoders[s]);!i||void 0!==e&&e!==s||this._isStopAWaypoint(t)?(void 0===e&&(e=this.geocoders.length),this._createGeocoder(t,e)):(this.stops[s]=t,i.set("value",t.name),i._stopReference=t),this._optionsMenu()},_createGeocoder:function(t,e){var i=this._dnd.getAllNodes(),r=!1,n=!1,a=i.length;i[e]?(n=i[e],r=!0):(n=!1,r=!1);var h=s.hitch(this,function(t,e){var s=e?this._css.stopDnDHandleClass:this._css.stopDnDHandleClassHidden,i=e?this._css.stopDnDHandleClassHidden:this._css.stopDnDHandleClass;v.replace(t.children[0],s,i),this.geocoders.length>2&&(s=e?this._css.stopIconRemoveClass:this._css.stopIconRemoveClassHidden,i=e?this._css.stopIconRemoveClassHidden:this._css.stopIconRemoveClass,v.replace(t.children[3].children[0],s,i))}),c=M.create("tr",{className:this._css.stopClass,style:this._isStopAWaypoint(t)?"display:none;":"",onmouseover:function(){h(this,!0)},onmouseout:function(){h(this,!1)}});M.create("td",{className:this._css.stopDnDHandleClassHidden+" dojoDndHandle"},c);var l=M.create("td",{className:this._css.stopIconColumnClass},c);M.create("div",{className:this._css.stopIconClass+" dojoDndHandle",innerHTML:this._getLetter(a),"data-center-at":"true"},l);var u=M.create("td",{className:this._css.esriStopGeocoderColumnClass},c),d=M.create("div",{},u),p=M.create("td",{className:this._css.stopIconRemoveColumnClass},c);M.create("div",{className:this._css.stopIconRemoveClassHidden,role:"button","data-remove":"true"},p),this._dnd.insertNodes(!1,[c],r,n),this.stops.splice(e,0,t);var _=s.mixin({},this.get("searchOptions"),{value:t.name,activeSourceIndex:this._globalGeocoder.activeSourceIndex}),g=new C(_,d);g._tr=c,g._stopReference=t,g.startup(),this.geocoders.splice(e,0,g),this._geocoderEvents[c.id]={select:g.on("select-result",s.hitch(this,function(t){var e=!0;if(t&&(t.results||t.result)){var s=this._dnd.getAllNodes(),i=o.indexOf(s,c),r=t.results&&t.results.results&&t.results.results.length?t.results.results[0]:t.result;r?(g.set("value",this._decorateEmptyAGOLGeocoderResponse(r).name),this.stops[i]=this._toPointGeometry(r),this._setStops()):(this._removeStopButton(i),this.set("directions",null),this._resultError(b.widgets.directions.error.unknownStop.replace("<name>",t.target.get("value"))),this._clearRouteGraphics(),e=!1),e&&this.getDirections()}})),suggest:g.on("suggest-results",function(){if(document.activeElement===this.inputNode)for(var t=S("LI[role='menuitem']",this.suggestionsNode),e=0;e<t.length;e++)y.set(t[e],"tabindex",-1);else this._hideSuggestionsMenu()}),value:g.watch("value",s.hitch(this,function(t,e,s){this._enqueue(function(){if(s!==e&&g._stopReference&&g._stopReference.name!==s){var t=this.stops.indexOf(g._stopReference);this.stops[t]={name:s},s||(this._handle._remove(),this._removeSomeWaypoints(this._markWPsForRemovalAfterUserChangedStopSequence(t))),this._setStops(),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this.createRouteSymbols()}})}))},this._checkMaxStops(),this.setListIcons(),this._stopsRemovable(),this._optionsMenu(),this._sortGeocoders()},_blurGeocoders:function(){if(document.activeElement)for(var t=0;t<this.geocoders.length;t++)if(this.geocoders[t].inputNode===document.activeElement){this.geocoders[t]._hideSuggestionsMenu(),this.geocoders[t].inputNode.blur(),this._getStopCount()>=this.minStops&&this.getDirections(!0);break}},_decorateEmptyAGOLGeocoderResponse:function(t){return t&&", , "===t.name&&(t.name=t.feature&&t.feature.attributes&&t.feature.attributes.Match_addr?t.feature.attributes.Match_addr+("POI"===t.feature.attributes.Addr_type&&t.feature.attributes.City&&-1===t.feature.attributes.Match_addr.indexOf(t.feature.attributes.City)?", "+t.feature.attributes.City:""):""),t},_toPointGeometry:function(t){var e=t.feature.geometry;if(e)if(e.getCentroid)t.feature.geometry=e.getCentroid();else if(e.getExtent){var s=e.getExtent();s&&(t.feature.geometry=s.getCenter())}return t},_removeLocateButtonVisibilityEvents:function(){for(var t=0;t<this.geocoders.length;t++){var e=this.geocoders[t];e._onMouseEnter&&e._onMouseEnter.remove(),e._onMouseOut&&e._onMouseOut.remove(),e._onKeyPress&&e._onKeyPress.remove(),e._locateButton&&(e._locateButton._onMouseEnter&&e._locateButton._onMouseEnter.remove(),e._locateButton._onMouseOut&&e._locateButton._onMouseOut.remove())}},_setLocateButtonVisibilityEvents:function(){this._removeLocateButtonVisibilityEvents();for(var t=this,e=function(e){e instanceof FocusEvent?this._geocoder._lbShown_f=!0:this._geocoder._lbShown_g=!0,t._createLocateButton(this._geocoder,!0)},i=function(e){e instanceof FocusEvent?this._geocoder._lbShown_f=!1:this._geocoder._lbShown_g=!1,clearTimeout(this._destroyTimeout),this._destroyTimeout=setTimeout(s.hitch(this,function(){this._geocoder._lbShown_lb||this._geocoder._lbShown_f||t._destroyLocateButton(this._locateButton)}),400)},o=function(){this._geocoder._lbShown_g=!0,clearTimeout(this._destroyTimeout),this._destroyTimeout=setTimeout(s.hitch(this,function(){""===this.value?t._createLocateButton(this._geocoder,!0):t._destroyLocateButton(this._locateButton)}),400)},r=function(){this._geocoder._lbShown_lb=!0,clearTimeout(this._geocoder._destroyTimeout)},n=function(){this._geocoder._lbShown_lb=!1,clearTimeout(this._geocoder._destroyTimeout),this._geocoder._destroyTimeout=setTimeout(s.hitch(this,function(){this._geocoder._lbShown_g||this._geocoder._lbShown_f||t._destroyLocateButton(this._geocoder.inputNode._locateButton)}),400)},a=0;a<this.geocoders.length;a++){var h=this.geocoders[a];if(h.inputNode._geocoder=h,h._onMouseEnter=p(h.inputNode,_.enter,e),h._onMouseOut=p(h.inputNode,[_.leave,"blur"],i),h._onKeyPress=p(h.inputNode,"keydown",o),h.inputNode._locateButton){var c=h.inputNode._locateButton;c._onMouseEnter=p(c.domNode,_.enter,r),c._onMouseOut=p(c.domNode,_.leave,n)}}},_createLocateButton:function(e,i,r){var a=new D,h=e;return h.inputNode._locateButton&&h.inputNode._locateButton._locating?a.resolve():t(["./LocateButton"],s.hitch(this,function(t){if(this._destroyLocateButton(h.inputNode._locateButton),h){var e=M.create("div",{},h.domNode);v.add(h.domNode,this._css.stopsInnerGeocoderClass);var c=new t({map:this.map,highlightLocation:!1,centerAt:!1,setScale:!1,useTracking:!1},e);c.startup(),h.inputNode._locateButton=c,c.domNode._geocoder=h,this._setLocateButtonVisibilityEvents();var l=s.hitch(this,function(){c._locating=!0,h.set("value",""),h.inputNode.placeholder=b.widgets.directions.retrievingMyLocation.toUpperCase()});c._onBeforeLocate=p(c._locateNode,n,l),c._onLocate=p(c,"locate",s.hitch(this,function(t){c._locating=!1,t.graphic?(i&&this._destroyLocateButton(h.inputNode._locateButton),this.updateStop(new R(t.graphic.geometry),o.indexOf(this.geocoders,h)).then(s.hitch(this,function(){this.stopGraphics.length>1?this.getDirections().always(function(){a.resolve(t)}):a.resolve(t)}))):(h.set("value",""),h.inputNode.placeholder=b.widgets.directions.myLocationError.toUpperCase(),console.error(t.error),a.reject(t.error))})),r?(l(),c.locate()):a.resolve()}else a.reject()})),a.promise},_destroyLocateButton:function(t){if(t){var e=t.domNode._geocoder;clearTimeout(e._destroyTimeout),t._locating?e._destroyTimeout=setTimeout(s.hitch(this,function(){e._lbShown_lb||e._lbShown_f||this._destroyLocateButton(t)}),100):(t.clear(),t._onBeforeLocate.remove(),t._onLocate.remove(),t._onMouseEnter&&t._onMouseEnter.remove(),t._onMouseOut&&t._onMouseOut.remove(),t.destroy(),e.inputNode&&(e.inputNode._locateButton=null,e._setPlaceholder(e.activeSourceIndex)))}},_validateStops:function(t){if(t)for(var e=0;e<t.length;e++)if(!t[e]||!t[e].feature)return{error:!0,index:e};return{error:!1}},_sortStops:function(){this.stops.length&&(this.stops.sort(s.hitch(this,function(t,e){for(var s,i,o=0;o<this.get("geocoders").length;o++)this.geocoders[o]._stopReference===t?s=o:this.geocoders[o]._stopReference===e&&(i=o);return s>i?1:i>s?-1:0})),this._setStops())},_getCandidate:function(t){var e=new D,i=typeof t;if(t)if("object"===i&&t.hasOwnProperty("feature")&&t.hasOwnProperty("name"))t.name=this._isStopAWaypoint(t)?this._waypointName:String(t.name),"point"!==t.feature.geometry.type&&(t.feature.geometry=new U([t.feature.geometry.x,t.feature.geometry.y],this.map.spatialReference)),e.resolve(t);else if("object"===i&&t.hasOwnProperty("address")&&t.hasOwnProperty("location")){var o=this._globalGeocoder._hydrateResult(t);e.resolve(o)}else"object"!==i||!t.hasOwnProperty("name")||null!==t.name&&""!==t.name?t instanceof R&&t.attributes&&(void 0!==t.attributes.Name||t.attributes.isWaypoint)?e.resolve(this._addStopWrapperToGraphic(t,t.attributes.isWaypoint?this._waypointName:String(t.attributes.Name))):("object"===i&&t.hasOwnProperty("name")&&(t=String(t.name)),this._reverseGeocode(t).then(e.resolve,e.reject)):e.resolve(s.clone(this._emptyStop));else e.resolve(s.clone(this._emptyStop));return e.promise},_reverseGeocode:function(t){var e,i=new D,o=t.geometry?t.geometry:t;if(this._globalGeocoder){var r=s.hitch(this,function(t){var e=new D,s=500;if(this.map){var i=this.map.toScreen(o);if(i.x+=W._calculateClickTolerance([t]),this.map.spatialReference.isWebMercator())s=Math.abs(this.map.toMap(i).x-o.x),e.resolve(s);else if(4326===this.map.spatialReference.wkid)s=Math.abs(A.geographicToWebMercator(this.map.toMap(i)).x-A.geographicToWebMercator(o).x),e.resolve(s);else if(this._geometryService){var r=new X;r.distanceUnit=Y.UNIT_METER,r.geometry1=o,r.geometry2=this.map.toMap(i),this._geometryService.distance(r,function(t){s=t,e.resolve(s)},function(){e.resolve(s)})}}return e.promise}),n=[],a=this._globalGeocoder.sources,h=function(){a[e].featureLayer&&n.push(r(a[e].featureLayer).then(s.hitch(a[e],function(t){this.searchQueryParams=s.mixin(this.searchQueryParams,{distance:t})})))};if("all"===this._globalGeocoder.activeSourceIndex)for(e=0;e<a.length;e++)h();else e=this._globalGeocoder.activeSourceIndex,h();L(n).always(s.hitch(this,function(){this._globalGeocoder.search(o).then(s.hitch(this,function(s){var r=!1;if(s){var n,a=null;for(e=0;e<this._globalGeocoder.sources.length;e++)if(s[e]&&s[e].length){n=s[e];break}if(n.length&&(r=!0,a=n[0],this._globalGeocoder.sources[e].featureLayer)){var h=Number.POSITIVE_INFINITY;for(e=0;e<n.length;e++){n[e]=this._toPointGeometry(n[e]);var c=G.geodesicLengths([new j({paths:[[A.xyToLngLat(o.x,o.y),A.xyToLngLat(n[e].feature.geometry.x,n[e].feature.geometry.y)]],spatialReference:{wkid:this.map.spatialReference.wkid}})],"esriMeters")[0];h>c&&(h=c,a=n[e])}}a=this._decorateEmptyAGOLGeocoderResponse(a),a&&""!==a.name&&null!==a.name&&void 0!==a.name?(a.name=String(a.name),isNaN(o.x)||isNaN(o.y)||this.map.spatialReference.wkid!==o.spatialReference.wkid?!a.feature.geometry||isNaN(a.feature.geometry.x)||isNaN(a.feature.geometry.y)?(this._resultError(b.widgets.directions.error.locator),i.reject(b.widgets.directions.error.locator)):i.resolve(a):(a.feature.geometry=o,i.resolve(a))):r=!1}r||(t instanceof U?t=new R(t):t instanceof Array&&(t=new R(new U(t[0],t[1]))),t instanceof R?this._decorateUngeocodedStop(t).then(i.resolve,i.reject):(this._resultError(b.widgets.directions.error.unknownStop.replace("<name>",t.toString())),i.reject(b.widgets.directions.error.unknownStop.replace("<name>",t.toString()))))}))}))}else this._resultError(b.widgets.directions.error.locatorUndefined),i.reject(b.widgets.directions.error.locatorUndefined);return i.promise},_updateStop:function(t,e,i){var o=new D;return this.stops&&this.stops[e]?t instanceof R&&t.attributes&&t.attributes.isWaypoint&&(!e||e===this.stops.length-1||this._getStopCount()<2)?(this._resultError(b.widgets.directions.error.waypointShouldBeInBetweenStops),o.reject(b.widgets.directions.error.waypointShouldBeInBetweenStops)):this._getCandidate(t).then(s.hitch(this,function(t){var s=t.feature,r=s?s.geometry:null,n=this.stops[e].feature,a=n?n.geometry:null,h=r&&a&&(r.x!==a.x||r.y!==a.y)||!r&&a;this.stops[e]=t;var c=this.get("geocoders")[e];c._stopReference=t,c._tr.style.display=this._isStopAWaypoint(t)?"none":"",c.value=t.name,c.inputNode.value=t.name,h&&this.autoSolve||i?this._getDirections().then(o.resolve,o.reject):(this._setStops(),o.resolve(t))}),s.hitch(this,function(t){o.reject(t)})):(this._resultError(b.widgets.directions.error.couldNotUpdateStop),o.reject(b.widgets.directions.error.couldNotUpdateStop)),this._optionsMenu(),o.promise},_renderDirections:function(){var t=this.get("directions"),e="";if(this._resultsNode){if(e+='<div class="'+this._css.resultsRouteNameClass+'">',e+=t.routeName,e+="</div>",e+='<div class="'+this._css.clearClass+'"></div>',t.totalLength||t.totalTime){var i=this._formatDistance(t.totalLength,!0),r=this._formatTime(t.totalTime);e+='<div class="'+this._css.resultsSummaryClass+'">',i&&(e+=i),i&&r&&(e+=" &middot; "),r&&(e+=r),e+="</div>"}e+='<div class="'+this._css.clearClass+'"></div>',e+='<div class="'+this._css.resultsRouteButtonContainerClass+'">',e+='<div tabindex="0" role="button" class="'+this._css.linkButtonClass+" "+this._css.resultsViewFullRouteClass+'" data-full-route="true">'+b.widgets.directions.viewFullRoute+"</div>",this.get("showPrintPage")&&(e+='<div tabindex="0" role="button" title="'+b.widgets.directions.print+'" class="'+this._css.resultsPrintClass+'" data-print-directions="true"></div>'),e+='<div class="'+this._css.clearClass+'"></div>',e+="</div>",e+='<div class="'+this._css.routesClass+'">',e+='<table summary="'+t.routeName+'">',e+='<tbody role="menu">';for(var n=0;n<t.features.length;n++)e+=this._renderDirectionsItemTR(t.features[n],n);e+="</tbody>",e+="</table>",e+="</div>",this._resultsNode&&(this._resultsNode.innerHTML=e),this._disconnectResults();var a=S("[data-segment]",this._resultsNode);a&&a.length&&o.forEach(a,s.hitch(this,function(t){this._resultEvents.push(p(t,_.enter,s.hitch(this,function(){if(!this._focusedDirectionsItem){var e=parseInt(y.get(t,"data-segment"),10);this.highlightSegment(e)}}))),this._resultEvents.push(p(t,"focusout",s.hitch(this,function(){this._focusedDirectionsItem=null,this.unhighlightSegment(!0)}))),this._resultEvents.push(p(t,_.leave,this.unhighlightSegment)),this._resultEvents.push(p(t,"click, keydown",s.hitch(this,function(e){e&&("click"===e.type||"keydown"===e.type&&e.keyCode===u.ENTER)&&(this._focusedDirectionsItem!==t?this.selectSegment(parseInt(y.get(t,"data-segment"),10)):(t.blur(),this.map.infoWindow.hide(),this._focusedDirectionsItem=null,this.unhighlightSegment(!0)))})))}))}},_renderDirectionsItemTR:function(t){var e=this.directions,s=e?o.indexOf(e.features,t):-1,i="",r=this._css.routeClass;if(s>-1){t.attributes&&(t.attributes.step=s+1),t.attributes.maneuverType&&(r+=" "+t.attributes.maneuverType),0===s&&t._associatedStop&&1===t._associatedStop.attributes.Sequence?r+=" "+this._css.routeOriginClass:s===e.features.length-1&&(r+=" "+this._css.routeDestinationClass),s===e.features.length-1&&(r+=" "+this._css.routeLastClass),i+='<tr tabindex="0" role="menuitem" class="'+r+" "+this._css.routeZoomClass+'" data-segment="'+s+'">',i+='<td class="'+this._css.routeIconColumnClass+'">',i+='<div class="'+this._css.routeIconClass+'">',i+=this._getLetter(t._associatedStop),i+="</div>",i+="</td>",i+='<td class="'+this._css.routeTextColumnClass+'">',i+='<div class="'+this._css.routeInfoClass+'">',i+='<div class="'+this._css.routeTextClass+'">';var n,a=e.strings[s]||[];if("esriDMTDepart"===t.attributes.maneuverType||"esriDMTStop"===t.attributes.maneuverType)for(n=0;n<this.stops.length;n++)this.stops[n]&&this.stops[n].name&&a.push({string:this.stops[n].name});if(a){var h=t.attributes.text;for(n=0;n<a.length;n++)h=this._boldText(h,a[n].string);t.attributes.formattedText=h}else t.attributes.formattedText=t.attributes.text;i+="<strong>"+w.format(t.attributes.step)+".</strong> "+t.attributes.formattedText,i+="</div>";var c=this._formatDistance(t.attributes.length,!1),l=this._formatTime(t.attributes.time);c&&(i+='<div class="'+this._css.routeLengthClass+'">',i+=c,l&&(i+=" &middot; "+l),i+="</div>"),i+="</div>",i+="</td>",i+="</tr>"}return i},_addStopWrapperToGraphic:function(t,e){return{extent:new B({xmin:t.geometry.x-.25,ymin:t.geometry.y-.25,xmax:t.geometry.x+.25,ymax:t.geometry.y+.25,spatialReference:t.geometry.spatialReference}),feature:t,name:e}},_showRoute:function(t){this._clearDisplayAfterSolve();var e=t.routeResults[0].directions,s=new D;if(e){this.set("solveResult",t),this.set("directions",e);var i,o,r=t.routeResults[0].stops;if(r&&r.length){var n=[],a=r.length;for(this._startReturn&&a--,i=0;a>i;i++){var h=r[i];h.attributes.isWaypoint=h.attributes.Name===this._waypointName;var c=this._addStopWrapperToGraphic(h,h.attributes.Name);n.push(c)}for(this.stops=n,i=0;i<this.stops.length;i++)this._updateStop(this.stops[i],i);this._setStops()}this.set("mergedRouteGraphic",new R(e.mergedGeometry,this.get("routeSymbol")));var l=[],u=[],d=0;for(i=0;i<e.featuresWithWaypoints.length;i++){var p=e.featuresWithWaypoints[i];if("esriDMTDepart"===p.attributes.maneuverType)for(o=0;o<this.stops.length;o++)if(this.stops[o].feature===p._associatedStop){d=o+1;break}p.setSymbol(this.get("routeSymbol")),this._routeLayer.add(p),l.push(p);var _=p.getDojoShape();_&&_.moveToBack();var g=new R(p.geometry,this._symbolEventPaddingDirections,p.attributes);if(g._nextStopIndex=d-.5,g._isSnapFeature=!0,p._associatedSnapFeature=g,this._waypointsEventLayer.add(g),"esriDMTDepart"!==p.attributes.maneuverType){var m=p.geometry.getPoint(0,0);if(m){var f=new R(m,this.maneuverSymbol);f._directionsFeature=p._associatedFeatureNoWaypoints,u.push(f),this._waypointsEventLayer.add(u[u.length-1])}}}for(this.set("displayedRouteGraphics",l),this.set("displayedManeuverPointGraphics",u),this._renderDirections(),i=0;i<this.stops.length;i++)if(this._isStopAWaypoint(this.stops[i])&&this._modifiedWaypointIndex===i){for(o=0;o<e.featuresWithWaypoints.length;o++){var v=e.featuresWithWaypoints[o];if(v._associatedStop===this.stops[i].feature){("esriDMTStop"===v.attributes.maneuverType||"esriDMTDepart"===v.attributes.maneuverType)&&(this.stops[i].feature.geometry.x=v.geometry.paths[0][0][0],this.stops[i].feature.geometry.y=v.geometry.paths[0][0][1]);break}}this._modifiedWaypointIndex=null;break}this.onDirectionsFinish(t),s.resolve()}else{var y=t.routeResults[0].route;y.setSymbol(this.routeSymbol),this._routeLayer.add(y),this._incrementalRouteSegment=y,s.resolve()}return this._moveLayersToFront(),this.createRouteSymbols(),s.promise},_setGeocodersStopReference:function(){if(this.geocoders)for(var t=0;t<this.geocoders.length;t++)this.geocoders[t]&&this.stops[t]&&(this.geocoders[t]._stopReference=this.stops[t])},_setStops:function(){this._setGeocodersStopReference(),this.createRouteSymbols(),this._set("stops",this.stops),this.onStopsUpdate(this.stops)},_getCandidates:function(t){var e=[];if(t&&t.length){for(var s=0;s<t.length;s++)e.push(this._getCandidate(t[s]));return L(e)}var i=new D;return i.resolve([]),i.promise},_clearResultsHTML:function(){this._resultsNode&&(this._resultsNode.innerHTML="")},_showSegmentPopup:function(t){if(t&&this.get("showSegmentPopup")&&this.get("map").infoWindow){var e=t.geometry,s=e.getPoint(0,0),i=new R(s,null,t.attributes,this.get("segmentInfoTemplate")),o=this.get("map").infoWindow;o.setFeatures([i]),o.show(s)}},_removeStopButton:function(t){this.stops.length>this.get("minStops")?this.removeStop(t):(this._setStops(),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve())},_addStopButton:function(){this.addStop().then(s.hitch(this,function(){this.get("focusOnNewStop")&&this.geocoders[this.stops.length-1].focus()}))},_sortGeocoders:function(){var t=this._dnd.getAllNodes();this.geocoders.sort(s.hitch(this,function(e,s){return e.domNode&&e.domNode.parentNode&&e.domNode.parentNode.parentNode&&s.domNode&&s.domNode.parentNode&&s.domNode.parentNode.parentNode?o.indexOf(t,e.domNode.parentNode.parentNode)>o.indexOf(t,s.domNode.parentNode.parentNode)?1:-1:0})),this._sortStops();for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].inputNode.title=b.widgets.directions.stopNoTitle+(e+1);this._setLocateButtonVisibilityEvents()},_disconnectResults:function(){if(this._resultEvents&&this._resultEvents.length)for(var t=0;t<this._resultEvents.length;t++)this._resultEvents[t]&&this._resultEvents[t].remove();this._resultEvents=[]},_formatArbitraryCostsForRouteTooltip:function(t){var e="",s=this.serviceDescription.networkDataset.networkAttributes;for(var i in t)if(0===i.indexOf("Total_")&&t.hasOwnProperty(i))for(var o=0;o<s.length;o++)s[o].name===i.substr(6)&&"esriNAUTCost"===s[o].usageType&&(e+="esriNAUMinutes"===s[o].units?this._formatTime(t[i]):w.format(t[i],{places:3,locale:"root"})+" "+s[o].units.substr(7).toLowerCase(),e+=e?" &middot; ":"");return e&&(e=b.widgets.directions.toNearbyStops+": <b>"+e.substr(0,e.length-10)+"</b>"),e},_formatTime:function(t){var e,s,i="",o=Math.round(t);return e=Math.floor(o/60),s=Math.floor(o%60),e&&(i+=e+" ",i+=e>1?b.widgets.directions.time.hours:b.widgets.directions.time.hour),e&&s&&(i+=" "),s&&(i+=s+" ",i+=s>1?b.widgets.directions.time.minutes:b.widgets.directions.time.minute),i},_formatDistance:function(t,e,i){var o=this._getUnits(this.get("directionsLengthUnits")),r=i?this._getUnits(s.hitch(this,function(){for(var t="",e=this.serviceDescription.networkDataset.networkAttributes,s=0;s<e.length;s++)if(e[s].name===i&&"esriNAUTCost"===e[s].usageType){t=e[s].units;break}return t})()):o,n=b.widgets.directions.units[o];switch(r+">"+o){case"MILES>KILOMETERS":t*=1.609344;break;case"KILOMETERS>MILES":t/=1.609344;break;case"METERS>KILOMETERS":t/=1e3;break;case"METERS>MILES":t/=1609.344}o=n?e?n.name:n.abbr:o.replace("esri","").toLowerCase();var a=Math.round(100*t)/100;return 0===a?"":w.format(a,{locale:"root"})+" "+o},_editToolbar:function(){this.set("editToolbar",new ie(this.get("map")))},_destroyGlobalGeocoder:function(){this._globalGeocoder&&(this._globalGeocoder.destroy(),this._globalGeocoder=null)},_createGlobalGeocoder:function(){var t=new D;return this._globalGeocoder=new C(this.get("searchOptions")),p.once(this._globalGeocoder,"load",s.hitch(this,function(){for(var e=0;e<this._globalGeocoder.sources.length;e++){var s=this._globalGeocoder.sources[e].locator;if(s&&s.url&&(s.url.toUpperCase().indexOf(this._globalGeocoder.defaultSource.locator.url.toUpperCase())>-1||s.url.toUpperCase().indexOf("//GEOCODEDEV.ARCGIS.COM/ARCGIS/REST/SERVICES/WORLD/GEOCODESERVER")>-1)&&!this._globalGeocoder.sources[e].searchTemplate){this._globalGeocoder.sources[e].searchTemplate="${Address}, ${City}, ${Region}";break}}t.resolve()},function(e){t.reject(e)})),this._globalGeocoder.startup(),t.promise},_init:function(){var t=new D;return this.set("loaded",!1),this.clearErrors(),this.get("map").loaded?this._configure().always(t.resolve):p.once(this.get("map"),"load",s.hitch(this,function(){this._configure().always(t.resolve)})),t.promise},_setDefaultStops:function(){var t=new D;return this.defaults.stops&&this.defaults.stops.length?this._updateStops(this.defaults.stops).then(s.hitch(this,function(){this._removeEmptyStops(),t.resolve()}),t.reject):t.resolve(),t.promise},_configure:function(){var t=new D;return this._handle&&this._handle._remove(),this._createDnD(),this._setSearchOptions(),this._createGlobalGeocoder().then(s.hitch(this,function(){this._editToolbar(),this._usingAGOL()||(this.geometryTaskUrl=null,this.printTaskUrl=null),this._createGeometryTask(),this._createPrintTask(),this._showActivateButton(),this._createTravelModesDDL(),this._createSearchSourceDDL();var e=[this._createRouteTask(),this._setDefaultStops()];L(e).then(s.hitch(this,function(){this._setDefaultUnits(),this._setTrafficOptions(),this._setMenuNodeValues(),this._setupEvents(),this._setDirectionsLanguageByLocale(this.directionsLanguage?this.directionsLanguage:i.locale.toLowerCase()),this._setupTravelModes().then(s.hitch(this,function(){this.set("loaded",!0),this.onLoad(),t.resolve(!0)}),function(e){t.reject(e)})}),function(e){t.reject(e)})}),function(e){t.reject(e)}),t.promise},_setDirectionsLanguageByLocale:function(t){var e=this.serviceDescription.directionsSupportedLanguages,s=function(t){if(e)for(var s=0;s<e.length;s++)if(e[s].toLowerCase().substr(0,2)===t)return e[s];return null},i=s(t);return i||(t=t.substr(0,2),i=s(t)),this.directionsLanguage=i,this.routeParams.directionsLanguage=i,i},_getStopSymbol:function(t,e,s,i){return this.get(void 0===i||0===i||6===i?0===t?s?"fromSymbolDrag":"fromSymbol":t===e-1?s?"toSymbolDrag":"toSymbol":s?"stopSymbolDrag":"stopSymbol":s?"unreachedSymbolDrag":"unreachedSymbol")},_addTrafficLayer:function(){var t=this.get("trafficLayer");t&&!this._trafficLayerAdded&&(this.get("map").addLayer(t),t.show(),this._trafficLayerAdded=!0)},_toggleUnits:function(t){t.target===this._useMilesNode?this.setDirectionsLengthUnits(x.MILES):t.target===this._useKilometersNode&&this.setDirectionsLengthUnits(x.KILOMETERS)},_toggleCheckbox:function(t){var e=y.get(t.target,"checked");t.target===this._findOptimalOrderNode?this.set("optimalRoute",e):t.target===this._useTrafficNode?this.set("traffic",e):t.target===this._returnToStartNode&&this.set("returnToStart",e)},_configureRouteOptions:function(){var t,e=this.get("routeParams");if(this.get("directionsLengthUnits")?e.directionsLengthUnits=this.get("directionsLengthUnits"):this.set("directionsLengthUnits",e.directionsLengthUnits),e.findBestSequence=this.get("optimalRoute"),e.findBestSequence)for(t=0;t<this.stops.length;)this._isStopAWaypoint(this.stops[t])?this._removeStop(t,!0,!0):t++;if(!this.returnToStart&&this.stops.length&&this._isStopAWaypoint(this.stops[this.stops.length-1]))for(t=this.stops.length-1;t>0;)this._isStopAWaypoint(this.stops[t])&&this._removeStop(t,!0,!0),t--;this._updateTrafficCheckbox(),this.get("traffic")&&!this._useTrafficNode.disabled?(e.startTime=new Date,e.startTimeIsUTC=!0,this._addTrafficLayer()):(e.startTime=null,e.startTimeIsUTC=null,this._removeTrafficLayer()),e.returnStops=!0;var s=[];for(t=0;t<this.stopGraphics.length;t++)this.stopGraphics[t]&&s.push(new R(this.stopGraphics[t].toJson()));if(this.get("returnToStart")&&this.stopGraphics.length&&this.stopGraphics[0]){var i=new R(this.stopGraphics[0].toJson());this._startReturn=i,s.push(i)}else this._startReturn=null;e.stops.features=s,this.set("routeParams",e)},_configureRoute:function(){var t=new D;this.createRouteSymbols(),this._configureRouteOptions(),this.routeParams.returnRoutes&&this._incrementalSolveStopRange?this.routeParams.stops.features=this.routeParams.stops.features.slice(this._incrementalSolveStopRange.start,this._incrementalSolveStopRange.end+1):this._incrementalSolveStopRange=null;var e,i,o,r={},n=this.routeParams.stops.features;for(e=0;e<n.length;e++)o=n[e].attributes.address,i=(e===this._handle._index&&!this._handle.attributes.isWaypoint&&this._incrementalSolveStopRange?this._waypointName:o)+"_"+this._stopSequence++,n[e].attributes.Name=i,r[i]=o,delete n[e].attributes.address,delete n[e].attributes.isWaypoint,delete n[e].attributes.Status;return this._solveInProgress=!0,this.routeTask.solve(this.routeParams,s.hitch(this,function(i){this._solveInProgress=!1;var o=i.routeResults[0],n=o.directions,a=o.stops;if(n){var h=function(t){for(var e in r)if(t&&0===n.routeName.indexOf(e)||!t&&n.routeName.indexOf(e)>0)return r[e];return""},c=h(!0),l=h(!1);for(n.routeName=(c!==this._waypointName?c:b.widgets.directions.waypoint)+" â "+(l!==this._waypointName?l:b.widgets.directions.waypoint),e=0;e<n.features.length;e++){var u=n.features[e].attributes;if("esriDMTDepart"===u.maneuverType||"esriDMTStop"===u.maneuverType)for(var d in r)if(r.hasOwnProperty(d)&&u.text.indexOf(d)>-1){u.text=u.text.replace(d,r[d]);for(var p=null,_=0;_<a.length;_++)if(a[_].attributes.Name===d){p=a[this.returnToStart&&_===a.length-1?0:_];break}n.features[e]._associatedStop=p}}for(e=0;e<a.length;e++)a[e].attributes.Name=r[a[e].attributes.Name];this._directionsPostprocessing(n)}this._showRoute(i).always(s.hitch(this,function(){this._incrementalSolveStopRange=null,t.resolve(i)}))}),s.hitch(this,function(e){this._solveInProgress=!1;for(var i=0;i<this.stops.length;i++)this.stops[i].feature.attributes=s.mixin(this.stops[i].feature.attributes,{Status:5});this.set("directions",null),this._clearDisplayAfterSolve(),this.createRouteSymbols(),this._routeTaskError(e),t.reject(e)})),t.promise},_directionsPostprocessing:function(t){var e,i,o=function(e,s){var i=t.features[e]._associatedFeaturesWithWaypoints||[];i.push(t.featuresWithWaypoints[s]),t.features[e]._associatedFeaturesWithWaypoints=i,t.featuresWithWaypoints[s]._associatedFeatureNoWaypoints=t.features[e]},r=s.hitch(this,function(t){return"<div class='"+this.theme+"'><table class='esriRoutesTooltip'>"+this._renderDirectionsItemTR(t._associatedFeatureNoWaypoints)+"</table></div>"});for(t.featuresWithWaypoints=[],e=0;e<t.features.length;e++){var n=new R(t.features[e].toJson());n.setInfoTemplate(new P({title:this._i18n.widgets.directions.maneuver,content:r})),t.featuresWithWaypoints.push(n),t.featuresWithWaypoints[e]._associatedStop=t.features[e]._associatedStop}for(e=0,i=0;e<t.features.length;)if(t.features[e]._associatedStop&&t.features[e]._associatedStop.attributes.Name===this._waypointName)if(t.features.splice(e,e?2:1),t.strings.splice(e,e?2:1),e&&t.features[e]&&"esriDMTStraight"===t.features[e].attributes.maneuverType){var a=t.features.splice(e,1)[0];t.strings.splice(e,1),t.features[e-1].attributes.length+=a.attributes.length,t.features[e-1].attributes.time+=a.attributes.time,t.features[e-1].geometry.paths[0]=t.features[e-1].geometry.paths[0].concat(a.geometry.paths[0]),o(e-1,i++),o(e-1,i++),o(e-1,i++)}else e&&o(e-1,i++),e<t.features.length&&o(e,i++);else o(e,i++),e++},_boldText:function(t,e){return t.replace(new RegExp("(^|\\s|\\W)("+e+")(\\W|\\s|$)","ig"),"$1<strong>$2</strong>$3")},_clearStopGraphics:function(){if(this.stopGraphics&&this.stopGraphics.length)for(var t=0;t<this.stopGraphics.length;t++)this._stopLayer.remove(this.stopGraphics[t]),this._stopLayer.remove(this.textGraphics[t]);this.set("stopGraphics",[]),this.set("textGraphics",[])},_clearRouteGraphics:function(){for(var t=this.displayedRouteGraphics,e=this.displayedManeuverPointGraphics,s=this._routeLayer,i=this._waypointsEventLayer,r=0,n=0,a=this._incrementalSolveStopRange?this._incrementalSolveStopRange:{start:0,end:this.stops?this.stops.length:-1};t&&n<t.length;){if(t[n]._associatedStop)for(var h=0;h<this.stops.length;h++)if(this.stops[h].feature===t[n]._associatedStop){r=h;
break}r>=a.start&&r<a.end?(s.remove(t[n]),t.splice(n,1)):n++}s.remove(this._incrementalRouteSegment),this.set("displayedRouteGraphics",t?t:[]),e&&e.length&&o.forEach(e,function(t){i.remove(t)}),this.set("displayedManeuverPointGraphics",[]),this._waypointsEventLayer.clear(),this.unhighlightSegment(!0)},_clearInfoWindow:function(){var t=this.get("map").infoWindow;t&&(t.hide(),t.clearFeatures())},_clearDisplayBeforeSolve:function(){this._clearInfoWindow(),this._clearResultsHTML()},_clearDisplayAfterSolve:function(){this._clearStopGraphics(),this._clearRouteGraphics(),this.clearErrors()},_getLetter:function(t){var e=this.alphabet,i="",o=function(t){var s="";return"0123456789"===e||"1234567890"===e?s=String(t+1):(t=t||0,t>=e.length&&(s=o(Math.floor(t/e.length)-1),t%=e.length),s+=e[t]),s},r=t instanceof R?s.hitch(this,function(){for(var e=this.get("returnToStart")?this.stops.length:-1,s=0;s<this.stops.length;s++)if(this.stops[s].feature===t){e=s;break}return e})():t;if(r>-1&&e&&e.length){e instanceof Array&&(e=e.toString().replace(/,/g,""));for(var n=-1,a=0;r>=a;a++)n+=this._isStopAWaypoint(this.stops[a])?0:1;i=o(n)}return i},_solveAndZoom:function(t){if(this.autoSolve)return this._getDirections().then(s.hitch(this,function(){t||this.zoomToFullRoute()}));var e=new D;return e.resolve(),e.promise},_setupEvents:function(){var t=p(this._dndNode,"[data-reverse-stops]:click, [data-reverse-stops]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===u.ENTER)&&this.modifyStopSequence()}));this._onEvents.push(t);var e=p(this._resultsNode,"[data-print-directions]:click, [data-print-directions]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===u.ENTER)&&this._printDirections()}));this._onEvents.push(e);var i=p(this._resultsNode,"[data-full-route]:click, [data-full-route]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===u.ENTER)&&this.zoomToFullRoute()}));this._onEvents.push(i);var r=p(this._dndNode,"[data-remove]:click, [data-remove]:keydown",s.hitch(this,function(t){if(t&&("click"===t.type||"keydown"===t.type&&t.keyCode===u.ENTER)){var e=S("[data-remove]",this._dndNode),s=o.indexOf(e,t.target);this._removeStopButton(s)}}));this._onEvents.push(r),this._onEvents.push(p(this._dndNode,"[data-center-at]:click, [data-center-at]:keydown",s.hitch(this,function(t){if(t&&("click"===t.type||"keydown"===t.type&&t.keyCode===u.ENTER)){var e=S("[data-center-at]",this._dndNode),s=o.indexOf(e,t.target);this.stops[s]&&this.stops[s].feature&&this.stops[s].feature.geometry&&this.map.centerAndZoom(this.stops[s].feature.geometry)}}))),this._onEvents.push(p(this.map,"zoom-end",s.hitch(this,function(){var t=this._segmentGraphics;t&&t[0]&&void 0!==t[0].attributes._index&&this.highlightSegment(t[0].attributes._index,!0)})));var n=p(this._dnd,"Drop",s.hitch(this,function(){this._dnd.sync(),this.set("optimalRoute",!1);var t,e,s=!1,i=[],r=this._dnd.getAllNodes();for(t=0;t<this.geocoders.length;t++)if(e=o.indexOf(r,this.geocoders[t]._tr),e>-1&&t!==e&&t!==e-1){for(;e>0&&this._isStopAWaypoint(this.stops[e]);)e--;s=!0;break}s&&(i=this._markWPsForRemovalAfterUserChangedStopSequence(t,e)),this._sortGeocoders(),this.setListIcons(),this._removeSomeWaypoints(i),this.stops[e].name&&this.getDirections()}));this._onEvents.push(n);var a=p(this._dnd,"DndStart",s.hitch(this,function(){var t=S("body")[0];v.add(t,this._css.dndDragBodyClass),this._removeLocateButtonVisibilityEvents()}));this._onEvents.push(a);var h=p(this._dnd,"DndDrop, DndCancel",s.hitch(this,function(){var t=S("body")[0];v.remove(t,this._css.dndDragBodyClass),this._setLocateButtonVisibilityEvents()}));this._onEvents.push(h);var c=this._handle,l=s.hitch(this,function(t){var e=s.hitch(this,function(e,s,i,o,r){var n=c._isShown();if(c.setGeometry(e),c._tooltip.style.left=t.screenPoint.x+"px",c._tooltip.style.top=t.screenPoint.y+"px",!n||c._index===i&&c.attributes.isWaypoint===o||(c._remove(),n=!1),c.setSymbol(s),c._index=i,c._isStopIcon=c._index===Math.floor(c._index),c.attributes.isWaypoint=o,c._isStopIcon&&(c.attributes.address=this.stopGraphics[i].attributes.address,c.setInfoTemplate(this.stopGraphics[i].infoTemplate)),this.canModifyWaypoints||c._isStopIcon){if(!n){this._stopLayer.add(c);var a=c.getDojoShape();a&&a[o?"moveToBack":"moveToFront"].call(a)}this.editToolbar.activate(ie.MOVE,c)}var h=o?c._isStopIcon?b.widgets.directions.dragWaypoint:this.canModifyWaypoints?b.widgets.directions.dragRoute:"":b.widgets.directions.dragStop;c._showTooltip(r||h)});if(this.unhighlightSegment(),this.mapClickActive&&this.dragging&&!this._solveInProgress&&!this._moveInProgress&&!c._solveTimeout)if(clearTimeout(c._removeTimeout),(t.graphic._isStopIcon||t.graphic._isStopLabel)&&!t.graphic.attributes.isWaypoint&&this.canModifyStops||t.graphic._isStopIcon&&t.graphic.attributes.isWaypoint&&this.canModifyWaypoints){var i=t.graphic._isStopLabel?this.stopGraphics[t.graphic._index]:t.graphic;e(i.geometry,i.attributes.isWaypoint?this.waypointSymbol:this._getStopSymbol(i._index,this.stopGraphics.length,!0,i.attributes.Status),i._index,i.attributes.isWaypoint===!0),this._stopLayer.remove(this.stopGraphics[i._index]),this._stopLayer.remove(this.textGraphics[i._index])}else(t.graphic._isSnapFeature||t.graphic._isHandle&&!t.graphic._isStopIcon)&&(this._snappingManager||(this._snappingManager=this.map.snappingManager),this._snappingManager.getSnappingPoint(t.screenPoint).then(s.hitch(this,function(s){if(!this._moveInProgress&&s){for(var i=this.displayedManeuverPointGraphics,r=null,n=0;n<i.length;n++)if(i[n].geometry.x===s.x&&i[n].geometry.y===s.y){r=i[n]._directionsFeature;var a=o.indexOf(this.directions.features,r);a>-1&&this.highlightSegment(a);break}e(s,t.graphic._isHandle?c.symbol:this.waypointSymbol,t.graphic._isHandle?c._index:t.graphic._nextStopIndex,t.graphic._isHandle?c.attributes.isWaypoint:!0,r)}})))}),d=s.hitch(this,function(){clearTimeout(c._removeTimeout),c._removeTimeout=setTimeout(c._remove,100),this.unhighlightSegment()});this._onEvents.push(this._waypointsEventLayer.on("mouse-move",l)),this._onEvents.push(this._waypointsEventLayer.on("mouse-out",d)),this._onEvents.push(this._stopLayer.on("mouse-move",l)),this._onEvents.push(this._stopLayer.on("mouse-out",d)),this._editToolbarEvents();var _=this.watch("theme",this._updateThemeWatch);this._watchEvents.push(_),this._watchEvents.push(this.watch("canModifyStops",this._updateCanModifyStops)),this._watchEvents.push(this.watch("canModifyWaypoints",this._updateCanAddWaypoints));var g=this.watch("showReturnToStartOption",this._optionsMenu);this._watchEvents.push(g);var m=this.watch("showOptimalRouteOption",this._optionsMenu);this._watchEvents.push(m);var f=this.watch("returnToStart",this._setMenuNodeValues);this._watchEvents.push(f);var y=this.watch("optimalRoute",this._setMenuNodeValues);this._watchEvents.push(y);var w=this.watch("routeTaskUrl",s.hitch(this,function(){this._createRouteTask(),this._setTrafficOptions()}));this._watchEvents.push(w),this._watchEvents.push(this.watch("printTaskUrl",s.hitch(this,function(){this._createPrintTask()}))),this._watchEvents.push(this.watch("geometryTaskUrl",s.hitch(this,function(){this._createGeometryTask()})));var T=this.watch("routeParams",s.hitch(this,function(){this._createRouteParams(),this._setDefaultUnits()}));this._watchEvents.push(T);var C=this.watch("searchOptions",s.hitch(this,function(){this._setSearchOptions(),this._createGlobalGeocoder();var t=this.get("searchOptions").sources;if(t)for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].set("sources",t)}));this._watchEvents.push(C);var M=this.watch("showReverseStopsButton",this.setListIcons);this._watchEvents.push(M);var L=this.watch("showPrintPage",this._renderDirections);this._watchEvents.push(L);var D=this.watch("trafficLayer",this._trafficLayerUpdate);this._watchEvents.push(D);var N=this.watch("editToolbar",this._editToolbarEvents);this._watchEvents.push(N);var E=this.watch("showTravelModesOption",this._showTravelModesOption);this._watchEvents.push(E);var R=this.watch("showMilesKilometersOption",this._showMilesKilometersOption);this._watchEvents.push(R);var x=this.watch("showClearButton",this._showClearButton);this._watchEvents.push(x);var P=this.watch("directionsLengthUnits",this.setDirectionsLengthUnits);this._watchEvents.push(P),this._watchEvents.push(this.watch("directionsLanguage",this.setDirectionsLanguage)),this._watchEvents.push(this.watch("mapClickActive",this._activate)),this._watchEvents.push(this.watch("showActivateButton",this._showActivateButton))},_editToolbarEvents:function(){var t=s.hitch(this,function(t){var e="",s=t.routeResults?t.routeResults[0]:null;if(s&&s.route){var i=s.route.attributes,o=this.routeParams.travelMode;if(o){e+="<b>"+o.name+"</b> "+b.widgets.directions.toNearbyStops+": ";var r=void 0!==i["Total_"+o.timeAttributeName]?this._formatTime(i["Total_"+o.timeAttributeName]):"",n=(void 0!==i["Total_"+o.distanceAttributeName]?this._formatDistance(i["Total_"+o.distanceAttributeName],!1,o.distanceAttributeName):"")+(r?" &middot; "+r:"");e+=n}else e=this._formatArbitraryCostsForRouteTooltip(i)}this._handle._showTooltip(e)}),e=s.hitch(this,function(i,o){var r=new D,n=this._handle,a=this.map.toScreen(n._origPoint).offset(i.transform.dx,i.transform.dy);if(i.origMapPoint||(i.origMapPoint=this.map.toMap(a)),f.set(n._tooltip,"left",a.x+"px"),f.set(n._tooltip,"top",a.y+"px"),clearTimeout(n._solveTimeout),this._solveInProgress||!this._requestQueueTail.isFulfilled())n._solveTimeout=setTimeout(function(){e(i,o).always(r.resolve)},100);else if(n._isStopIcon){var h=i.graphic._index,c=this.stops[h],l={name:c.name,extent:c.extent,feature:new R(c.feature.toJson())};l.feature.setGeometry(i.origMapPoint),this._modifiedWaypointIndex=this._isStopAWaypoint(this.stops[h])?h:null,this._incrementalSolveStopRange={start:Math.max(0,h-1),end:Math.min(this.stops.length-1,h+1)},this.updateStop(l,h,o).always(s.hitch(this,function(e){n._solveTimeout=null,e.routeResults&&t(e),r.resolve()}))}else r.resolve();return r.promise});this._onEvents.push(p(this.editToolbar,"graphic-click",s.hitch(this,function(t){if(t.graphic.attributes.isWaypoint)!t.graphic._isStopIcon||this._moveInProgress||this._solveInProgress||(this._handle._remove(),this._moveInProgress=!0,this.removeStop(t.graphic._index,!0).always(s.hitch(this,function(){this._moveInProgress=!1})));else{var e=this.get("map").infoWindow;e&&(e.setFeatures([t.graphic]),e.show(t.graphic.geometry))}}))),this._onEvents.push(p(this.editToolbar,"graphic-move-start",s.hitch(this,function(t){this._blurGeocoders(),this._moveInProgress=!0,this._removeEmptyStops(),this.routeParams.returnDirections=!1,this.routeParams.returnRoutes=!0;var e=t.graphic;e._origPoint=new U(e.geometry.toJson()),e._maxDeviation=0,e._solveHasHappened=!1,this.map.disableMapNavigation()}))),this._onEvents.push(p(this.editToolbar,"graphic-move-stop",s.hitch(this,function(t){this.map.enableMapNavigation(),this.routeParams.returnDirections=!0,this.routeParams.returnRoutes=!1,this._handle._isStopIcon&&this._handle._solveHasHappened?this._handle.attributes.isWaypoint?e(t,!0).always(s.hitch(this,function(){this._moveInProgress=!1,this._handle._isStopIcon=!0,this._handle._remove(),this._showLoadingSpinner()})):(clearTimeout(this._handle._solveTimeout),this._handle._solveTimeout=null,this._reverseGeocode(new R(t.graphic.toJson())).then(s.hitch(this,function(e){this._setReverseGeocode(e,e.feature.geometry,t.graphic._index).always(s.hitch(this,function(){this._moveInProgress=!1,this._handle._remove(),this._showLoadingSpinner()}))}))):this._moveInProgress=!1}))),this._onEvents.push(p(this.editToolbar,"graphic-move",s.hitch(this,function(t){var s=this._handle,i=t.transform;if(i.dx&&i.dy&&(t.graphic._maxDeviation=Math.max(s._maxDeviation,Math.sqrt(i.dx*i.dx+i.dy*i.dy))),s._maxDeviation>10)if(s._solveHasHappened=!0,t.graphic===s&&s.attributes.isWaypoint&&!s._isStopIcon)this.set("optimalRoute",!1),s._index+=.5,s._isStopIcon=!0,t.graphic._stopIndex=s._index,this._incrementalSolveStopRange={start:Math.max(0,s._index-1),end:Math.min(this.stops.length,s._index+1)},this.addStop({name:this._waypointName,feature:new R(s.geometry,s.symbol,{isWaypoint:!0,CurbApproach:3})},t.graphic._stopIndex);else{var o=t.graphic.getDojoShape();o&&o.moveToFront(),e(t)}})))},_isStopAWaypoint:function(t){return t&&t.feature&&t.feature.attributes&&t.feature.attributes.isWaypoint},_getStopCount:function(){var t,e=0;for(t=0;t<this.stops.length;t++)e+=!this._isStopAWaypoint(this.stops[t])&&this.stops[t].name?1:0;return e},_getWaypointCount:function(){var t,e=0;for(t=0;t<this.stops.length;t++)e+=this._isStopAWaypoint(this.stops[t])?1:0;return e},_decorateUngeocodedStop:function(t){var e=new D,i=function(s,i){e.resolve({name:void 0===s?b.widgets.directions.unlocatedStop:s.toFixed(6)+" "+i.toFixed(6),feature:t})};if(t.geometry)if(t.geometry.spatialReference&&4326!==t.geometry.spatialReference.wkid)if(this.map&&this.map.spatialReference&&this.map.spatialReference.isWebMercator()){var o=A.xyToLngLat(t.geometry.x,t.geometry.y);i(o[0],o[1])}else if(this._geometryService){var r=new re;r.outSR=new O(4326),r.geometries=[t.geometry],this._geometryService.project(r).then(s.hitch(this,function(e){e&&e.length?i(e[0].x,e[0].y):i(t.geometry.x,t.geometry.y)}),s.hitch(this,function(){i()}))}else i(t.geometry.x,t.geometry.y);else i(t.geometry.x,t.geometry.y);else i();return e.promise},_trafficLayerUpdate:function(){var t=arguments[1],e=arguments[2],s=this.get("map");t&&this._trafficLayerAdded&&(s.removeLayer(t),this._trafficLayerAdded=!1),e&&this.get("traffic")&&!this._trafficLayerAdded&&(s.addLayer(e),e.show(),this._trafficLayerAdded=!0)},_routeTaskError:function(t){var e=b.widgets.directions.error.routeTask,s=t.details;s&&1===s.length&&("The distance between any inputs must be less than 50 miles (80 kilometers) when walking."===s[0]?e=b.widgets.directions.error.maxWalkingDistance:"Driving a truck is currently not supported outside of North America and Central America."===s[0]&&(e=b.widgets.directions.error.nonNAmTruckingMode)),this._resultError(e),this.onDirectionsFinish(t)},_resultError:function(t){var e="";if(this.errors.push(t),e+='<div class="'+this._css.routesErrorClass+'">',this.errors.length){e+="<ul>";for(var s=0;s<this.errors.length;s++)e+="<li>"+this.errors[s]+"</li>";e+="</ul>"}e+="</div>",this._errorNode&&(this._errorNode.innerHTML=e),this.onError(t)},_getUnits:function(t){switch(t){case"esriNAUKilometers":case x.KILOMETERS:return"KILOMETERS";case"esriNAUMeters":case x.METERS:return"METERS";case"esriNAUNauticalMiles":case x.NAUTICAL_MILES:return"NAUTICAL_MILES";case"esriNAUMiles":case x.MILES:return"MILES";default:return t}},_createRouteTask:function(){var t=new D;return this.set("routeTask",new Q(this.get("routeTaskUrl"))),this._createRouteParams(),this.routeTask.getServiceDescription(this.travelModesServiceUrl,this.doNotFetchTravelModesFromOwningSystem).then(s.hitch(this,function(e){e.networkDataset?(this.set("serviceDescription",e),e.serviceLimits&&e.serviceLimits.Route_MaxStops&&this.set("maxStops",e.serviceLimits.Route_MaxStops),t.resolve()):(this._resultError(b.widgets.directions.error.cantFindRouteServiceDescription),t.reject(b.widgets.directions.error.cantFindRouteServiceDescription))}),s.hitch(this,function(){this._resultError(b.widgets.directions.error.cantFindRouteServiceDescription),t.reject(b.widgets.directions.error.cantFindRouteServiceDescription),this.mapClickActive=!1,this._activate()})),t.promise},_createSearchSourceDDL:function(){if(!this._searchSourceSelector&&this._globalGeocoder&&this._globalGeocoder.sources&&this._globalGeocoder.sources.length>1){for(var t=s.hitch(this,function(t){this._searchSourceSelector.domNode.blur(),this._globalGeocoder.set("activeSourceIndex",t);for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].set("activeSourceIndex",t)}),e=[{value:"all",label:b.widgets.Search.main.all,selected:!0}],i=0;i<this._globalGeocoder.sources.length;i++)e.push({value:String(i),label:this._globalGeocoder.sources[i].name});this._searchSourceSelector=new h({className:"esriSearchSourcesDDL",style:"width:100%;",options:e},this._searchSourceSelectorContainer),this._searchSourceSelector.startup(),this._searchSourceSelector.on("change",t),t("all"),this._searchSourceSelector.domNode.style.width=""}else this._globalGeocoder.sources.length<2&&(this._searchSourceContainerNode.style.display="none")},_createTravelModesDDL:function(){this._travelModeSelector||(this._travelModeSelector=new h({className:"esriTravelModesDDL",style:"width:100%;"},this._travelModeSelectorContainer),this._travelModeSelector.startup(),this._travelModeSelector._interractive=!0,this._travelModeSelector.on("change",s.hitch(this,function(t){this._travelModeSelector._interractive&&this._enqueue(function(){return this.clearErrors(),this._setTravelMode(t)})})))},_setupTravelModes:function(){var t=this.get("serviceDescription"),e=t.supportedTravelModes,i=new D;if(e&&e.length&&this._travelModeSelector){for(var o=e[0].name,r=[],n=0;n<e.length;n++){for(var a="AUTOMOBILE"===e[n].type?"Driving":"TRUCK"===e[n].type?"Trucking":"WALK"===e[n].type?"Walking":"Other",h="",u=t.networkDataset.networkAttributes,d=0;d<u.length;d++){var p=u[d];if(p.name===e[n].impedanceAttributeName){"esriNAUCentimeters"===p.units||"esriNAUDecimalDegrees"===p.units||"esriNAUDecimeters"===p.units||"esriNAUFeet"===p.units||"esriNAUInches"===p.units||"esriNAUKilometers"===p.units||"esriNAUMeters"===p.units||"esriNAUMiles"===p.units||"esriNAUMillimeters"===p.units||"esriNAUNauticalMiles"===p.units||"esriNAUYards"===p.units?h="Distance":("esriNAUDays"===p.units||"esriNAUHours"===p.units||"esriNAUMinutes"===p.units||"esriNAUSeconds"===p.units)&&(h="Time");break}}r.push({id:e[n].name,label:'<div class="esriTravelModesDirectionsIcon esriTravelModesType'+a+h+'">&nbsp;</div><div class="esriTravelModesTypeName">'+e[n].name+"</div>"}),!t.defaultTravelMode||e[n].id!==t.defaultTravelMode&&e[n].itemId!==t.defaultTravelMode||(o=e[n].name)}this._showTravelModesOption(),this._travelModeSelector.setStore(new l({objectStore:new c({data:r})})),this._travelModeSelector._interractive=!1,this._travelModeSelector.setValue(o),this._setTravelMode(o).always(s.hitch(this,function(){this._travelModeSelector._interractive=!0,i.resolve()}))}else this.set("showTravelModesOption",!1),i.resolve();return i.promise},_createPrintTask:function(){this.printTaskUrl=this._usingAGOL()?this.printTaskUrl:this.defaults.printTaskUrl,this._printService=this.printTaskUrl?new te(this.printTaskUrl,{async:!1}):null;var t=new se;t.exportOptions={width:670,height:750,dpi:96},t.format="PNG32",t.layout="MAP_ONLY",t.preserveScale=!1,t.showAttribution=!1;var e=new ee;e.map=this.map,e.outSpatialReference=this.map.spatialReference,e.template=t,this._printParams=e},_createGeometryTask:function(){this._geometryService=null,this._usingAGOL()?this._geometryService=new Y(this.geometryTaskUrl):(this._geometryService=this.defaults.geometryTaskUrl?new Y(this.defaults.geometryTaskUrl):oe.defaults.geometryService,this.geometryTaskUrl=this._geometryService?this._geometryService.url:null)},_showTravelModesOption:function(){var t=this.get("serviceDescription"),e=this.showTravelModesOption&&t&&t.supportedTravelModes&&t.supportedTravelModes.length&&!this.doNotFetchTravelModesFromOwningSystem;f.set(this._travelModeContainerNode,"display",e?"block":"none")},_showMilesKilometersOption:function(){f.set(this._agolDistanceUnitsNode,"display",this.showMilesKilometersOption?"block":"none")},_showClearButton:function(){f.set(this._clearDirectionsButtonNode,"display",this.showClearButton?"inline-block":"none")},_showActivateButton:function(){f.set(this._activateButtonNode,"display",this.showActivateButton?"inline-block":"none"),this.showActivateButton||this.deactivate()},_createRouteParams:function(){var t={outputGeometryPrecision:0,outputGeometryPrecisionUnits:"esriMeters",restrictUTurns:"esriNFSBAtDeadEndsOnly"},e={returnDirections:!0,returnRoutes:!1,outputLines:"esriNAOutputLineTrueShape",preserveFirstStop:!0,preserveLastStop:!0,directionsOutputType:"complete",stops:new J,ignoreInvalidLocations:!0,doNotLocateOnRestrictedElements:!0,outSpatialReference:this.get("map").spatialReference};this.get("routeParams")||(this.routeParams={});var i=new Z;this.routeParams=s.mixin(i,t,this.get("routeParams"),e)},_markWPsForRemovalAfterUserChangedStopSequence:function(t,e){for(var s=t-1,i=[];s>=0&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s--;for(s=t+1;s<this.stops.length&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s++;if(e>t)for(s=e+1;s<this.stops.length&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s++;else for(s=e-1;s>=0&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s--;return i},_removeSomeWaypoints:function(t){for(var e=new D,s=[],i=0;i<t.length;i++){var r=o.indexOf(this.stops,t[i]);r>-1&&s.push(this._removeStop(r,!0,!0))}return L(s).always(e.resolve),e.promise},_modifyStopSequence:function(t,e){var i=this._dnd.getAllNodes(),o=new D;if(i.length)if(this._removeLocateButtonVisibilityEvents(),arguments.length&&void 0!==t)if(t>=0&&e>=0&&t<this.stops.length&&e<this.stops.length&&t!==e){var r=this._markWPsForRemovalAfterUserChangedStopSequence(t,e),n=this.stops.splice(t,1),a=[];this.stops.splice(e,0,n[0]);for(var h=0;h<this.stops.length;h++)a.push(this._updateStop(this.stops[h],h));a.push(this._removeSomeWaypoints(r)),L(a).always(s.hitch(this,function(){this._solveAndZoom().always(o.resolve)}))}else o.reject("Invalid From and To values.");else i.reverse(),this._dnd.clearItems(),this._dnd.insertNodes(!1,i),this._dnd.sync(),this._sortGeocoders(),this.setListIcons(),this._solveAndZoom().always(o.resolve);else o.resolve();return o.promise},_setMenuNodeValues:function(){var t=this.get("optimalRoute");this._findOptimalOrderNode&&y.set(this._findOptimalOrderNode,"checked",t);var e=this.get("returnToStart");this._returnToStartNode&&y.set(this._returnToStartNode,"checked",e);var s=this.get("traffic");this._useTrafficNode&&y.set(this._useTrafficNode,"checked",s);var i=this.get("directionsLengthUnits");switch(i){case x.KILOMETERS:y.set(this._useKilometersNode,"checked",!0),y.set(this._useMilesNode,"checked",!1);break;case x.MILES:y.set(this._useKilometersNode,"checked",!1),y.set(this._useMilesNode,"checked",!0)}this._showMilesKilometersOption(),this._showClearButton()},_optionsMenu:function(){if(this._useTrafficItemNode&&f.set(this._useTrafficItemNode,"display",this.get("showTrafficOption")?"block":"none"),this._returnToStartItemNode&&f.set(this._returnToStartItemNode,"display",this.get("showReturnToStartOption")?"block":"none"),this._findOptimalOrderItemNode&&f.set(this._findOptimalOrderItemNode,"display",this.get("showOptimalRouteOption")&&this._getStopCount()>3?"block":"none"),this.stops.length>=this.get("minStops"))v.add(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass);else{if(v.remove(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass),this._optionsMenuNode){var t=f.get(this._optionsMenuNode,"display");"block"===t&&this._toggleOptionsMenu()}this._configureRouteOptions()}},_stopsRemovable:function(){this._dnd.getAllNodes().length-this._getWaypointCount()>2?v.add(this._widgetContainer,this._css.stopsRemovableClass):v.remove(this._widgetContainer,this._css.stopsRemovableClass)},_checkMaxStops:function(){this.set("maxStopsReached",this.stops.length>=this.maxStops),this._showAddDestination()},_updateThemeWatch:function(){var t=arguments[1],e=arguments[2];v.remove(this.domNode,t),v.add(this.domNode,e)},_toggleOptionsMenu:function(){if(this._optionsMenuNode){var t=f.get(this._optionsMenuNode,"display");"block"===t?(f.set(this._optionsMenuNode,"display","none"),this._optionsButtonNode.innerHTML=b.widgets.directions.showOptions):(f.set(this._optionsMenuNode,"display","block"),this._optionsButtonNode.innerHTML=b.widgets.directions.hideOptions)}},_showToolbar:function(){v[this.stops.length<this.maxStops&&this.canModifyStops||this.canModifyWaypoints?"add":"remove"].call(M,this._widgetContainer,this._css.addStopsClass)},_showAddDestination:function(){this._showToolbar(),this._addDestinationNode.style.display=this.stops.length<this.maxStops&&this.canModifyStops?"inline":"none"},_showMapClickActiveButton:function(){this._showToolbar(),this._activateButtonNode.style.display=this.canModifyStops||this.canModifyWaypoints?"inline-block":"none"},_getAbsoluteUrl:function(e){return e=t.toUrl(e),/^https?\:/i.test(e)?e:/^\/\//i.test(e)?window.location.protocol+e:/^\//i.test(e)?window.location.protocol+"//"+window.location.host+e:e},_getManeuverImage:function(t){if(t){var e="./images/Directions/maneuvers/",s=".png";return"esriDMTStop"===t||"esriDMTDepart"===t?"":this._getAbsoluteUrl(e+t+s)}return""},_loadPrintDirections:function(t){var e=this.get("printTemplate"),i=new D;this.directionsLengthUnits!==this.routeParams.directionsLengthUnits?this.getDirections().then(i.resolve):i.resolve(),i.then(s.hitch(this,function(){if(!e){var i,r=this._getAbsoluteUrl("./css/Directions.css"),n=this._getAbsoluteUrl("./css/DirectionsPrint.css"),a=this._getAbsoluteUrl("./images/Directions/print-logo.png");i=m.isBodyLtr()?"ltr":"rtl",e="",e+="<!DOCTYPE HTML>",e+='<html lang="en" class="'+this.get("theme")+'" dir="'+i+'">',e+="<head>",e+='<meta charset="utf-8">',e+='<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">',e+="<title>"+this.get("directions").routeName+"</title>",e+='<link rel="stylesheet" media="screen" type="text/css" href="'+r+'" />',e+='<link rel="stylesheet" media="print" type="text/css" href="'+n+'" />',e+="</head>",e+='<body class="'+this._css.esriPrintPageClass+'">',e+='<div class="'+this._css.esriPrintBarClass+'">',e+='<div class="'+this._css.esriCloseButtonClass+'" title="'+b.common.close+'" onclick="window.close();">'+b.common.close+"</div>",e+='<div id="printButton" class="'+this._css.esriPrintButtonClass+'" title="'+b.widgets.directions.print+'" onclick="window.print();">'+b.widgets.directions.print+"</div>",e+="</div>",e+='<div class="'+this._css.esriPrintMainClass+'">',e+='<div class="'+this._css.esriPrintHeaderClass+'">',e+='<img class="'+this._css.esriPrintLogoClass+'" src="'+a+'" />',e+='<div class="'+this._css.esriPrintNameClass+'">'+this.get("directions").routeName+"</div>",e+='<div class="'+this._css.esriPrintLengthClass+'">'+this._formatDistance(this.get("directions").totalLength,!0)+" &middot; "+this._formatTime(this.get("directions").totalTime)+"</div>",t&&(e+='<div id="divMap" class="esriPrintMap esriPrintWait"></div>',e+='<hr class="esriNoPrint"/>'),e+='<div id="print_helper"></div>',e+='<textarea onkeyup="document.getElementById(\'print_helper\').innerHTML=this.value;" id="print_area" class="'+this._css.esriPrintNotesClass+'" placeholder="'+b.widgets.directions.printNotes+'"></textarea>',e+='<div class="'+this._css.clearClass+'"></div>',e+="</div>",e+='<div class="'+this._css.esriPrintDirectionsClass+'">',e+="<table>",e+="<tbody>",o.forEach(this.get("directions").features,s.hitch(this,function(t,s){var i,o=this.get("directions").strings[s]||[];if("esriDMTDepart"===t.attributes.maneuverType||"esriDMTStop"===t.attributes.maneuverType)for(i=0;i<this.stops.length;i++)this.stops[i]&&this.stops[i].name&&o.push({string:this.stops[i].name});if(o){var r=t.attributes.text;for(i=0;i<o.length;i++)r=this._boldText(r,o[i].string);t.attributes.formattedText=r}else t.attributes.formattedText=t.attributes.text;var n="";this.get("directions").features.length===s+1&&(n=this._css.routeLastClass),t.attributes&&(t.attributes.step=s+1),e+='<tr class="'+n+'">',e+='<td class="'+this._css.routeIconColumnClass+'">';var a=this._getManeuverImage(t.attributes.maneuverType),h=this._getLetter(t._associatedStop);a?e+='<img src="'+a+'" />':h&&(e+='<div class="'+this._css.esriPrintStopLabelClass+'">',e+=h,e+="</div>"),e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">',e+="<div><strong>"+w.format(t.attributes.step)+".</strong> "+t.attributes.formattedText+"</div>",e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">';var c=this._formatTime(t.attributes.time),l=this._formatDistance(t.attributes.length,!1)+(c?" &middot; "+c:"");e+='<div class="'+this._css.routeLengthClass+'">'+l+"</div>",e+="</td>",e+="</tr>"})),e+="</tbody>",e+="</table>",e+="</div>",e+='<div class="'+this._css.esriPrintFooterClass+'">',e+="<p>"+b.widgets.directions.printDisclaimer+"</p>",e+="</div>",e+="</div>",e+="</body>",e+="</html>"}this._printWindow.document.open("text/html","replace"),this._printWindow.document.write(e),this._printWindow.document.close()}))},_printDirections:function(){var e=screen.width/2,i=screen.height/1.5,o=screen.width/2-e/2,r=screen.height/2-i/2,n="toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=yes, resizable=yes, width="+e+", height="+i+", top="+r+", left="+o;this.get("printPage")?(window.directions=this.get("directions"),window.open(this.get("printPage"),"directions_widget_print",n,!0)):(this._printWindow=window.open("","directions_widget_print",n,!0),this._loadPrintDirections(!!this._printService),this._printService&&t(["dojo/_base/window"],s.hitch(this,function(t){this.zoomToFullRoute().then(s.hitch(this,function(){this._printService.execute(this._printParams,s.hitch(this,function(e){t.withDoc(this._printWindow.document,function(){var t=g.byId("divMap");t&&(v.remove(t,"esriPrintWait"),v.add(t,"esriPageBreak"),M.create("img",{src:e.url,"class":"esriPrintMapImg"},t))})}),s.hitch(this,function(e){t.withDoc(this._printWindow.document,function(){var t=g.byId("divMap");t&&v.remove(t,"esriPrintWait")}),console.error("Error while calling print service:\n "+e)}))}))})))}});return d("extend-esri")&&s.setObject("dijit.Directions",ne,E),ne});