// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/window","dojo/dom-class","dojo/dom-style","dojo/dom-attr","dojo/string","dojo/on","dojo/aspect","dojo/has","dojo/dom","dojo/dom-construct","dojo/mouse","dojo/query","dojo/parser","dijit/registry","dijit/TooltipDialog","dijit/popup","dojo/promise/all","dojo/Deferred","dgrid/Grid","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/util/mouse","dgrid/util/touch","put-selector/put","dojo/store/Observable","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_FocusMixin","dijit/form/Select","../arcgis/Portal","../Evented","../PluginTarget","dojo/i18n!../nls/jsapi","./_RefreshMixin","../kernel","../lang","../config","../geometry/webMercatorUtils","../tasks/GeometryService","../SpatialReference"],function(t,e,i,s,r,o,n,a,h,c,l,d,u,g,_,p,m,f,y,x,v,w,T,P,b,j,S,I,D,N,A,C,M,k,q,R,E,U,B,F,O,G,L,Q,$,V,W){var K=t(null,{idProperty:"id",constructor:function(e){t.safeMixin(this,e)},get:function(t,i){return U.PortalUtil.request(this.portalUrl+"content/items/"+t,i).then(function(t){return new U.PortalItem(e.mixin(t,{portal:this.portal}))})},getIdentity:function(t){return t[this.idProperty]},query:function(t,i){var s=e.isObject(t)?t:{q:t};if(i&&(s=e.mixin(s,{num:i.count,start:(i.start||0)+1}),i.sort&&i.sort.length)){var r=i.sort[0];s=e.mixin(s,{sortField:encodeURIComponent("created"===r.attribute?"uploaded":r.attribute),sortOrder:r.descending?"desc":"asc"})}i.useExtent&&i.extent&&(s.bbox=i.extent);var o=this.portal.queryItems(s,!0).then(function(t){return t.results.total=t.total,t.results});return U.PortalResult(o)}}),H=t([M,k,q,F,R],{templateString:'<div><p data-dojo-attach-point="messageNode" class="hide"></p><div style="width:100%" class="esriLeadingMargin1"><select id="${id}_categorySelect"class="categorySelect"></select><div id="${id}_search"class="esriTrailingMargin2 esriFloatTrailing searchBar"><input class="esriSearchBox dijitTextBox" type="text" placeholder:\'${i18n.searchFor}\'></div></div><div id="${id}_grid"class="dgrid-autoheight"></div><br /></div>',_galleryTemplate:"<div style='opacity:1;' class='grid-item gallery-view'>${item:_formatItemTitle}${item:_formatThumbnail}</div>",_popupTemplate:'<div class="esriBrowsePopup quiet-scroll"><p>{summary}</p></div>',baseClass:"esriBrowseItemsCtr",closePopupPerRow:!0,postMixInProperties:function(){this.inherited(arguments),this.i18n={},e.mixin(this.i18n,O.gallery)},postCreate:function(){this.inherited(arguments),this.self?(this._portal=new U.Portal({url:this.portalUrl,self:this.self}),this._portal.on("load",e.hitch(this,this._fetchData))):(this._portal=new U.Portal(this.portalUrl),this._portal.signIn().then(e.hitch(this,this._fetchData)))},destroy:function(){this.inherited(arguments),this._grid&&this._grid.destroy(),this._img_connect.remove(),this._img_connect_error.remove(),this._queryTimer&&clearTimeout(this._queryTimer),this._grid=this._portal=null},_setPortalUrlAttr:function(t){this.portalUrl=t},_setSelfAttr:function(t){this.self=t},_setPluginAttr:function(t){this.addPlugin(t)},_setMessageAttr:function(t){n.set(this.messageNode,"innerHTML",t),r.remove(this.messageNode,"hide")},_setCategoriesAttr:function(t){this.categories=t},_setDisabledAttr:function(t){var e=m.findWidgets(this.domNode).concat(m.findWidgets(this._content));i.forEach(e,function(e){e.set("disabled",t)}),r[t?"add":"remove"](this._interval.domNode,"dijitTextBoxDisabled")},_setSortAttr:function(t){this.sortAttribute=t},_setSortDescendingAttr:function(t){this.sortDescending=t},_getSelectionAttr:function(){var t=this._grid.selection;for(var e in t)if(t.hasOwnProperty(e))break;return e&&this._grid.row(e).data},_setGalleryTemplateAttr:function(t){Q.isDefined(t)&&(this._galleryTemplate=t)},_setFormatThumbnailAttr:function(t){Q.isDefined(t)&&"function"==typeof t&&(this._formatThumbnail=t)},_setFormatItemTitleAttr:function(t){Q.isDefined(t)&&"function"==typeof t&&(this._formatItemTitle=t)},_setItemsPerPageAttr:function(t){this._set("itemsPerPage",t)},_setPagingLinksAttr:function(t){this._set("pagingLinks",t)},_setCategoryTypeAttr:function(t){this._set("categoryType",t)},_getQueryAttr:function(){return this._grid&&this._grid.get("query")},_setQueryAttr:function(t){this._grid&&(this._grid.set("query",t),this.reset())},_setSelectedCategoryAttr:function(t){this._set("selectedCategory",t)},_setClosePopupPerRowAttr:function(t){this._set("closePopupPerRow",t)},_setExtentAttr:function(t){t&&this._set("extent",this._extentToString(t))},_setUseExtentAttr:function(t){this._set("useExtent",t)},_setFetchTimeoutAttr:function(t){this._set("fetchTimeout",t)},_validate:function(){var t=this.get("selection");return!!t},reset:function(){this._grid&&(this._categorySelect&&(this._categorySelect.reset(),this.get("selectedCategory")?(this._origQuery=null,this._categorySelect.set("value",this.get("selectedCategory"))):(this._origQuery=null,this._categorySelect.set("value",this.categories[0].value))),_(".esriSearchBox",d.byId(this.id+"_search")).forEach(function(t){n.set(t,"value","")}))},_showPopup:function(t){if(!this._isInsideTooltipDialog){this._closePopup();var i=this._grid.row(t),s=_("img",i.element)[0],r={summary:i.data.snippet};r&&r.summary&&(this._tooltip=new f({content:e.replace(this._popupTemplate,r),onMouseEnter:e.hitch(this,function(){this._isInsideTooltipDialog=!0}),onMouseLeave:e.hitch(this,function(){this._isInsideTooltipDialog=!1,this._closePopup(t)})}),y.open({className:"esriBrowsePopupCtr",popup:this._tooltip,around:s,orient:["after-centered","before-centered"]}),this._onCloseConnect=_(".dijitDialogCloseIcon",this._tooltip.domNode).on("click",e.hitch(this,function(t){t.preventDefault(),this._closePopup()})))}},_closePopup:function(){this._tooltip&&(this._onCloseConnect.remove(),y.close(this._tooltip),this._tooltip.destroyRecursive(),this._tooltip=this._onCloseConnect=void 0)},_clearQueryTimeout:function(){clearTimeout(this._queryTimer)},_createGrid:function(){var i=t([w,T,j,G,P]),s=new C(new K({portal:this._portal})),r=this._currentFilter,o=e.hitch(this,function(t){t.snippet=t.snippet||"";var e=A("div"),i=a.substitute(this._galleryTemplate,{item:t,i18n:this.i18n},null,this);return u.place(i,e),e}),c={};this.get("useExtent")&&(c.extent=this.get("extent"),c.useExtent=this.get("useExtent")),this._grid=new i({store:s,className:"dgrid-autoheight",query:r,selectionMode:"single",pagingLinks:this.get("pagingLinks")||2,rowsPerPage:this.get("itemsPerPage")||6,loadingMessage:"Loading items...",showLoadingMessage:!1,renderRow:o,noDataMessage:this.i18n.noItemsToDisplay,sort:[{attribute:"title"}],queryOptions:c},this.id+"_grid"),this._grid.startup(),this.categories&&this.categories.length>0&&(this._categorySelect=new E({options:this.categories,sortByLabel:!1,"class":"categorySelect"},this.id+"_categorySelect"),this.own(this._categorySelect.on("change",e.hitch(this,function(t){var e;this._closePopup(),this._origQuery||(this._origQuery=this._grid.get("query")),e=this._origQuery,t&&(e+=" AND ("+this.get("categoryType")+":"+t+")"),this._fetchItems(e)})))),this.own(this._grid.on(D.enterRow,e.hitch(this,function(t){this._showPopup(t)})),this._grid.on(D.leaveRow,e.hitch(this,function(t){this.get("closePopupPerRow")&&this._closePopup(t)})),h(_(".dgrid-footer,.dgrid-header",this._grid.domNode),g.leave,e.hitch(this,function(t){this._closePopup(t)})),this._grid.on("dgrid-refresh-complete",e.hitch(this,function(t){this._closePopup(t),_(".dgrid-footer",this.domNode)[this._grid._total<=this._grid.rowsPerPage?"addClass":"removeClass"]("hide")})),this._grid.on("refresh",e.hitch(this,function(){this._img_connect&&(this._img_connect.remove(),this._img_connect_error.remove(),this._img_connect=null,this._img_connect_error=null),this._img_connect=_(".grid-item-thumb",this._grid.domNode).on("load",e.hitch(this,function(t){var e=this._grid.row(t);e&&e.element&&_(".grid-item",e.element).addClass("fadeIn").style("opacity","1")})),this._img_connect_error=_(".grid-item-thumb",this._grid.domNode).on("error",e.hitch(this,function(t){n.set(t.target,"src",this._portal.staticImagesUrl+"/desktopapp.png")}))})),this._grid.on("dgrid-select,dgrid-deselect",e.hitch(this,function(){var t={selection:this.get("selection")};this.emit("select-change",t)})),h(d.byId(this.id+"_search"),"keyup",e.hitch(this,function(t){t.preventDefault(),this._closePopup(),this._clearQueryTimeout(),this._queryTimer=setTimeout(e.hitch(this,function(){this._fetchItems(this._currentFilter,n.get(t.target,"value"))}),this.searchKeypressDelay||250)})),this.watch("extent",e.hitch(this,function(){this._grid.queryOptions.extent=this.get("extent"),this._grid.queryOptions.useExtent=this.get("useExtent"),this._grid.refresh()})),this.watch("useExtent",e.hitch(this,function(t,e,i){this._grid.queryOptions.extent=this.get("extent"),this._grid.queryOptions.useExtent=i,this._grid.refresh()})))},_fetchData:function(){return this._user=this._portal.getPortalUser(),this.plugIn.fetchData()},_fetchItems:function(t,i){var s={sort:[{attribute:this.sortAttribute||"title",descending:this.sortDescending||!1}]},r=i?" title:"+i+"* ":"",o=new v;return this.get("extent")&&(s.extent=this.extent),s.useExtent=this.get("useExtent"),setTimeout(e.hitch(this,function(){this._currentFilter=t,this._grid?this._grid.set("query",this._currentFilter+r,s):this._createGrid(),o.resolve(this._grid)}),this.fetchTimeout||60),o},_formatThumbnail:function(t){var e=t.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png";return"<img class='grid-item-thumb' width='187px' height='125px' alt='' src='"+e+"'>"},_formatItemTitle:function(t){return"<h5>"+(t.title||t.name||"<No Title>")+"</h5>"},clear:function(){this._grid.clearSelection()},doProject:function(t,e){var i,s,r,o,n,a=[102113,102100,3857],h=new v;return r=function(t,e){!(t&&t.length>0&&t[0]&&"extent"==t[0].type)||isNaN(t[0].xmin)||isNaN(t[0].ymin)||isNaN(t[0].xmax)||isNaN(t[0].ymax)?t&&t.length>0&&t[0]&&"point"==t[0].type&&!isNaN(t[0].x)&&!isNaN(t[0].y)&&h.resolve(t,e):h.resolve(t,e)},null!=t.spatialReference.wkid&&4326==t.spatialReference.wkid&&null!=e.wkid&&this.contains(a,e.wkid)?(t.ymin=Math.max(t.ymin,-89.99),t.ymax=Math.min(t.ymax,89.99),i=V.geographicToWebMercator(t),s=i.spatialReference._getInfo(),s&&i.xmin>i.xmax&&(o=s.valid[1]-i.xmin,n=i.xmax-s.valid[0],o>n?i.xmax=s.valid[1]+n:i.xmin=s.valid[0]-o),i.spatialReference.wkid=e.wkid,h.resolve([i])):null!=t.spatialReference.wkid&&this.contains(a,t.spatialReference.wkid)&&null!=e.wkid&&4326==e.wkid?(i=V.webMercatorToGeographic(t),s=i.spatialReference._getInfo(),s&&i.xmin>i.xmax&&(o=s.valid[1]-i.xmin,n=i.xmax-s.valid[0],o>n?i.xmax=s.valid[1]+n:i.xmin=s.valid[0]-o),h.resolve([i])):(this.geometryService||(this.geometryService=new W($.defaults.geometryService)),this.geometryService.project([t],e,r)),h},contains:function(t,e){for(var i=t.length;i--;)if(t[i]===e)return!0;return!1},_extentToGCS:function(t){return t=t.shiftCentralMeridian(!0),V.webMercatorToGeographic(t)},_extentToString:function(t){var e="";return null!=t&&(t=this._extentToGCS(t),e=this._roundValue(t.xmin,1e4)+","+this._roundValue(t.ymin,1e4)+","+this._roundValue(t.xmax,1e4)+","+this._roundValue(t.ymax,1e4)),e},_roundValue:function(t,e){return Math.round(t*e)/e}});return l("extend-esri")&&e.setObject("dijit.BrowseItems",H,L),H});