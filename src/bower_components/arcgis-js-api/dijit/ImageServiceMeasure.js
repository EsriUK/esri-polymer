// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/i18n!../nls/jsapi","dojo/text!./templates/ImageServiceMeasure.html","dojo/has","../kernel","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","../toolbars/ImageServiceMeasureTool","dijit/form/DropDownButton","dijit/DropDownMenu","dijit/MenuItem","dijit/MenuSeparator","dijit/PopupMenuItem","dijit/RadioMenuItem","dijit/CheckedMenuItem","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../graphic","../geometry/Point","dojo/_base/Color","dojo/dom-class","dojo/_base/array","../tasks/ImageServiceMeasureParameters","../units","dojo/dom-construct","dijit/form/ToggleButton","dojo/html"],function(e,t,i,n,s,r,a,o,u,h,l,d,p,_,c,m,g,M,O,w,D,S,I,b,v,f,T,C,y,U){var E=e([a,o,u],{declaredClass:"esri.dijit.ImageServiceMeasure",templateString:n,widgetsInTemplate:!0,layer:null,map:null,layout:"dropDown",displayOperations:null,markerSymbol:null,lineSymbol:null,fillSymbol:null,displayMeasureResultInPopup:null,angularUnit:null,linearUnit:null,areaUnit:null,_supportedMeasureOperations:[],_supportedUnits:{},_currentGraphic:null,_defaultUnits:{angularUnit:"DECIMAL_DEGREES",linearUnit:"KILOMETERS",areaUnit:"SQUARE_KILOMETERS"},_desiredDropDownOrder:["OPERATION_POINT","OPERATION_DISTANCE_ANGLE","OPERATION_AREA_PERIMETER","OPERATION_CENTROID","OPERATION_BASE_TOP","OPERATION_TOP_TOP_SHADOW","OPERATION_BASE_TOP_SHADOW"],_map3DOperations:{OPERATION_POINT:"OPERATION_POINT_3D",OPERATION_DISTANCE_ANGLE:"OPERATION_DISTANCE_ANGLE_3D",OPERATION_AREA_PERIMETER:"OPERATION_AREA_PERIMETER_3D",OPERATION_CENTROID:"OPERATION_CENTROID_3D",OPERATION_BASE_TOP:"OPERATION_BASE_TOP",OPERATION_TOP_TOP_SHADOW:"OPERATION_TOP_TOP_SHADOW",OPERATION_BASE_TOP_SHADOW:"OPERATION_BASE_TOP_SHADOW"},_menu:null,_dropDownButton:null,_currentOperation:null,_activeMeasureOpMenuItem:null,_has3DOperations:!1,_enabled3DCheckbox:!1,_dropDownMenuItemMap:{},_toggleButtonMenuItemMap:{},_decimalDegreesConstantValue:"esriDUDecimalDegrees",_decimalDegreesConstantKeyword:"DECIMAL_DEGREES",constructor:function(t){e.safeMixin(this,t),this._setDefaultSymbols(),this._i18n=i},startup:function(){this.inherited(arguments)},postCreate:function(){this.map&&this.layer&&(this.measureToolbar=new h({map:this.map,layer:this.layer}),this.measureToolbar.on("draw-end",t.hitch(this,this._addGraphic)),this.measureToolbar.on("draw-start",t.hitch(this,this._onDrawStart)),this.measureToolbar.on("measure-end",t.hitch(this,this._addInfoWindow)),this.measureToolbar.on("unit-change",t.hitch(this,this._onUnitChange)),this._supportedMeasureOperations=this._getSupportedMeasureOperations(),this._has3DOperations=this._check3DSupported(),this._reorderMeasureOperations(),this._supportedUnits=this._getSupportedUnits(),this._setDefaultUnits()),this._checkValidLayoutValue(),this._supportedMeasureOperations.length>0?"dropDown"===this.layout?this._populateMeasureDropdown():"toolbar"===this.layout&&this._populateMeasureButtons():U.set(this.esriImageServiceMeasure,this._i18n.widgets.imageServiceMeasure.mensurationCapabilitiesAbsentText)},_checkValidLayoutValue:function(){"dropdown"===this.layout.toLowerCase()?this.layout="dropDown":"toolbar"===this.layout.toLowerCase()?this.layout="toolbar":(this.layout="dropDown",console.log("Invalid value for layout"))},_getUnitKeyword:function(e){var t,i=null;if(e===this._decimalDegreesConstantValue)i=this._decimalDegreesConstantKeyword;else for(t in T)T.hasOwnProperty(t)&&T[t]===e&&(i=t);return i||null},_setUnitKeyword:function(e,t){var i,n;return this[e]?(i=this._getUnitKeyword(this[e]),i?n=i:(n=this._defaultUnits[e],console.log("Incorrect "+t+" supplied. "+t+" set to default."))):n=this._defaultUnits[e],n},_setDefaultUnits:function(){this.linearUnit=this._setUnitKeyword("linearUnit","Linear Unit"),this.areaUnit=this._setUnitKeyword("areaUnit","Area Unit"),this.angularUnit=this._setUnitKeyword("angularUnit","Angular Unit"),this.measureToolbar.setLinearUnit(T[this.linearUnit]),this.measureToolbar.setAreaUnit(T[this.areaUnit]),this.measureToolbar.setAngularUnit(T[this.angularUnit])},_getSupportedMeasureOperations:function(){var e,t=[],i=this.displayOperations||this.measureToolbar.getSupportedMeasureOperations(),n=this.measureToolbar.getSupportedMeasureOperations();return v.forEach(i,function(i){for(e in f)f.hasOwnProperty(e)&&f[e]===i&&(v.indexOf(n,i)>-1?t.push(e):console.log(i+" is not supported by the service."))},this),t},_getSupportedUnits:function(){var e,t={},i=[],n=[],s=this.measureToolbar.getSupportedUnits();for(e in s)s.hasOwnProperty(e)&&(n=s[e],i=[],v.forEach(n,function(e){i.push(this._getUnitString(e))},this),t[e]=i);return t},_check3DSupported:function(){return this._isSupportedMeasureOperation("OPERATION_POINT_3D")||this._isSupportedMeasureOperation("OPERATION_DISTANCE_ANGLE_3D")||this._isSupportedMeasureOperation("OPERATION_AREA_PERIMETER_3D")||this._isSupportedMeasureOperation("OPERATION_CENTROID_3D")},_isSupportedMeasureOperation:function(e){return this._supportedMeasureOperations.indexOf(e)>-1},_reorderMeasureOperations:function(){var e=[];v.forEach(this._desiredDropDownOrder,function(t){this._supportedMeasureOperations.indexOf(t)>-1&&e.push(t)},this),this._supportedMeasureOperations=e},_setDefaultSymbols:function(){this.markerSymbol||(this.markerSymbol=new M,this.markerSymbol.setPath("M16,4.938c-7.732,0-14,4.701-14,10.5c0,1.981,0.741,3.833,2.016,5.414L2,25.272l5.613-1.44c2.339,1.316,5.237,2.106,8.387,2.106c7.732,0,14-4.701,14-10.5S23.732,4.938,16,4.938zM16.868,21.375h-1.969v-1.889h1.969V21.375zM16.772,18.094h-1.777l-0.176-8.083h2.113L16.772,18.094z"),this.markerSymbol.setColor(new I("#00FFFF"))),this.lineSymbol||(this.lineSymbol=new O(O.STYLE_SOLID,new I([255,0,0]),1.5)),this.fillSymbol||(this.fillSymbol=new w(w.STYLE_SOLID,new O(O.STYLE_DASHDOT,new I([255,0,0]),2),new I([255,255,0,.25])))},_populateMeasureDropdown:function(){var e,i,n,s;this._menu=new d,v.forEach(this._supportedMeasureOperations,function(i){e=new p({label:this._i18n.widgets.imageServiceMeasure.operationLabel[i],iconClass:f[i]}),e.on("click",t.hitch(this,this._onDropDownMenuItemClick,i,e)),this._menu.addChild(e),this._dropDownMenuItemMap[i]=e},this),i=new _,this._menu.addChild(i),this._has3DOperations&&(s=new g({label:this._i18n.widgets.imageServiceMeasure.measure3DLabel,checked:!1}),s.on("change",t.hitch(this,this._on3DCheckBoxChange)),this._menu.addChild(s),n=new _,this._menu.addChild(n)),this._addUnitsMenu(),this._dropDownButton=new l({dropDown:this._menu,"class":"esriImageServiceMeasureDropdownContainer"},this.measureDropDownContainer),this._dropDownButton.startup(),this._defaultOperation=this._supportedMeasureOperations[0],this._currentOperation=this._defaultOperation,this._toggleButton=new l({label:this._i18n.widgets.imageServiceMeasure.operationLabel[this._defaultOperation],iconClass:f[this._defaultOperation],"class":"esriImageServiceMeasureToggleButton",dropDown:new d({"class":"esriHiddenDropDownMenu"})},this.toggleButtonDiv),this._toggleButton.startup(),this._toggleButton.on("click",t.hitch(this,this._toggle))},_populateMeasureButtons:function(){var e,i,n,s;b.add(this.esriImageServiceMeasure,"esriImageServiceMeasureToolbarLayout"),b.add(this.measureButtonContainer,"esriImageServiceMeasureButtonContainer"),this._menu=new d,v.forEach(this._supportedMeasureOperations,function(i){s=C.create("div",{innerHTML:this._i18n.widgets.imageServiceMeasure.operationLabel[i]},this.measureButtonContainer),e=new y({showLabel:!1,checked:!1,label:this._i18n.widgets.imageServiceMeasure.operationLabel[i],iconClass:f[i],baseClass:"esriMeasureButton"},s),e.on("click",t.hitch(this,this._onButtonMenuItemClick,i)),this._toggleButtonMenuItemMap[i]=e},this),this._has3DOperations&&(n=new g({label:this._i18n.widgets.imageServiceMeasure.measure3DLabel,checked:!1}),n.on("change",t.hitch(this,this._on3DCheckBoxToolbarLayoutChange)),this._menu.addChild(n),i=new _,this._menu.addChild(i)),this._addUnitsMenu(),i=C.create("span",{innerHTML:"|"},this.measureButtonContainer),s=C.create("div",null,this.measureButtonContainer),this._dropDownButton=new l({dropDown:this._menu,label:this._i18n.widgets.imageServiceMeasure.settings,showLabel:!1,iconClass:"esriMensurationSettingsIcon","class":"esriMeasureSettingsButton"},s),this._dropDownButton.startup(),"false"!==this.displayMeasureResultInPopup&&this.displayMeasureResultInPopup!==!1&&this.displayMeasureResultInPopup||(this.measureResultContainer=C.create("div",{"class":"measureResultContainer"},this.esriImageServiceMeasure),this.esriMeasurementResultLabel=C.create("div",{innerHTML:this._i18n.widgets.imageServiceMeasure.infoWindowTitle,"class":"esriMeasurementResultLabel"},this.measureResultContainer),this.measureResultStringDiv=C.create("div",{"class":"esriMeasurementResultString"},this.measureResultContainer))},_addUnitsMenu:function(){var e,i,n,s,r,a;i=new d,v.forEach(this._supportedUnits.angularUnits,function(e){a=this._isCurrentAngularUnit(e),r=new m({group:"angularUnit",checked:a,label:this._i18n.widgets.imageServiceMeasure.unitLabel[e],"class":a?"esriSelectedOption":""}),a&&(this._currentAngularUnitMenuItem=r),r.on("click",t.hitch(this,this._onAngularUnitClick,e,r)),i.addChild(r)},this),e=new c({label:this._i18n.widgets.imageServiceMeasure.angularUnits,popup:i}),this._menu.addChild(e),n=new d,v.forEach(this._supportedUnits.linearUnits,function(e){a=this._isCurrentLinearUnit(e),r=new m({group:"linearUnit",checked:a,label:this._i18n.widgets.imageServiceMeasure.unitLabel[e],"class":a?"esriSelectedOption":""}),a&&(this._currentLinearUnitMenuItem=r),r.on("click",t.hitch(this,this._onLinearUnitClick,e,r)),n.addChild(r)},this),e=new c({label:this._i18n.widgets.imageServiceMeasure.linearUnits,popup:n}),this._menu.addChild(e),s=new d,v.forEach(this._supportedUnits.areaUnits,function(e){a=this._isCurrentAreaUnit(e),r=new m({group:"areaUnit",checked:a,label:this._i18n.widgets.imageServiceMeasure.unitLabel[e],"class":a?"esriSelectedOption":""}),a&&(this._currentAreaUnitMenuItem=r),r.on("click",t.hitch(this,this._onAreaUnitClick,e,r)),s.addChild(r)},this),e=new c({label:this._i18n.widgets.imageServiceMeasure.areaUnits,popup:s}),this._menu.addChild(e)},_on3DCheckBoxChange:function(e){var t=this._currentOperation.replace("_3D","");this._enabled3DCheckbox=e,this._dropDownButton.openDropDown(),this._activeMeasureOpMenuItem&&(this._activeMeasureOpMenuItem=null,this._onDropDownMenuItemClick(t,this._dropDownMenuItemMap[t]))},_on3DCheckBoxToolbarLayoutChange:function(e){this._enabled3DCheckbox=e,this._dropDownButton.openDropDown(),this._enabled3DCheckbox||(this._currentOperation=this._currentOperation.replace("_3D","")),this._currentOperation&&this._onButtonMenuItemClick(this._currentOperation)},_onDropDownMenuItemClick:function(e,t){var i=t.domNode;this._enabled3DCheckbox&&(e=this._map3DOperations[e]),this._disableMapNavigation(),this._removeDraws(),this._activeMeasureOpMenuItem?(b.remove(this._activeMeasureOpMenuItem.domNode,"esriSelectedOption"),b.add(i,"esriSelectedOption"),this._activeMeasureOpMenuItem=t,this._currentOperation=e,this._toggleButton.set({label:this._i18n.widgets.imageServiceMeasure.operationLabel[e],iconClass:f[e.replace("_3D","")]}),this.measureToolbar.activate(f[e]),this.measureToolbar.showDrawTooltip()):(this._activeMeasureOpMenuItem=t,b.add(i,"esriSelectedOption"),this._currentOperation=e,this._toggleButton.set({label:this._i18n.widgets.imageServiceMeasure.operationLabel[e],iconClass:f[e.replace("_3D","")]}),b.add(this._toggleButton._buttonNode,"esriCheckedMeasureButton"),this.measureToolbar.activate(f[e]),this.measureToolbar.showDrawTooltip())},_uncheckOtherButtons:function(e){var t;for(t in this._toggleButtonMenuItemMap)this._toggleButtonMenuItemMap.hasOwnProperty(t)&&t!==e&&this._toggleButtonMenuItemMap[t].set("checked",!1)},_onButtonMenuItemClick:function(e){this._removeDraws(),this._enabled3DCheckbox&&(e=this._map3DOperations[e]),this._uncheckOtherButtons(e.replace("_3D","")),this._currentOperation=e,this._toggleButtonMenuItemMap[e.replace("_3D","")].checked?(this._disableMapNavigation(),this.measureToolbar.activate(f[e]),this.measureToolbar.showDrawTooltip()):(this.measureToolbar.deactivate(),this._enableMapNavigation()),this.measureResultStringDiv&&U.set(this.measureResultStringDiv,"")},_isCurrentAngularUnit:function(e){return e===this.angularUnit?!0:!1},_isCurrentLinearUnit:function(e){return e===this.linearUnit?!0:!1},_isCurrentAreaUnit:function(e){return e===this.areaUnit?!0:!1},_onLinearUnitClick:function(e,t){b.remove(this._currentLinearUnitMenuItem.domNode,"esriSelectedOption"),b.add(t.domNode,"esriSelectedOption"),this._currentLinearUnitMenuItem=t,this.linearUnit=e,this.measureToolbar.setLinearUnit(T[e]),this._dropDownButton.openDropDown()},_onAngularUnitClick:function(e,t){b.remove(this._currentAngularUnitMenuItem.domNode,"esriSelectedOption"),b.add(t.domNode,"esriSelectedOption"),this._currentAngularUnitMenuItem=t,this.angularUnit=e,this.measureToolbar.setAngularUnit(T[e]),this._dropDownButton.openDropDown()},_onAreaUnitClick:function(e,t){b.remove(this._currentAreaUnitMenuItem.domNode,"esriSelectedOption"),b.add(t.domNode,"esriSelectedOption"),this._currentAreaUnitMenuItem=t,this.areaUnit=e,this.measureToolbar.setAreaUnit(T[e]),this._dropDownButton.openDropDown()},_onDrawStart:function(){this._removeDraws()},_addGraphic:function(e){var t,i,n=e.geometry;this.measureToolbar.hideDrawTooltip(),t="point"===n.type?this.markerSymbol:"line"===n.type||"polyline"===n.type?this.lineSymbol:this.fillSymbol,this._removeDraws(),i=new D(n,t),this._currentGraphic=i,this.map.graphics.add(i)},_addInfoWindow:function(e){var t=this._measureResultString(e.measureResult,e.error);"dropDown"===this.layout||"toolbar"===this.layout&&("true"===this.displayMeasureResultInPopup||this.displayMeasureResultInPopup===!0)?this._displayInfoWindowMeasureResult(t):"toolbar"===this.layout&&this._displayToolbarMeasureResult(t)},_measureResultString:function(e){var t,i,n,s,r,a,o,u,h="";if(e){t=e;for(u in t)t.hasOwnProperty(u)&&t[u]&&"name"!==u&&"sensorName"!==u&&(r="point"===u&&this._currentOperation.toLowerCase().indexOf("centroid")>=0?this._i18n.widgets.imageServiceMeasure.measureDialog.Centroid:this._i18n.widgets.imageServiceMeasure.measureDialog[u.charAt(0).toUpperCase()+u.slice(1)],"point"!=u?(i=this._i18n.widgets.imageServiceMeasure.unitLabel[this._getUnitString(t[u].unit)],s=Math.abs(t[u].uncertainty).toFixed(2),n=this._getDisplayValue(t[u]),h+="<strong>"+r+"</strong>: "+n+" (&plusmn"+s+") "+i+"<br/>"):(a=t[u].value.x.toFixed(2),o=t[u].value.y.toFixed(2),h+="<strong>"+r+"</strong><br/>"+this._i18n.widgets.imageServiceMeasure.measureDialog.X+" : "+a+"<br/>"+this._i18n.widgets.imageServiceMeasure.measureDialog.Y+" : "+o+"<br/>"))}else h=this._i18n.widgets.imageServiceMeasure.measurementErrorGeneric;return h},_getDisplayValue:function(e){var t;return t=this.layer.currentVersion&&this.layer.currentVersion>=10.3?e.uncertainty<0?e.value.toFixed(2):Number(e.displayValue).toString():e.value.toFixed(2)},_getUnitString:function(e){var t,i;for(t in T)T.hasOwnProperty(t)&&(T[t]===e?i=t:e===this._decimalDegreesConstantValue&&(i=this._decimalDegreesConstantKeyword));return i},_displayInfoWindowMeasureResult:function(e){var i,n,s=this._currentGraphic.geometry;this._currentGraphic&&("point"===s.type?this._currentInfowindow=s:"polyline"===s.type?(i=(s.paths[0][0][0]+s.paths[0][1][0])/2,n=(s.paths[0][0][1]+s.paths[0][1][1])/2,this._currentInfowindow=new S(i,n,this.map.spatialReference)):"polygon"===s.type&&(this._currentInfowindow=s.getCentroid()),this.map.infoWindow.setTitle(this._i18n.widgets.imageServiceMeasure.infoWindowTitle),this.map.infoWindow.setContent(e),this.map.infoWindow.on("hide",t.hitch(this,this._removeAssociatedGeometry)),this.map.infoWindow.show(this._currentInfowindow))},_displayToolbarMeasureResult:function(e){U.set(this.measureResultStringDiv,e)},_removeAssociatedGeometry:function(){this._currentGraphic&&(this.map.graphics.remove(this._currentGraphic),this._currentGraphic=null)},_removeDraws:function(){this._removeAssociatedGeometry(),this._currentInfowindow&&(this.map.infoWindow.hide(this._currentInfowindow),this._currentInfowindow=null)},_onUnitChange:function(e){this._addInfoWindow(e)},_toggle:function(){this._activeMeasureOpMenuItem?(this._removeDraws(),b.remove(this._activeMeasureOpMenuItem.domNode,"esriSelectedOption"),this._activeMeasureOpMenuItem=null,this.measureToolbar.deactivate(),b.remove(this._toggleButton._buttonNode,"esriCheckedMeasureButton"),this._enableMapNavigation()):(this._menuItem=this._dropDownMenuItemMap[this._currentOperation.replace("_3D","")],this._onDropDownMenuItemClick(this._currentOperation.replace("_3D",""),this._menuItem))},deactivate:function(){this._removeDraws(),this._activeMeasureOpMenuItem&&(b.remove(this._activeMeasureOpMenuItem.domNode,"esriSelectedOption"),this._activeMeasureOpMenuItem=null),this._toggleButton&&b.remove(this._toggleButton._buttonNode,"esriCheckedMeasureButton"),this.measureResultStringDiv&&U.set(this.measureResultStringDiv,""),"toolbar"===this.layout&&this._currentOperation&&this._toggleButtonMenuItemMap[this._currentOperation.replace("_3D","")].set("checked",!1),this.measureToolbar&&this.measureToolbar.deactivate(),this._enableMapNavigation()},_disableMapNavigation:function(){this.map.disableMapNavigation(),this.map.setInfoWindowOnClick(!1)},_enableMapNavigation:function(){this.map.enableMapNavigation(),this.map.setInfoWindowOnClick(!0)},destroy:function(){this.inherited(arguments)}});return s("extend-esri")&&t.setObject("dijit.ImageServiceMeasure",E,r),E});