// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/aspect","dojo/on","dojo/Deferred","dojo/DeferredList","dojo/Evented","dojo/has","dojo/date/locale","dojo/promise/all","dojo/query","dojo/number","dojo/string","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/text!../dijit/FeatureTable/templates/FeatureTable.html","dojo/i18n!../nls/jsapi","dojo/store/Cache","dojo/store/Memory","dojo/store/Observable","dojo/fx/Toggler","dijit/_WidgetBase","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/Dialog","dijit/Menu","dijit/MenuItem","dijit/form/DropDownButton","dijit/form/TimeTextBox","dijit/form/DateTextBox","dijit/form/NumberTextBox","dijit/form/Button","dijit/form/Select","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/editor","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","../kernel","../lang","../config","../geometry/Extent","../layers/FeatureLayer","../tasks/query","../tasks/StatisticDefinition","../tasks/QueryTask","../dijit/FeatureLayerQueryStore","dijit/layout/BorderContainer","dijit/layout/ContentPane","dojo/query!css2","dojo/domReady!"],function(e,t,i,n,r,a,s,o,d,l,h,u,c,f,m,g,p,y,_,b,v,w,C,T,I,F,S,L,D,H,E,M,x,O,P,N,k,j,R,V,G,B,A,q,z,Q,W,U,X,Y,K,J,Z,$){var et=m([T,I,F,S,r],{baseClass:"esri-feature-table",loaded:!1,templateString:y,widgetsInTemplate:!0,i18n:_,dataStore:null,featureCount:0,columns:[],idProperty:"id",grid:null,gridMenu:null,gridMenuAnchor:null,css:{featureTableColumnHeader:"esri-feature-table-column-header",featureTableColumnHeaderTitle:"esri-feature-table-column-header-title",featureTableColumnHeaderType:"esri-feature-table-column-header-type",collapsed:"collapsed",expando:"expando",headerGear:"esri-feature-table-gear",settingsIcon:"esri-icon-settings",lockedIcon:"esri-icon-locked",menuItem:"esri-feature-table-menu-item",dialog:"esri-feature-table-dialog"},featureLayer:null,map:null,layerInfo:{idArray:[],fieldInfos:[]},fieldInfos:[],gridOptions:{},dateOptions:{},selectedRows:[],selectedRowIds:[],hiddenFields:[],outFields:["*"],editable:!1,syncSelection:!0,zoomToSelection:!0,showDataTypes:!1,showGridHeader:!0,showGridMenu:!0,menuFunctions:[],_defaultDateOptions:{timeEnabled:!1,timePattern:null,datePattern:null},_defaultGridOptions:{noDataMessage:"No Data",allowSelectAll:!1,cellNavigation:!1,selectionMode:"extended",pagination:!1,allowTextSelection:!1,pageSizeOptions:[10,25,50]},_queryStore:null,_memoryStore:null,_featureSet:null,_orderByFields:null,_editorTrackingInfos:{},_userIds:{},_featureSelectedCount:0,_filteredRowIds:[],_gridQuery:!1,_activeEditors:[],_rollbackInfos:[],_batchCount:0,_defaultBatchCount:1e3,_defaultFeatureCount:2e3,_toggler:null,_expandedNodes:[],_nestedGrids:[],_i18nStrings:{gridHeader:_.widgets.FeatureTable.gridHeader,loadingData:_.widgets.FeatureTable.loadingData,untitled:_.widgets.FeatureTable.untitled,dataError:_.widgets.FeatureTable.dataError,sortAsc:_.widgets.FeatureTable.sortAsc,sortDesc:_.widgets.FeatureTable.sortDesc,statistics:_.widgets.FeatureTable.statistics,close:_.widgets.FeatureTable.close,defaultSort:_.widgets.FeatureTable.defaultSort,showSelected:_.widgets.FeatureTable.showSelected,clearSelection:_.widgets.FeatureTable.clearSelection,toggleColumns:_.widgets.FeatureTable.toggleColumns,add:_.widgets.FeatureTable.add,show:_.widgets.FeatureTable.show,hide:_.widgets.FeatureTable.hide,attachments:_.widgets.FeatureTable.attachments,owners:_.widgets.FeatureTable.owners,parenValue:_.widgets.FeatureTable.parenValue,date:_.widgets.FeatureTable.date,number:_.widgets.FeatureTable.number,string:_.widgets.FeatureTable.string},constructor:function(e,t){t&&this.set({gridId:t+"_grid",gridBorderContainerId:t+"_gridBorderContainer",gridHeaderId:t+"_gridHeaderNode",gridContentPaneId:t+"_gridContentPane",gridMenuNodeId:t+"_menuNode"})},postMixInProperties:function(){this.inherited(arguments),this.set("gridOptions",g.mixin(this._defaultGridOptions,this.gridOptions)),this.set("dateOptions",g.mixin(this._defaultDateOptions,this.dateOptions)),this._GridDefinition=this._generateGridDefinition()},postCreate:function(){this.inherited(arguments),this._listenerHandles=[]},startup:function(){this.inherited(arguments);var e=this.get("featureLayer");return e&&e.loadError?void this._showLoadError(e.loadError.message):void(this.domNode&&e.loaded?this._init():this.own(t(e,"load",g.hitch(this,function(){this._init()})),t(e,"error",g.hitch(this,function(){this._showLoadError(e.loadError?e.loadError.message:"")}))))},refresh:function(){this.grid.refresh()},destroy:function(){this.inherited(arguments),p.forEach(this._listenerHandles,function(e){e.remove()}),this.gridMenu&&this.gridMenu.destroy(),this.statisticsDialog&&this.statisticsDialog.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),this.grid&&this.grid._destroyColumns(),delete this.columns,delete this.layerInfo},resize:function(){this._resize()},selectRows:function(e){this._closeEditors();var t,i=[],n=[];if(this.grid.clearSelection(),e[0]&&"esri.Graphic"===e[0].declaredClass&&(p.forEach(e,function(e){n.push(e.attributes[this.idProperty])},this),e=n),1===e.length){t=e[0];var r=this.dataStore.get(e),a=this.dataStore.data.indexOf(r);this.grid.select(t),this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText(),this.grid.scrollTo({x:0,y:this.grid.rowHeight*a}),this.grid.row(t).element&&this.grid.row(t).element.scrollIntoView()}))}else p.forEach(e,function(e){i.push(this.dataStore.get(e))},this),this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText()}))},filterSelectedRecords:function(e){e?this._showSelectedRecords():(this.grid.set("query",{}),this.set("_gridQuery",!1))},clearSelection:function(){this._clearSelection()},getRowDataById:function(e){return this.grid.row(e).data},getFeatureDataById:function(e){var t=new K;return t.objectIds=[e],t.outFields=["*"],this.featureLayer.queryFeatures(t,g.hitch(this,function(e){return e.features[0]}))},_init:function(){this.set("idProperty",this.featureLayer.objectIdField),this._getLayerInfo(),this._getEditingInfo();var e=W.isDefined(this.featureLayer.maxRecordCount)?this.featureLayer.maxRecordCount:1e3;this._batchCount=Math.min(e,this._defaultBatchCount),this.grid=this._generateGrid(),this.grid.startup(),this.grid.resize(),this._listenerHandles.push(this._gridSelectListener(),this._gridDeselectListener(),this._gridDataChangeListener(),this._gridRefreshListener(),this._gridColumnStateChangeListener(),this._gridColumnResizeListener(),this._gridErrorListener(),this._gridSortListener(),this._gridFilterListener(),this._gridEditorShowListener(),this._gridEditorHideListener()),this.showGridMenu&&this._createTableMenu(),this.showGridHeader||f.set(this._gridHeaderNode.domNode,"display","none"),this._toggler=this._createTableToggle(),this._listenerHandles.push(this._tableToggleClickCallback(),this._columnClickCallback(),this._layerClickCallback(),this._applyEditsListener()),this.set("loaded",!0),this.emit("load",this.loaded),this.grid.set("noDataMessage",""),this._gridTitleNode.innerHTML=this._i18nStrings.loadingData,this._resize(),this._toggleLoadingIndicator(!0),this._createStoreFromDataQuery()},_generateGridDefinition:function(){return m(this.gridOptions.pagination?[A,k,j,G,R,V,q,z,B]:[A,k,j,G,R,V,q,z])},_generateGrid:function(){var t=this,i=this.get("gridOptions"),n=this.get("columns"),r=this._generateGridDefinition(),a=new r({columns:n,sort:this.get("idProperty"),noDataMessage:"",selectionMode:i.selectionMode,allowSelectAll:i.allowSelectAll,allowTextSelection:i.allowTextSelection,cellNavigation:i.cellNavigation,keepScrollPosition:!0,pageSizeOptions:i.pageSizeOptions,minRowsPerPage:this.get("_batchCount"),maxRowsPerPage:this.get("_batchCount"),queryRowsOverlap:0,pagingDelay:1e3,renderRow:function(e){return t._renderExpandoRow(e,this)}},this.get("gridId"));return e.before(a,"removeRow",g.hitch(this,function(e){p.forEach(n.length,function(t,i){var n=a.cell(e,i).element,r=n.contents||n,s=r.widget;s&&s.destroyRecursive()},this)})),e.after(a,"renderHeader",g.hitch(this,function(){a._sortListener.remove()})),a},_renderExpandoRow:function(e,t){var i=u.create("div",{className:"collapsed"});return i.appendChild(this._GridDefinition.prototype.renderRow.apply(t,arguments)),u.create("div",{className:"expando"},i),i},_createStoreFromDataQuery:function(){this.get("dataStore")&&(this._toggleLoadingIndicator(!0),this._gridTitleNode.innerHTML=this._i18nStrings.loadingData,this.grid.set({store:null,noDataMessage:""}),this.set("dataStore",null)),this._getFeatureCount().then(g.hitch(this,this._queryFeatureLayerSetup))},_getFeatureCount:function(){var e=new K;return e.returnGeometry=!1,e.returnIdsOnly=!1,e.where="1=1",U.defaults.io.timeout=1e4,this.featureLayer.queryCount(e).then(g.hitch(this,function(e){return U.defaults.io.timeout=6e4,this.set("featureCount",e),e}),g.hitch(this,function(){return U.defaults.io.timeout=6e4,this.set("featureCount",this.layerInfo.isFeatureCollection?this.featureLayer.graphics.length:this._defaultFeatureCount),this.featureCount}))},_getAllIds:function(){var e=new i,t=this.get("featureLayer"),n=new K;return n.returnGeometry=!1,n.outFields=[this.idProperty],n.where="1=1",n.returnIdsOnly=!0,t.queryIds(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},_queryFeatureLayer:function(e){var t=new i,n=this.get("featureLayer"),r=new K;return r.where="1=1",r.returnGeometry=!1,r.objectIds=e,n.queryFeatures(r,function(e){t.resolve(e)}),t},_queryFeatureLayerSetup:function(){var e=this.get("featureLayer");return this.layerInfo.isFeatureCollection?void this._queryFeatureCollection():void this._queryFeatureLayer().then(g.hitch(this,function(t){if(this._updateFieldInfos(t.fields),this._generateColumnsFromFieldInfos(),this.grid.set("columns",this.get("columns")),this._updateGridHeaderText(),t.exceededTransferLimit)if(e.advancedQueryCapabilities&&!e.advancedQueryCapabilities.supportsPagination){if(this.layerInfo.idArray&&this.layerInfo.idArray.length>0)return this._generateCacheStore(this.layerInfo.idArray),void this.grid.set("store",this.dataStore);this._getAllIds().then(g.hitch(this,function(e){this.layerInfo.idArray=e,this._generateCacheStore(e),this.grid.set("store",this.dataStore)}),function(e){this._showLoadError(e.message)})}else this._generateCacheStore();else this._generateMemoryStore(t.features);this.grid.set("store",this.dataStore)}),g.hitch(this,function(e){this._showLoadError(e.message),this.grid.set("noDataMessage",this.gridOptions.noDataMessage)}))},_queryFeatureCollection:function(){this.grid.set("noDataMessage",this.gridOptions.noDataMessage),this._updateFieldInfos(this.featureLayer.fields),this._generateColumnsFromFieldInfos(),this.grid.set("columns",this.get("columns")),this._updateGridHeaderText(),this._generateMemoryStore(this.featureLayer.graphics),this.layerInfo.features=this.featureLayer.graphics,this.grid.set("store",this.dataStore),this._toggleLoadingIndicator(!1)},_generateCacheStore:function(e){var t,i,n,r=this.get("featureLayer");t=new $({layer:r,objectIds:e,totalCount:this.featureCount,batchCount:this._batchCount,where:"1=1",orderByFields:this._orderByFields}),i=new v,n=new b(t,i,{}),this.set({_queryStore:t,_memoryStore:i,dataStore:n}),this.grid.set("noDataMessage",this.gridOptions.noDataMessage),this._toggleLoadingIndicator(!1)},_generateMemoryStore:function(e){var t=[];p.forEach(e,function(e){t.push(e.attributes)},this),this.dataStore=new w(new v({data:t,idProperty:this.get("idProperty")})),this.grid.set("noDataMessage",this.gridOptions.noDataMessage),this._toggleLoadingIndicator(!1)},_getAllDataFromCache:function(){var e,t,i=this.get("featureCount"),r=this.featureLayer.maxRecordCount,a=Math.ceil(i/r),s=[];for(t=0;a>t;t++)e=r*t,s.push(this._queryCacheStore(r,e));var o=new n(s);return o},_queryCacheStore:function(e,t){var n=new i;return this.dataStore.query(null,{sort:[{attribute:this.idProperty,descending:!0}],count:e,start:t}).then(function(e){n.resolve(e)}),n},_getLayerInfo:function(){var e={},t=this.featureLayer,i=t.id||t.layerId;t.credential&&(this._userIds[i]=this.featureLayer.credential.userId),e.userId&&(this._userIds[i]=e.userId),e.isFeatureCollection=t._collection&&t._collection===!0||null===t.url&&null===t._url?!0:!1,e.idProperty=this.get("idProperty"),e.layerId=i,e.editable=t.isEditable(),e.editCapabilities={},e.typeIdField=t.typeIdField,e.types=t.types,e.fieldInfos=[],e.hasAttachments=t.hasAttachments,this.set("layerInfo",g.clone(e))},_getEditingInfo:function(){this.featureLayer.getEditCapabilities&&(this.layerInfo.editCapabilities=this.featureLayer.getEditCapabilities());var e=[];this.featureLayer.editFieldsInfo&&(this.featureLayer.editFieldsInfo.creatorField&&e.push(this.featureLayer.editFieldsInfo.creatorField),this.featureLayer.editFieldsInfo.creationDateField&&e.push(this.featureLayer.editFieldsInfo.creationDateField),this.featureLayer.editFieldsInfo.editorField&&e.push(this.featureLayer.editFieldsInfo.editorField),this.featureLayer.editFieldsInfo.editDateField&&e.push(this.featureLayer.editFieldsInfo.editDateField)),this._editorTrackingInfos[this.featureLayer.id]=e},_generateColumnOrder:function(e){var t=[],i=this.outFields;return"*"!==i[0]?(-1===p.indexOf(i,this.idProperty)&&t.push(this._findFirst(e,"name",this.idProperty)),p.forEach(i,function(i){var n=this._findFirst(e,"name",i)||null;n&&i.name!==this.idProperty&&-1===p.indexOf(t,n)&&t.push(n)},this),p.forEach(e,function(e){-1===p.indexOf(t,e)&&t.push(e)},this)):t=g.clone(e),t},_updateFieldInfos:function(e){var t=this._generateColumnOrder(e);p.forEach(t,function(e,t){var i,n,r,a,s,o,d,l,h=!1,u=this._findFirst(this.featureLayer.fields,"name",e.name)||{},c=this._findFirst(this.fieldInfos,"name",e.name)||null;i=c&&c.alias?c.alias:u.alias,a=u.domain||!1,r=this.layerInfo.typeIdField&&e.name===this.layerInfo.typeIdField||!1,this.layerInfo&&this.layerInfo.types&&p.forEach(this.layerInfo.types,function(t){return t.domains&&t.domains[e.name]?void(h=!0):void 0},this),s=-1!==p.indexOf(this.hiddenFields,e.name)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type||-1!==p.indexOf(this._editorTrackingInfos[this.featureLayer.id],e.name)||c&&c.visible===!1||"*"!==this.outFields[0]&&-1===p.indexOf(this.outFields,e.name),o=this.editable&&e.name!==this.idProperty&&this.layerInfo.editable&&u&&"undefined"!=typeof u.editable?c&&"undefined"!=typeof c.editable&&u.editable!==!1?c.editable||!1:u.editable:!1,n=c&&c.format?c.format:null,d=u.nullable||!1,l=c&&c.dateOptions?c.dateOptions:null;var f={idx:t,name:e.name,alias:i,length:e.length||null,type:e.type,hidden:s,editable:o,nullable:d,domain:a,typeId:r,subtypeDomain:h,format:n,dateOptions:l};this.layerInfo.fieldInfos[t]=g.clone(f)},this)},_generateColumnsFromFieldInfos:function(){var e=this.layerInfo.fieldInfos,t=[];p.forEach(e,function(e,i){var n=this.layerInfo.fieldInfos[i];"esriFieldTypeDate"===e.type?t.push(e.editable?this._generateDateTimeEditorColumn(e,n):this._generateDateTimeColumn(e,n)):e.domain?t.push(e.editable?this._generateDomainEditorColumn(e,n):this._generateDomainColumn(e,n)):e.typeId?t.push(e.editable?this._generateTypeEditorColumn(e,n):this._generateTypeColumn(e,n)):e.subtypeDomain?t.push(e.editable?this._generateSubtypeDomainEditorColumn(e,n):this._generateSubtypeDomainColumn(e,n)):"esriFieldTypeInteger"===e.type||"esriFieldTypeSingle"===e.type||"esriFieldTypeDouble"===e.type||"esriFieldTypeSmallInteger"===e.type?t.push(e.editable?this._generateNumberEditorColumn(e,n):this._generateNumberColumn(e,n)):"esriFieldTypeGUID"===e.type||"esriFieldTypeRaster"===e.type||"esriFieldTypeBlob"===e.type||"esriFieldTypeGeometry"===e.type||"esriFieldTypeXML"===e.type||t.push(e.editable?this._generateStringEditorColumn(e,n):this._generateStringColumn(e,n))},this),this.set("columns",t)},_generateDomainColumn:function(e,t){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(i){var n=this._findFirst(t.domain.codedValues,"code",i[e.name]);return null!==n?n.name:null}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return i},_generateDomainEditorColumn:function(e,i){var n={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){var n,r;return e.domain.codedValues?(r=this._findFirst(i.domain.codedValues,"code",t[e.name]),n=null!==r?r.name:null):"range"===e.domain.type&&(n=t[e.name]),n}),renderCell:g.hitch(this,function(n,r,a){var s=u.create("div",{innerHTML:r},a),o=[];if(s.innerHTML=r,e.domain.codedValues)p.forEach(i.domain.codedValues,function(t){o.push(n[e.name]===t.code?{label:t.name,value:t.code,selected:!0}:{label:t.name,value:t.code})}),null!==n[e.name]&&" "!==n[e.name]&&""!==n[e.name]||!e.nullable?null!==n[e.name]&&" "!==n[e.name]&&""!==n[e.name]||e.nullable?e.nullable&&o.push({label:"- empty -",value:"ft_null"}):o.push({label:"- empty -",value:"ft_null",selected:!0,disabled:!0}):o.push({label:"- empty -",value:"ft_null",selected:!0}),t(a,"dblclick",g.hitch(this,function(){this._closeEditors(),s.innerHTML="";var r=new N({options:o,style:{width:"100%"}});r.placeAt(s),this.emit("editor-show",{cell:a,editor:r,grid:this.grid}),t(r,"blur",g.hitch(this,function(){var t=this._findFirst(i.domain.codedValues,"code",n[e.name]);s.innerHTML=t?t.name:null})),t(r,"keydown",function(e){13===e.keyCode&&r.focusNode.blur()}),t(r,"change",g.hitch(this,function(t){var o={fieldName:e.name,oldValue:n[e.name],rowId:n[this.idProperty],rowObject:n};"ft_null"===t&&(t=null),n[e.name]=t;var d=this._findFirst(i.domain.codedValues,"code",t);s.innerHTML=d?d.name:null,r.destroy(),this._applyEditsByRow(n,o),this.emit("editor-hide",{cell:a,editor:r,grid:this.grid})})),this._activeEditors.push({id:n[this.idProperty],widget:r})}));else{if("range"!==e.domain.type)return void this.emit("error","Domain type is not supported.");var d=e.domain.minValue,l=e.domain.maxValue;t(a,"dblclick",g.hitch(this,function(){this._closeEditors(),s.innerHTML="";var i=new O({value:n[e.name],required:!e.nullable,constraints:{min:d,max:l}});i.placeAt(s),i.focus(),i.textbox.select(),this.emit("editor-show",{cell:a,editor:i,grid:this.grid}),t(i,"blur",g.hitch(this,function(){s.innerHTML=n[e.name]})),t(i,"keydown",function(e){13===e.keyCode&&i.isValid()&&i.focusNode.blur()}),t(i,"change",g.hitch(this,function(t){var r={fieldName:e.name,oldValue:n[e.name],rowId:n[this.idProperty],rowObject:n};i.isValid()?(n[e.name]=t,s.innerHTML=t,i.destroy(),this._applyEditsByRow(n,r)):(s.innerHTML=n[e.name],i.destroy(),this.emit("editor-hide",{cell:a,editor:i,grid:this.grid}))})),this._activeEditors.push({id:n[this.idProperty],widget:i})}))}}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return n},_generateTypeColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){var i=this._findFirst(this.layerInfo.types,"id",t[e.name]);return null!==i?i.name:null}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return t},_generateTypeEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){var i=this._findFirst(this.layerInfo.types,"id",t[e.name]);return null!==i?i.name:null}),renderCell:g.hitch(this,function(i,n,r){var a=u.create("div",{innerHTML:n},r),s=[];a.innerHTML=n,p.forEach(this.layerInfo.types,function(t){s.push(i[e.name]===t.id?{label:t.name,value:t.id,selected:!0}:{label:t.name,value:t.id})},this),null!==i[e.name]&&" "!==i[e.name]&&""!==i[e.name]||!e.nullable?null!==i[e.name]&&" "!==i[e.name]&&""!==i[e.name]||e.nullable?e.nullable&&s.push({label:"- empty -",value:"ft_null"}):s.push({label:"- empty -",value:"ft_null",selected:!0,disabled:!0}):s.push({label:"- empty -",value:"ft_null",selected:!0}),t(r,"dblclick",g.hitch(this,function(){this._closeEditors(),a.innerHTML="";var n=new N({options:s,style:{width:"100%"}});n.placeAt(a),this.emit("editor-show",{cell:r,editor:n,grid:this.grid}),t(n,"blur",g.hitch(this,function(){var t=this._findFirst(this.layerInfo.types,"id",i[e.name]);a.innerHTML=t?t.name:null})),t(n,"keydown",function(e){13===e.keyCode&&n.focusNode.blur()}),t(n,"change",g.hitch(this,function(t){var s={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};"ft_null"===t&&(t=null),i[e.name]=t;var o=this._findFirst(this.layerInfo.types,"id",t);a.innerHTML=o?o.name:null,n.destroy(),this._applyEditsByRow(i,s),this.emit("editor-hide",{cell:r,editor:n,grid:this.grid})})),this._activeEditors.push({id:i[this.idProperty],widget:n})}))}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return i},_generateSubtypeDomainColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){var i,n=this._findFirst(this.layerInfo.types,"id",t[this.layerInfo.typeIdField]);return n&&n.domains&&n.domains[e.name]&&n.domains[e.name].codedValues&&(i=this._findFirst(n.domains[e.name].codedValues,"code",t[e.name])),i?i.name:t[e.name]}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return t},_generateSubtypeDomainEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editOn:"dblclick",editor:"text",get:g.hitch(this,function(t){var i,n=this._findFirst(this.layerInfo.types,"id",t[this.layerInfo.typeIdField]);return n&&n.domains&&n.domains[e.name]&&n.domains[e.name].codedValues&&(i=this._findFirst(n.domains[e.name].codedValues,"code",t[e.name])),i?i.name:t[e.name]}),renderCell:g.hitch(this,function(i,n,r){var a=u.create("div",{innerHTML:n},r),s=!1;return a.innerHTML=n,t(r,"dblclick",g.hitch(this,function(){this._closeEditors();var n,o,d=this._findFirst(this.layerInfo.types,"id",i[this.layerInfo.typeIdField]),l=d.domains[e.name],h=[];if(l){n=d.domains[e.name].codedValues,o=this._findFirst(n,"code",i[e.name]),p.forEach(n,function(t){h.push(i[e.name]===t.code?{label:t.name,value:t.code,selected:!0}:{label:t.name,value:t.code}),t.code===o&&(s=!0)}),null!==i[e.name]&&" "!==i[e.name]&&""!==i[e.name]||!e.nullable?null!==i[e.name]&&" "!==i[e.name]&&""!==i[e.name]||e.nullable?e.nullable&&h.push({label:"- empty -",value:"ft_null"}):h.push({label:"- empty -",value:"ft_null",selected:!0,disabled:!0}):h.push({label:"- empty -",value:"ft_null",selected:!0}),s||o||null===i[e.name]||h.push({label:i[e.name],value:"N/A",selected:!0,disabled:!0}),a.innerHTML="";var u=new N({options:h,style:{width:"100%"}});u.placeAt(a),this.emit("editor-show",{cell:r,editor:u,grid:this.grid}),t(u,"blur",g.hitch(this,function(){var t=this._findFirst(n,"code",i[e.name]);a.innerHTML=t?t.name:i[e.name]})),t(u,"keydown",function(e){13===e.keyCode&&u.focusNode.blur()}),t(u,"change",g.hitch(this,function(t){var s={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};"ft_null"===t&&(t=null),i[e.name]=t;var o=this._findFirst(n,"code",t);a.innerHTML=o?o.name:null,u.destroy(),this._applyEditsByRow(i,s),this.emit("editor-hide",{cell:r,editor:u,grid:this.grid})})),this._activeEditors.push({id:i[this.idProperty],widget:u})}else{a.innerHTML="";var c=new O({value:i[e.name],required:!e.nullable});c.placeAt(a),c.focus(),c.textbox.select(),this.emit("editor-show",{cell:r,editor:c,grid:this.grid}),t(c,"blur",g.hitch(this,function(){a.innerHTML=i[e.name]})),t(c,"keydown",function(e){13===e.keyCode&&c.isValid()&&c.focusNode.blur()}),t(c,"change",g.hitch(this,function(t){var n={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};c.isValid()?(i[e.name]=t,a.innerHTML=t,c.destroy(),this._applyEditsByRow(i,n)):(a.innerHTML=i[e.name],c.destroy()),this.emit("editor-hide",{cell:r,editor:c,grid:this.grid})})),this._activeEditors.push({id:i[this.idProperty],widget:c})}})),n}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return i.formatter=e.format&&e.format.embeddedHTML?g.hitch(this,function(e){return e?e:null}):e.format&&e.format.template?g.hitch(this,function(t){var i;return t&&(i=h.substitute(e.format.template,{value:t})),i||null}):e.format&&e.format.link===!1?g.hitch(this,function(e){return e}):g.hitch(this,function(e){return this._generateLinkFromString(e)}),i},_generateStringColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return t.formatter=e.format&&e.format.embeddedHTML?g.hitch(this,function(e){return e?e:null}):e.format&&e.format.template?g.hitch(this,function(t){var i;return t&&(i=h.substitute(e.format.template,{value:t})),i||null}):e.format&&e.format.link===!1?g.hitch(this,function(e){return e}):g.hitch(this,function(e){return this._generateLinkFromString(e)}),t},_generateStringEditorColumn:function(e){var t=new G({label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editorArgs:{required:!e.nullable},editOn:"dblclick",editor:"text",renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})});return t.formatter=e.format&&e.format.embeddedHTML?g.hitch(this,function(e){return e?e:null}):e.format&&e.format.template?g.hitch(this,function(t){var i;return t&&(i=h.substitute(e.format.template,{value:t})),i||null}):e.format&&e.format.link===!1?g.hitch(this,function(e){return e}):g.hitch(this,function(e){return this._generateLinkFromString(e)}),t},_generateNumberColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return e.format&&e.format.template&&(t.formatter=g.hitch(this,function(t){var i;return t&&(i=h.substitute(e.format.template,{value:t})),i||null})),t},_generateNumberEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)}),renderCell:g.hitch(this,function(i,n,r){var a=u.create("div",{innerHTML:n},r),s=null,o={};"esriFieldTypeInteger"===e.type&&(o.places=0),s=e.format&&e.format.template&&null!==n?h.substitute(e.format.template,{value:n}):n,a.innerHTML=s,t(r,"dblclick",g.hitch(this,function(){this._closeEditors(),a.innerHTML="";var n=new O({value:i[e.name],required:!e.nullable,constraints:o});n.placeAt(a),n.focus(),n.textbox.select(),this.emit("editor-show",{cell:r,editor:n,grid:this.grid}),t(n,"blur",g.hitch(this,function(){var t=i[e.name],n=null;n=e.format&&e.format.template&&null!==t?h.substitute(e.format.template,{value:t}):t,a.innerHTML=n})),t(n,"keydown",function(e){13===e.keyCode&&n.isValid()&&n.focusNode.blur()}),t(n,"change",g.hitch(this,function(t){var s={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i},o=null;(""===t||isNaN(t))&&(t=null),n.isValid()?(i[e.name]=t,o=e.format&&e.format.template&&null!==t?h.substitute(e.format.template,{value:t}):t,a.innerHTML=o,n.destroy(),this._applyEditsByRow(i,s)):(o=e.format&&e.format.template&&null!==i[e.name]?h.substitute(e.format.template,{value:i[e.name]}):i[e.name],a.innerHTML=o,n.destroy(),this.emit("editor-hide",{cell:r,editor:n,grid:this.grid}))})),this._activeEditors.push({id:i[this.idProperty],widget:n})}))})};return e.format&&e.format.template&&(i.formatter=g.hitch(this,function(t){var i;return t&&(i=h.substitute(e.format.template,{value:t})),i||null})),i},_generateDateTimeColumn:function(e){var t={},i=e.dateOptions&&void 0!==e.dateOptions.timeEnabled?e.dateOptions.timeEnabled:this.dateOptions.timeEnabled;return t=i?{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:this._generateDateFromLocale(new Date(t[e.name]),e)}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}:{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:this._generateDateFromLocale(new Date(t[e.name]),e)}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}},_generateDateTimeEditorColumn:function(e){var i,n=e.dateOptions&&void 0!==e.dateOptions.timeEnabled?e.dateOptions.timeEnabled:this.dateOptions.timeEnabled;return i=n?{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:g.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:this._generateDateFromLocale(new Date(t[e.name]),e)}),renderCell:g.hitch(this,function(i,n,r){var a,s;n&&u.create("div",{innerHTML:n},r),t(r,"dblclick",g.hitch(this,function(){var t,o,d;this._closeEditors(),a=new x({value:new Date(i[e.name]),constraints:{datePattern:e.dateOptions&&e.dateOptions.datePattern?e.dateOptions.datePattern:this.dateOptions.datePattern}}),a.on("change",g.hitch(this,function(t){var n={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i},r=s.value;if(!a.isValid())return void a.setValue(null);if(null===t||""===t)return s.setValue(null),i[e.name]=null,void this._applyEditsByRow(i,n);null===r&&(r=new Date(0,0),s.setValue(r));var o=this._getCombinedDateTime(t,r).getTime();i[e.name]=o,this._applyEditsByRow(i,n)})),s=new M({value:new Date(i[e.name]),constraints:{timePattern:e.dateOptions&&e.dateOptions.timePattern?e.dateOptions.timePattern:this.dateOptions.timePattern}}),s.on("change",g.hitch(this,function(t){var n={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i},r=a.value;if(!s.isValid())return void s.setValue(null);if(null===t||""===t)return a.setValue(null),void(i[e.name]=null);null===r&&(r=new Date(0,0),a.setValue(r));var o=this._getCombinedDateTime(r,t).getTime();i[e.name]=o,this._applyEditsByRow(i,n)})),r.innerHTML="",t=u.create("div",{style:{"float":"left",display:"inline",width:"90%"}},r),o=u.create("div",{style:{"float":"right",display:"inline",width:"10%","margin-top":"5px"}},r),a.placeAt(t),s.placeAt(t),d=new P({iconClass:"dijitIconSave",showLabel:!1,onClick:g.hitch(this,function(){var t,o={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i},d=a.value,l=s.value;s.isValid()&&a.isValid()?(d&&l?(t=this._getCombinedDateTime(d,l).getTime(),r.innerHTML=this._generateDateFromLocale(new Date(t),e)):(t=null,r.innerHTML=""),i[e.name]=t,this._applyEditsByRow(i,o)):r.innerHTML=n})},u.create("div",null,o)),d.startup(),a.focus(),a.textbox.select()}))}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}:new G({label:e.alias,field:e.name,type:e.type,editorArgs:{required:!e.nullable,constraints:{datePattern:e.dateOptions&&e.dateOptions.datePattern?e.dateOptions.datePattern:this.dateOptions.datePattern}},editOn:"dblclick",hidden:e.hidden,formatter:g.hitch(this,function(t){return t?this._generateDateFromLocale(t,e):null}),get:g.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:new Date(t[e.name])}),renderHeaderCell:g.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})},x)},_closeEditors:function(){var e=this._activeEditors;p.forEach(e,function(e){e.widget.onBlur()}),this.set("_activeEditors",[])},_getColumnHeaderCell:function(e,t){var i=u.create("div",{className:this.css.featureTableColumnHeader});return u.create("div",{innerHTML:t.alias,className:this.css.featureTableColumnHeaderTitle},i),!t.editable&&this.editable&&this.layerInfo.editable&&u.create("span",{className:this.css.headerGear+" "+this.css.lockedIcon},i),u.create("div",{style:{clear:"both"}},i),this.showDataTypes&&u.create("div",{innerHTML:t.type,className:this.css.featureTableColumnHeaderType},i),i},_selectFeaturesFromIds:function(e){if(e||0!==this.selectedRowIds.length){var t=new K;return t.returnGeometry=!!this.map,t.objectIds=e||this.selectedRowIds,t.where="1=1",this.featureLayer.selectFeatures(t,Y.SELECTION_NEW)}},_updateGridSelection:function(){var e,t,n=this.grid.selection,r=new i,a=[],s=[];for(e in n)n.hasOwnProperty(e)&&(t=parseInt(e,10),s.push(t),a.push(this.grid.row(t).data));return this.set({selectedRows:a,selectedRowIds:s,_featureSelectedCount:s.length}),r.resolve(),r
},_showExpandoCallback:function(e,t,i,n,r){var a=t.element,s=c.contains(a,"collapsed"),o=d(".expando",a)[0],l=this._expandedNodes[0]?e===this._expandedNodes[0].grid:!1,h=this._expandedNodes[0]?c.contains(this._expandedNodes[0].textSpan,r):!1,u=this._expandedNodes[0]?this._expandedNodes[0].rowNode===a:!1,f=u&&h;return f?(n.innerHTML=this._i18nStrings.hide,this._expandedNodes[0].textSpan.innerHTML=this._i18nStrings.show,this._expandedNodes=[{grid:e,rowNode:a,textDiv:i,textSpan:n}]):!l&&this._expandedNodes[0]?c.toggle(a,"collapsed",!s):(p.forEach(this._expandedNodes,function(e){c.add(e.rowNode,"collapsed"),e.textSpan.innerHTML=this._i18nStrings.show},this),c.toggle(a,"collapsed",!s),this._expandedNodes=s?[{grid:e,rowNode:a,textDiv:i,textSpan:n}]:[],n.innerHTML=s?this._i18nStrings.hide:this._i18nStrings.show),o},_applyEdits:function(e,t){if(e=e||[],!(e.length<=0)){var i=[];p.forEach(e,function(e){e.layer&&i.push(e.layer.applyEdits(e.adds,e.updates,e.deletes))}),i.length>0?o(i).then(g.hitch(this,function(){t&&t()})):this._toggleLoadingIndicator(!1)}},_applyEditsByRow:function(e,t){t&&this._rollbackInfos.push({id:t.rowId,data:t}),this.getFeatureDataById(e[this.idProperty]).then(g.hitch(this,function(t){this._toggleLoadingIndicator(!0);var i=t.features[0];i.attributes=e,this._applyEdits([{layer:this.featureLayer,updates:[i]}],null)}))},_applyEditsListener:function(){var e=t(this.featureLayer,"edits-complete",g.hitch(this,function(e){this.emit("edits-complete",e);var t,i,n,r,a=e.updates||[],s=this._rollbackInfos;a&&a.length&&p.forEach(a,function(e){t=this._findFirst(s,"id",e.objectId),i=t.data,e.success||(e.error?this.emit("error",e.error):this.emit("error","Update failed."),i?(n=this.grid.row(i.rowId),r=n.data,r[this.idProperty]===e.objectId?(r[i.fieldName]=i.oldValue,this.grid.updateDirty(i.rowId,i.fieldName,i.oldValue),this.grid.refresh()):this.emit("error","Couldn't rollback value.")):this.emit("error","Couldn't rollback value.")),this._rollbackInfos.splice(p.indexOf(this._rollbackInfos,t),1),this._toggleLoadingIndicator(!1)},this),this.layerInfo.isFeatureCollection&&this._createStoreFromDataQuery(),this._toggleLoadingIndicator(!1)}));return e},_layerClickCallback:function(){var e=t(this.featureLayer,"click",g.hitch(this,function(e){if(this.syncSelection&&e.graphic&&e.graphic.attributes&&e.graphic.attributes[this.idProperty]){this.grid.clearSelection(),this.featureLayer.clearSelection();var i=e.graphic,n=i.attributes[this.idProperty];this._selectFeaturesFromIds([n]).then(g.hitch(this,function(e){if(e.length){if(this.map&&this.zoomToSelection){var i=this._calcGraphicsExtent(e);if(i){var r=i.getCenter();this.map.centerAt(r).then(function(){p.forEach(e,function(e){e.getDojoShape()&&e.getDojoShape().moveToFront()})})}else this.emit("error","Could not generate valid extent.")}var a=this.dataStore.get(n),s=this.dataStore.data.indexOf(a);("undefined"==typeof a||-1===s)&&this.emit("error","Could not load the row. Selection failed."),this.grid.select(n),this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText(),t.once(this.grid,"scroll",g.hitch(this,function(){this.grid.row(n).element&&this.grid.row(n).element.scrollIntoView()})),this.grid.scrollTo({x:0,y:this.grid.rowHeight*s})}))}}),function(){this.emit("error","Could not select features.")})}}));return e},_gridRefreshListener:function(){var e=t(this.grid,"dgrid-refresh-complete",g.hitch(this,function(e){this.grid.columns[0]&&this.emit("refresh",e)}));return e},_gridDataChangeListener:function(){var e=t(this.grid,"dgrid-datachange",g.hitch(this,function(e){var t=e.cell.column.field,i=e.value,n=parseInt(e.rowId,10),r=this.grid.row(n).data,a=this._findFirst(this.layerInfo.fieldInfos,"name",t),s={oldValue:e.oldValue,fieldName:t,rowId:n,rowObject:r};this.emit("data-change",e),""===i&&(i=null),"esriFieldTypeInteger"!==a.type&&"esriFieldTypeSmallInteger"!==a.type||null===i||(i=parseInt(i,10)),"esriFieldTypeDouble"!==a.type&&"esriFieldTypeSingle"!==a.type||null===i||(i=parseFloat(i)),r[t]=i&&i.getTime&&i.getTime()?i.getTime():i,this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText(),this._applyEditsByRow(r,s)}))}));return e},_gridSelectListener:function(){var e=t(this.grid,"dgrid-select",g.hitch(this,function(e){this._activeEditors[0]&&this._activeEditors[0].id&&e.rows[0]&&Number(e.rows[0].id)!==Number(this._activeEditors[0].id)&&this._closeEditors(),this.emit("row-select",e.rows),this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText(),this.map&&this.syncSelection&&this._selectFeaturesFromIds().then(g.hitch(this,function(e){if(this.zoomToSelection){var t=this._calcGraphicsExtent(e);if(t){var i=t.getCenter();this.map.centerAt(i).then(function(){p.forEach(e,function(e){e.getDojoShape()&&e.getDojoShape().moveToFront()})})}else this.emit("error","Could not generate valid extent.")}}),function(){this.emit("error","Could not select features")})}))}));return e},_gridDeselectListener:function(){var e=t(this.grid,"dgrid-deselect",g.hitch(this,function(e){this.emit("row-deselect",e.rows),this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText(),this._selectFeaturesFromIds()}))}));return e},_gridColumnStateChangeListener:function(){var e=t(this.grid,"dgrid-columnstatechange",g.hitch(this,function(e){this.emit("column-state-change",e)}));return e},_gridColumnResizeListener:function(){var e=t(this.grid,"dgrid-columnresize",g.hitch(this,function(e){this.emit("column-resize",e)}));return e},_gridErrorListener:function(){var e=t(this.grid,"dgrid-error",g.hitch(this,function(e){this.emit("error",e)}));return e},_gridSortListener:function(){var e=t(this.grid,"dgrid-sort",g.hitch(this,function(e){this.emit("sort",e)}));return e},_gridFilterListener:function(){var e=t(this.grid,"dgrid-filter",g.hitch(this,function(e){this.emit("filter",e)}));return e},_gridEditorShowListener:function(){var e=t(this.grid,"dgrid-editor-show",g.hitch(this,function(e){this.emit("editor-show",e)}));return e},_gridEditorHideListener:function(){var e=t(this.grid,"dgrid-editor-hide",g.hitch(this,function(e){this.emit("editor-hide",e)}));return e},_columnClickCallback:function(){var e=this.grid;return e.on(".dgrid-header .dgrid-cell:click",g.hitch(this,this._showColumnMenu))},_tableToggleClickCallback:function(){var e=t(this.tableCloseButton,"click",g.hitch(this,function(){this._toggleOpened?(c.remove(this.tableCloseButton,"toggleOpened"),c.add(this.tableCloseButton,"toggleClosed"),this._toggler.hide(),this._gridContentPane.domNode.style.display="none",this._resize()):(c.remove(this.tableCloseButton,"toggleClosed"),c.add(this.tableCloseButton,"toggleOpened"),this._toggler.show(),this._gridContentPane.domNode.style.display="block",this._resize()),this._toggleOpened=!this._toggleOpened}));return e},_resize:function(){this._gridBorderContainer.resize(),this._gridHeaderNode.resize(),this._gridContentPane.resize(),this.grid&&this.grid.resize()},_updateGridHeaderText:function(){this._gridTitleNode.innerHTML=h.substitute(this._i18nStrings.gridHeader,{gridTitle:this.featureLayer.name||this._i18nStrings.untitled,featureCount:this.featureCount,featureSelectedCount:this._featureSelectedCount})},_createTableToggle:function(){var e=new C({node:this.gridContentPaneId});return this._toggleOpened=!0,e},_toggleLoadingIndicator:function(e){this._gridLoadingIndicatorNode.style.display=e?"block":"none"},_showLoadError:function(){this._toggleLoadingIndicator(!1),this._gridTitleNode.innerHTML=this._i18nStrings.dataError},_showInfoWindow:function(){},_hideInfoWindow:function(){},_showColumnMenu:function(e){var i=this.grid.cell(e),n=i.column;if(n){var r,a,s,o=this.get("columnMenu"),d=n.id,l=this.columns[d],h=this.layerInfo.fieldInfos[d],u=h.type;o&&this.set({_oldColumnMenu:o,columnMenu:null});var c=new D({});if(l.sortable!==!1){if(this.featureCount>this.featureLayer.maxRecordCount&&!this.featureLayer.advancedQueryCapabilities.supportsPagination)return;r=[this._i18nStrings.sortAsc,this._i18nStrings.sortDesc],a=["iconSortAscending","iconSortDescending"],s=[this._sortAscending,this._sortDescending],p.forEach(r,function(e,t){var i=new H({label:e,iconClass:a[t],baseClass:this.css.menuItem,onClick:g.hitch(this,s[t],d)});c.addChild(i)},this)}if(this.featureLayer.supportsStatistics&&h&&!h.domain&&("esriFieldTypeDouble"===u||"esriFieldTypeSingle"===u||"esriFieldTypeInteger"===u||"esriFieldTypeSmallInteger"===u)){var f=new H({label:this._i18nStrings.statistics,iconClass:"iconTableStatistics",baseClass:this.css.menuItem,onClick:g.hitch(this,this._getColumnStats,d)});c.addChild(f)}c.startup(),c._openMyself({target:e.target,delegatedTarget:i,iframe:null,coords:{x:e.pageX,y:e.pageY}}),t(c,"close",g.hitch(this,function(){this._oldColumnMenu&&(this._oldColumnMenu.destroyRecursive(),this._oldColumnMenu=null)})),this.set("columnMenu",c)}},_sortAscending:function(e){this.dataStore instanceof $&&(this.set("_orderByFields",[this.columns[e].field+" ASC"]),this._createStoreFromDataQuery()),this.grid.set("sort",[{attribute:this.columns[e].field,descending:!1}]),this.emit("sort",{field:this.columns[e].field,descending:!1})},_sortDescending:function(e){this.dataStore instanceof $&&(this.set("_orderByFields",[this.columns[e].field+" DESC"]),this._createStoreFromDataQuery()),this.grid.set("sort",[{attribute:this.columns[e].field,descending:!0}]),this.emit("sort",{field:this.columns[e].field,descending:!0})},_getColumnStats:function(e){var t,i,n=this.columns[e].field,r=[],a=["count","sum","min","max","avg","stddev"],s=["countField","sumField","minField","maxField","avgField","stddevField"];t=new K,t.outFields=[n],t.outStatistics=[],t.where="1=1",p.forEach(a,function(e,i){var r=new J;r.statisticType=e,r.onStatisticField=n,r.outStatisticFieldName=s[i],r.displayFieldName=n,t.outStatistics.push(r)},this),this._filteredRowIds.length>0&&(r=this._filteredRowIds),t.where&&r.length>0&&(t.where="("+t.where+") AND ("+this.idProperty+" IN ("+r.toString()+"))"),i=new Z(this.featureLayer.url),i.execute(t).then(g.hitch(this,function(e){e.features&&e.features.length&&this._showStatisticsDialog(e,n)}),function(){this.emit("error","Could not get statistics.")})},_showStatisticsDialog:function(e,t){var i,n,r,a,s,o,d,h,c,f,m,g,p=e.features[0].attributes,y={},_={pattern:"#,###,###,##0.########"},b=["Number of Values","Sum of Values","Minimum","Maximum","Average","Standard Deviation"];this.statisticsDialog&&this.statisticsDialog.destroy(),i=u.create("div",{className:"esriAGOTableStatistics",innerHTML:""}),u.create("div",{className:"header",innerHTML:"Field: "+t},i),u.create("div",{className:"hzLine",innerHTML:""},i),n=u.create("table",{className:"attrTable",innerHTML:"",style:{cellpadding:0,cellspacing:0}},i);for(g in p)p.hasOwnProperty(g)&&(y[g.toLowerCase()]=p[g]);d=W.isDefined(y.countfield)?l.format(y.countfield,_):"",m=W.isDefined(y.sumfield)?l.format(y.sumfield,_):"",c=W.isDefined(y.minfield)?l.format(y.minfield,_):"",h=W.isDefined(y.maxfield)?l.format(y.maxfield,_):"",o=W.isDefined(y.avgfield)?l.format(l.round(y.avgfield,this._roundPos(y.avgfield)),_):"",f=W.isDefined(y.stddevfield)?l.format(l.round(y.stddevfield,this._roundPos(y.stddevfield)),_):"",r=u.create("tbody",{},n),a=u.create("tr",{valign:"top"},r),u.create("td",{"class":"attrName",innerHTML:b[0]},a),u.create("td",{"class":"attrValue",innerHTML:d},a),a=u.create("tr",{valign:"top"},r),u.create("td",{"class":"attrName",innerHTML:b[1]},a),u.create("td",{"class":"attrValue",innerHTML:m},a),a=u.create("tr",{valign:"top"},r),u.create("td",{"class":"attrName",innerHTML:b[2]},a),u.create("td",{"class":"attrValue",innerHTML:c},a),a=u.create("tr",{valign:"top"},r),u.create("td",{"class":"attrName",innerHTML:b[3]},a),u.create("td",{"class":"attrValue",innerHTML:h},a),a=u.create("tr",{valign:"top"},r),u.create("td",{"class":"attrName",innerHTML:b[4]},a),u.create("td",{"class":"attrValue",innerHTML:o},a),a=u.create("tr",{valign:"top"},r),u.create("td",{"class":"attrName",innerHTML:b[5]},a),u.create("td",{"class":"attrValue",innerHTML:f},a),u.create("div",{className:"break",innerHTML:""},i),this.statisticsDialog=new L({title:this._i18nStrings.statistics,content:i,baseClass:this.css.dialog}),s=u.create("button",{type:"button"},this.statisticsDialog.containerNode);var v=this;this._closeButton=new P({label:this._i18nStrings.close,baseClass:"primary dijitButton",onClick:function(){var e=v.statisticsDialog;e.hide().then(function(){e.destroyRecursive()})}},s),this.statisticsDialog.show(),this.emit("show-statistics",{dialog:this.statisticsDialog,statistics:p})},_createTableMenu:function(){this.gridMenu=new D({});var e=[this._i18nStrings.defaultSort,this._i18nStrings.showSelected,this._i18nStrings.clearSelection,this._i18nStrings.toggleColumns],t=[this._defaultSortOrder,this._showSelectedRecords,this._clearSelection,this._showHideColumns];this.map&&this.syncSelection&&(e.push("Center on Selection"),t.push(this._centerOnSelection)),this.menuFunctions.length>0&&p.forEach(this.menuFunctions,function(i){e.push(i.label),t.push(i.callback)},this),p.forEach(e,function(e,i){var n=new H({label:e,baseClass:this.css.menuItem,onClick:g.hitch(this,t[i])});this.gridMenu.addChild(n)},this),this.gridMenuAnchor=new E({label:_.widgets.geocodeMatch.match.tableOptionsLabel,dropDown:this.gridMenu},this.gridMenuNodeId),this.gridMenu.startup()},_defaultSortOrder:function(){this.dataStore instanceof $&&(this.set("_orderByFields",null),this._createStoreFromDataQuery()),this.grid.set("sort",[{attribute:this.idProperty,descending:!1}]),this.emit("sort",{field:this.idProperty,descending:!1})},_filterRows:function(){},_showSelectedRecords:function(){var e=this.selectedRowIds;this.set("_filteredRowIds",e),e&&e.length>0&&(this.dataStore instanceof $?this.emit("error","Unable to show current selection."):(this.grid.set("query",g.hitch(this,function(t){return-1!==e.indexOf(t[this.idProperty])?!0:!1})),this._gridQuery=!0),this.emit("filter",e))},_centerOnSelection:function(){var e=this.selectedRowIds,t=new K;t.objectIds=e,t.outFields=["*"],this.selectedRows.length>0&&this.selectedRowIds.length>0&&this.featureLayer.queryFeatures(t,g.hitch(this,function(e){this.map.setExtent(this._calcGraphicsExtent(e.features))}))},_clearSelection:function(){this.set("_filteredRowIds",[]),this._gridQuery&&(this.grid.set("query",{}),this.set("_gridQuery",!1)),this.grid.clearSelection(),this._updateGridSelection().then(g.hitch(this,function(){this._updateGridHeaderText(),this.featureLayer.clearSelection()})),this.emit("filter",{})},_showHideColumns:function(){this.grid._toggleColumnHiderMenu()},_exportToCSV:function(){},_roundPos:function(e){return e>=1e3?0:e>=10?2:e>=0?4:6},_generateLinkFromString:function(e){if(e&&"string"==typeof e){var t=e.indexOf("http:");if(-1===t&&(t=e.indexOf("https:")),t>-1&&-1===e.indexOf("href=")){var i=e.indexOf(" ",t);-1===i&&(i=e.length);var n=e.substring(t,i);e=e.substring(0,t)+"<a href='"+n+"' target='_blank'>"+n+"</a>"+e.substring(i,e.length)}}return e||null},_calcGraphicsExtent:function(e){var t=e[0].geometry;if(null===t&&1===e.length)return null;for(var i=e.length-1;i>=0;i--)null===e[i].geometry&&e.splice(i,1);var n,r,a=e[0].geometry,s=a.getExtent(),o=e.length;for(null===s&&(s=new X(a.x,a.y,a.x,a.y,a.spatialReference)),r=1;o>r;r+=1)t=e[r].geometry,n=t.getExtent(),null===n&&(n=new X(t.x,t.y,t.x,t.y,t.spatialReference)),s=s.union(n);return s},_generateDateFromLocale:function(e,t){var i=!1,n=!1,r={},a=t&&t.dateOptions?t.dateOptions:!1;return a?("undefined"!=typeof a.datePattern&&a.datePattern!==!1?(r.datePattern=a.datePattern||this.dateOptions.datePattern,i=!0):this.dateOptions&&null!==this.dateOptions.datePattern&&(r.datePattern=this.dateOptions.datePattern,i=a.datePattern===!1?!1:!0),a.timeEnabled||this.dateOptions.timeEnabled?(r.timePattern=a.timePattern||this.dateOptions.timePattern,n="undefined"!=typeof a.timeEnabled?a.timeEnabled:this.dateOptions.timeEnabled):this.dateOptions&&"undefined"!=typeof this.dateOptions.timeEnabled&&null!==this.dateOptions.timePattern&&(r.timePattern=this.dateOptions.timePattern,n=this.dateOptions.timeEnabled)):(this.dateOptions&&null!==this.dateOptions.datePattern&&(r.datePattern=this.dateOptions.datePattern,i=!0),this.dateOptions&&"undefined"!=typeof this.dateOptions.timeEnabled&&null!==this.dateOptions.timePattern&&(r.timePattern=this.dateOptions.timePattern,n=this.dateOptions.timeEnabled)),i&&n?r.selector="date and time":i&&!n?r.selector="date":!i&&n?r.selector="time":r.selecter="date",s.format(new Date(e),r)},_getCombinedDateTime:function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())},_findFirst:function(e,t,i){var n=p.filter(e,function(e){return e.hasOwnProperty(t)&&e[t]===i});return n&&n.length?n[0]:null}});return a("extend-esri")&&g.setObject("dijit.FeatureTable",et,Q),et});