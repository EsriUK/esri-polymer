// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/url","dojo/dom-construct","dojo/dom-style","dojo/has","dojo/Deferred","../lang","../domUtils","../urlUtils","../kernel","../config","../request","../SpatialReference","../geometry/Extent","./layer","./TileInfo","./unitBezier"],function(e,t,i,n,r,s,o,a,l,h,c,u,d,f,p,v,_,g,m){for(var y=t(_,{declaredClass:"esri.layers.VectorTileLayer",_mapsWithAttribution:["World_Basemap"],_eventMap:{"style-change":["style"]},constructor:function(e,t){this._displayLevels=t?t.displayLevels:null,this._glStyleApplied=!1,this._serviceOverrides={},this._style=null,t&&t.tileServers&&t.tileServers.length&&(this._serviceOverrides.tileServers=t.tileServers.map(function(e){if(Z.isMapboxUrl(e))return e;var t=c.getAbsoluteUrl(e),i=Z.getTokenFromUrl(t);return i?i.url+"?token="+i.token:c.urlToObject(t).path},this));var i=e;if("string"==typeof e){var n=Z.isMapboxUrl(e),r=n?e:c.getAbsoluteUrl(e);this._serviceOverrides.credential=Z.getTokenFromUrl(e),i=r}this.setStyle(i),this.registerConnectEvents()},setStyle:function(e){return e?(this._glStyleApplied=!1,this._serviceOverrides.credential="string"!=typeof e?null:Z.getTokenFromUrl(e),this._loadStyle(e)):void 0},getStyle:function(){if(!this._style)return null;var e=JSON.parse(JSON.stringify(this._style.stylesheet)),t=e.sources;return Object.keys(t).forEach(function(e){var i=t[e];i.tiles=(i.tiles||[]).map(function(e){return"string"!=typeof e&&(e=e.value),e})}),e},opacity:1,setOpacity:function(e){this.opacity!=e&&this.onOpacityChange(this.opacity=e)},onOpacityChange:function(){},refresh:function(){},_loadStyle:function(t){return(new a).resolve().then(function(){var t=new a,i=null==o("ie")||o("ie")>9;return i?w?w.supported()?t.resolve():t.reject(new Error("layer not supported"),!0):e(["./vector-tile"],function(e){w=e,w.supported()?t.resolve():t.reject(new Error("layer not supported"),!0)}):t.reject(new Error("layer not supported"),!0),t.promise}).then(function(){return w.tokenHandler?S=w.tokenHandler:(S=new K,w.tokenHandler=S),this._serviceOverrides&&this._serviceOverrides.credential&&S.addToken(this._serviceOverrides.credential),Z.loadMetadata(t,this._serviceOverrides)}.bind(this)).then(i.hitch(this,function(e){var i=e.layerDefinition;if(this.serviceUrl=e.serviceUrl||null,this.styleUrl=e.styleUrl||null,i){this.spatialReference=i.initialExtent&&i.initialExtent.spatialReference&&new p(i.initialExtent.spatialReference),this.initialExtent=i.initialExtent&&new v(i.initialExtent),this.fullExtent=i.fullExtent&&new v(i.fullExtent),this.version=i.currentVersion,this.tileInfo=new g(i.tileInfo),l.isDefined(i.minScale)&&!this._hasMin&&this.setMinScale(i.minScale),l.isDefined(i.maxScale)&&!this._hasMax&&this.setMaxScale(i.maxScale);var n=null;if(t){var r=c.urlToObject(e.serviceUrl),s=r.path.toLowerCase();n=this._getDefaultAttribution(this._getMapName(s))}n&&(this.attributionDataUrl=n,this.hasAttributionData=!0)}else this.spatialReference=j,this.initialExtent=L,this.fullExtent=z,this.tileInfo=U,this.version=null;for(var o,a=this.tileInfo,h=a.lods,d=this.scales=[],f=this._displayLevels,_=-1/0,m=1/0,y=0,S=h.length;S>y;y++)o=h[y],f&&-1===f.indexOf(o.level)||(d[y]=o.scale,_=o.scale>_?o.scale:_,m=o.scale<m?o.scale:m);_===-1/0||this._hasMin||this.setMinScale(_),1/0===m||this._hasMax||this.setMaxScale(m),this._style=e.style,this.gl&&(w.identityManager=u.id,this._applyGLStyle(this._style)),this.onStyleChange(this.getStyle())})).then(i.hitch(this,function(){this.loaded||this.loadError||(this.loaded=!0,this.onLoad(this))})).otherwise(i.hitch(this,function(e){throw this._errorHandler(e),e}))},_setMap:function(e,t){this.inherited(arguments),this._map=e;var n=this._div=r.create("div",null,t),o={position:"absolute",width:e.width+"px",height:e.height+"px",overflow:"visible",opacity:this.opacity};if(s.set(n,o),this._onResizeHandle=e.on("resize",i.hitch(this,this._onResizeHandler)),this._onOpacityHandle=this.on("opacity-change",i.hitch(this,this._opacityChangeHandler)),this._onScaleVisHandle=this.on("scale-visibility-change",i.hitch(this,function(){this._applyGLStyle(this._style)})),this._onVisibilityHandle=this.on("visibility-change",i.hitch(this,function(){this._applyGLStyle(this._style)})),w.identityManager=u.id,this.gl=new w.Renderer({container:n}),this.gl.setSize(e.width,e.height),this._applyGLStyle(this._style),this.evaluateSuspension(),this.suspended&&!e.loaded)var a=e.on("load",i.hitch(this,function(){a.remove(),this.evaluateSuspension()}));return n},_unsetMap:function(){this.gl.remove(),this.gl=null,this._glStyleApplied=!1,r.destroy(this._div),this._map=this._div=null,this._onResizeHandle=this._onResizeHandle&&this._onResizeHandle.remove()&&null,this._onOpacityHandle=this._onOpacityHandle&&this._onOpacityHandle.remove()&&null,this._onScaleVisHandle=this._onScaleVisHandle&&this._onScaleVisHandle.remove()&&null,this._onVisibilityHandle=this._onVisibilityHandle&&this._onVisibilityHandle.remove()&&null,this._disableDrawConnectors(),this._animation&&(this._animation.stop(),this._animation=null),this.inherited(arguments)},_applyGLStyle:function(e){if(!this._glStyleApplied){var t=this.gl;if(t)return e?void(this.visible&&this._isMapAtVisibleScale()&&(e.animationLoop=t.animationLoop,t.setStyle(e),e._loaded&&(Object.getOwnPropertyNames(e.sources).forEach(function(e){this.fire("source.add",{source:this.sources[e]})},e),e.fire("load"),e.sprite&&e.sprite.loaded()&&e.fire("change")),this._glStyleApplied=!0)):void t.setStyle(null)}},_enableDrawConnectors:function(){var e=this._map;e&&(this._panHandle=e.on("pan",i.hitch(this,this._onPanExtentChangeHandler)),this._extentChangeHandle=e.on("extent-change",i.hitch(this,this._onPanExtentChangeHandler)),this._onScaleHandle=e.on("scale",i.hitch(this,this._onScaleHandler)))},_disableDrawConnectors:function(){this._onScaleHandle=this._onScaleHandle&&this._onScaleHandle.remove()&&null,this._panHandle=this._panHandle&&this._panHandle.remove()&&null,this._extentChangeHandle=this._extentChangeHandle&&this._extentChangeHandle.remove()&&null},_getZoom:function(e){var t=this.tileInfo,i=t.lods,n=null,r=null,s=0,o=i.length-1;for(s;o>s;s++){if(n=i[s],r=i[s+1],n.scale<=e)return n.level;if(r.scale===e)return r.level;if(n.scale>e&&r.scale<e)return s=s+1-(e-r.scale)/(n.scale-r.scale),s=Math.ceil(s)-Math.log(Math.abs(Math.ceil(s)-s+1))/Math.LN2,(s-Math.floor(s)>.995||s-Math.floor(s)<.005)&&(s=Math.round(s)),i[s].level}return e>i[0].scale?i[0].level:i[i.length-1].level},_isMapAtVisibleScale:function(){var e=this.inherited(arguments);if(e){for(var t=this._map,i=this.scales,n=t.getScale(),r=!1,s=t.width>t.height?t.width:t.height,o=0,a=i.length;a>o;o++)if(Math.abs(i[o]-n)/i[o]<1/s){r=!0;break}e=r}return e},_getMapName:function(e){var t=e.match(/^https?\:\/\/(basemaps|basemapsbeta)\.arcgis\.com\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/vectortileserver/i);return t&&t[2]},_getDefaultAttribution:function(e){if(e){var t;e=e.toLowerCase();for(var i=0,n=this._mapsWithAttribution.length;n>i;i++)if(t=this._mapsWithAttribution[i],t.toLowerCase().indexOf(e)>-1)return"file:"===window.location.protocol?"http:":window.location.protocol+"//static.arcgis.com/attribution/Vector/"+t}},onStyleChange:function(){},_opacityChangeHandler:function(e){this.gl&&(this._div.style.opacity=e.opacity)},_onResizeHandler:function(e){if(this.gl){var t=e.extent.getCenter();this.gl.setSize(e.width,e.height),this.gl.jumpTo({center:[t.getLongitude(),t.getLatitude()]}),this._div.style.width=e.width+"px",this._div.style.height=e.height+"px"}},onSuspend:function(){this.inherited(arguments),h.hide(this._div),this._disableDrawConnectors()},onResume:function(){if(this.inherited(arguments),this.gl&&this._style){h.show(this._div);var e=this._map,t=this._getZoom(e.getScale()),i=e.extent.getCenter();this._animate(i,t,!0)}this._enableDrawConnectors()},_onPanExtentChangeHandler:function(e){var t=this._map,i=this._getZoom(t.getScale()),n=e.extent.getCenter();this._animate(n,i,!0)},_onScaleHandler:function(e){var t=this._map,i=t._zoomAnimDiv.anchor,n=t._zoomAnimDiv.extent.getCenter(),r=this._getZoom(t._zoomAnimDiv.newLod.scale,t._zoomAnimDiv.newLod.level);this._animate(n,r,e.immediate,i)},_animate:function(e,t,i,n){this._animation&&(this._animation.stop(),this._animation=null),this._animation=G(this.gl,e.getLongitude(),e.getLatitude(),t,i,this._map,n)}}),w=null,S=null,b=512,x=40075016.68557849,M=39.37007874015748,O=x/b,H=Object.freeze||function(){},C=[],k=0;20>k;k++){var A=O/Math.pow(2,k),E=Math.floor(96*A*M);C.push({level:k,scale:E,resolution:A})}var U=new g({rows:b,cols:b,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},spatialReference:{wkid:102100},lods:C});H(U);var j=new p(102100);H(j);var L=new v(-20037508.34,-20037508.34,20037508.34,20037508.34,j);H(L);var z=new v(-20037508.34,-20037508.34,20037508.34,20037508.34,j);H(z);var T,D=function(){var e,t=window.performance||{},i=t.now||t.webkitNow||t.msNow||t.oNow||t.mozNow;return void 0!==i?function(){return i.call(t)}:(e=window.performance&&window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:(new Date).getTime(),function(){return(new Date).getTime()-e})}(),R=o("ff"),N=o("ie"),V=o("webkit"),P=o("opera"),I=(new Date).getTime(),q=window.requestAnimationFrame;q||(T=V&&"webkit"||R&&"moz"||P&&"o"||N&&"ms",q=window[T+"RequestAnimationFrame"],q||(q=function(e){var t=D(),i=Math.max(0,16-(t-I)),n=window.setTimeout(function(){e(D())},i);return I=t+i,n}));var F=m.ease,G=function(e,t,i,n,r,s,o){if(r=r||0===d.defaults.map.zoomDuration)return e.jumpTo({center:[t,i],zoom:Math.ceil(n)-Math.log(Math.abs(Math.ceil(n)-n+1))/Math.LN2}),null;var a=!0,l=d.defaults.map.zoomDuration,h=e.transform.center.lat,c=e.transform.center.lng,u=e.transform.zoom,f=D()+16,p=o?[o.x-s.width/2,o.y-s.height/2]:null,v=function(){if(a){var r=D()+16,s=(r-f)/l;s>=1&&(s=1,a=!1);var o=F(s),d=u+(n-u)*o;if(d=Math.ceil(d)-Math.log(Math.abs(Math.ceil(d)-d+1))/Math.LN2,p)e.zoomTo(d,{animate:!1,offset:p});else{var _=h+(i-h)*o,g=c+(t-c)*o;e.jumpTo({center:[g,_],zoom:d})}a&&q(v)}};return v(),{stop:function(){a=!1}}},W=t(String,{constructor:function(e,t){this.value=e,this.token=t},valueOf:function(){var e=this.value,t=this.token;if(!t){var i=u.id&&u.id.findCredential(e);i&&i.token&&(t=i.token)}return t&&(e+=(-1===e.indexOf("?")?"?":"&")+"token="+t),e},toString:function(){return this.valueOf()},replace:function(e,t){return String.prototype.replace.call(this.valueOf(),e,t)}}),Z={loadMetadata:function(e,t){var i=null,n=null,r=t&&t.credential;return(new a).resolve(e).then(function(){return w.config.ACCESS_TOKEN=y.ACCESS_TOKEN,"string"!=typeof e?e:(Z.isMapboxUrl(e)?(n=e,i=w.normalizeStyleURL(e)):n=i=c.normalize(e).replace(/\/*$/,""),Z._corsify(i),i=Z._appendToken(i,r),f({url:i,content:{f:"json"},handleAs:"json"}))}).then(function(e){return Z._processMetadata(n,e,t)}).then(function(e){return Z._loadStyle(e,t)})},isMapboxUrl:function(e){return e.search(/^mapbox:\/\/styles\//)>-1},getTokenFromUrl:function(e){var t,i=e;if(!Z.isMapboxUrl(i)){var n=c.urlToObject(i);n.query&&n.query.token&&(t={url:n.path,token:n.query.token})}return t},_appendToken:function(e,t){return t&&t.token?e+=(-1===e.indexOf("?")?"?":"&")+"token="+t.token:e},_configureStyle:function(e,t){var i=e.layerDefinition,n=e.style,r=e.serviceUrl,s=e.styleUrl,o=Z._getAbsolutePath,a=Z._corsify;if(i&&n&&n.sources.esri){var l=i.tilejson||"2.0.0",h=i.tileInfo&&i.tileInfo.format||"pbf",c=i.tileMap?a(o(i.tileMap,r)):null,u=(i.tiles||[]).map(function(e){return new W(Z._getAbsolutePath(e.valueOf(),r),t&&t.credential&&t.credential.token)});n.sources.esri={type:"vector",scheme:"xyz",tilejson:l,format:h,index:c,tiles:u,description:i.description,name:i.name},u.forEach(a),n.glyphs=a(o(n.glyphs,s)),n.sprite=a(o(n.sprite,s))}return{style:n,layerDefinition:i,serviceUrl:r,styleUrl:s}},_loadStyle:function(e,t){var n=new a,r=e.style,s=r.sources;t&&t.tileServers&&Object.getOwnPropertyNames(s).forEach(i.hitch(this,function(i){var n=s[i],r=t.tileServers.map(function(i){return new W(Z._getAbsolutePath(i,e.serviceUrl,t))});n.tiles=r,r.forEach(Z._corsify)})),w.identityManager=u.id,r=new w.Style(r);var o=function(){r.off("load",o),r.off("error",l),e.style=r,n.resolve(e)},l=function(e){r.off("load",o),r.off("error",l),n.reject(e)};return r.on("load",o),r.on("error",l),n.promise},_getAbsolutePath:function(e,t){var i;if(t=t||"",t=c.urlToObject(t).path,/^https?:\/\//i.test(e))i=e;else{if(0===e.indexOf("//"))return location.protocol+e;t=t.replace(/(\/+\w+\.\w+)$/,""),/\/+$/.test(t)||(t+="/"),0===e.indexOf("/")?(e=e.substring(1),i=t+e):i=t+e}return c.normalize(i)},_corsify:function(e){e=e.valueOf();var t=d.defaults.io.corsEnabledServers;if(!c.canUseXhr(e)){var i=new n(e);i=(i.host+(i.port?":"+i.port:"")).toLowerCase(),-1===t.indexOf(i)&&t.push(i)}return e},_processMetadata:function(e,t,n){var r,s,o,a={},l=Z._getAbsolutePath,h=Z._configureStyle,c=Z._corsify,u=n&&n.credential;return delete t._ssl,t.currentVersion?(r=t,s=e,o=l(t.defaultStyles,s),f({url:Z._appendToken(o,u),content:{f:"json"},handleAs:"json"}).then(i.hitch(this,function(e){return h({style:e,layerDefinition:r,styleUrl:o,serviceUrl:s},n)}))):(a=t,o=e,t.sources.esri&&t.sources.esri.url?(s=c(l(t.sources.esri.url,o)),f({url:Z._appendToken(s,u),content:{f:"json"},handleAs:"json"}).then(i.hitch(this,function(e){return h({style:a,layerDefinition:e,styleUrl:o,serviceUrl:s},n)}))):h({style:a}))}},K=t([],{constructor:function(){this._credentials=[]},addToken:function(e){if(!e||!e.url||!e.token)return!1;var t=this.getServiceRoot(e.url);this._credentials.push({rootUrl:t,token:e.token})},findCredential:function(e){var t=-1,i=this._credentials,n=this.getServiceRoot(e);return i.some(function(e,i){var r=e.rootUrl;return r===n?(t=i,!0):void 0}),t>-1?i[t]:null},getServiceRoot:function(e){var t=/(.+\/rest\/services\/.*\/?vectortileserver)/i,i=/(.+\/sharing\/.*)/i;return t.test(e)?e.match(t)[1].toLowerCase():i.test(e)?e.match(i)[1].toLowerCase():null},shareSameService:function(e,t){return e=this.getServiceRoot(e),t=this.getServiceRoot(t),e=e.substr(e.indexOf(":")),t=t.substr(t.indexOf(":")),e===t}});return y.ACCESS_TOKEN=null,y});