// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/has","dojo/sniff","dojo/dom-style","dojox/gfx/Moveable","../kernel","../geometry/Point","../graphic","../geometry/webMercatorUtils"],function(e,t,i,o,s,n,r,a,h,c,l){var p=e(null,{declaredClass:"esri.toolbars.VertexMover",constructor:function(e,t,i,o,s,n,r,a){this.point=e,this.symbol=t,this.relatedGraphic=i,this.segIndex=o,this.ptIndex=s,this.segLength=n,this.editor=r,this.map=r.map,this._scratchGL=r.toolbar._scratchGL,this._placeholder=a||!1,this._type=i.geometry.type,this._init(),this._enable()},refresh:function(e){(e||this._needRefresh())&&(this._disable(),this._enable())},destroy:function(){this._disable(),this.graphic&&this._scratchGL.remove(this.graphic),this.point=this.symbol=this.graphic=this.relatedGraphic=this.segIndex=this.ptIndex=this.segLength=this.editor=this.map=this._scratchGL=null},_init:function(){var e=new h(this.point.toJson()),t=new c(e,this.symbol);switch(this._type){case"multipoint":t._shape=this.relatedGraphic.getDojoShape().children[this.ptIndex];break;case"polyline":case"polygon":this._scratchGL.add(t)}this.graphic=t},_enable:function(){var e=this.graphic.getDojoShape();if(e){e._hasMover=!0,this._moveable=this._getMoveable(e);var t=e.getEventSource();t&&n.set(t,"cursor",this.editor.toolbar._cursors[this._placeholder?"move-gv":"move-v"])}},_disable:function(){var e=this._moveable;if(e){i.disconnect(this._startHandle),i.disconnect(this._firstHandle),i.disconnect(this._movingHandle),i.disconnect(this._stopHandle);var t=e.shape;if(t){var o=t.getEventSource();o&&n.set(o,"cursor",null)}e.destroy(),this._moveable=null}},_needRefresh:function(){var e=this.graphic.getDojoShape(),t=!1;if(e)switch(this._type){case"multipoint":var i=this.relatedGraphic.getDojoShape();if(i){var o=i.children[this.ptIndex];e!==o&&(e=o,this.graphic._shape=e,t=!0)}break;case"polyline":case"polygon":t=!e._hasMover}return t},_getMoveable:function(e){var t=new r(e,s("mac")&&s("ff")&&!o("esri-touch")&&{leftButtonOnly:!0});return this._startHandle=i.connect(t,"onMoveStart",this,this._moveStartHandler),this._firstHandle=i.connect(t,"onFirstMove",this,this._firstMoveHandler),this._movingHandle=i.connect(t,"onMoving",this,this._movingHandler),this._stopHandle=i.connect(t,"onMoveStop",this,this._moveStopHandler),t},_getPtIndex:function(){return this.ptIndex+(this._placeholder?1:0)},_getInfo:function(){return{graphic:this.graphic,isGhost:this._placeholder,segmentIndex:this.segIndex,pointIndex:this._getPtIndex()}},_moveStartHandler:function(e){var t=this.map;t.snappingManager&&t.snappingManager._setUpSnapping(),t.disableScrollWheelZoom(),e.shape.moveToFront(),this.constructor.onMoveStart(this),this.editor.toolbar.onVertexMoveStart(this.relatedGraphic,this._getInfo())},_firstMoveHandler:function(e){var t,i=e.shape,o=this._getControlEdges(),s=this._scratchGL._div,n=[],r=e.host.shape._wrapOffsets[0]||0;for(t=0;t<o.length;t++){var a=o[t];a.x1+=r,a.x2+=r,n.push([s.createLine({x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2}).setStroke(this.editor._lineStroke),a.x1,a.y1,a.x2,a.y2])}i._lines=n,e.shape.moveToFront(),this.constructor.onFirstMove(this),this.editor.toolbar.onVertexFirstMove(this.relatedGraphic,this._getInfo())},_movingHandler:function(e,t,i){var s,n=this.map;o("esri-pointer")&&(s=n.navigationManager.pointerEvents._processTouchEvent(i,i),n.snappingManager&&n.snappingManager._onSnappingMouseMoveHandler(s));var r,a=e.shape,h=a.getTransform(),c=a._lines;for(r=0;r<c.length;r++){var l=c[r];l[0].setShape({x1:l[1]+h.dx,y1:l[2]+h.dy,x2:l[3],y2:l[4]})}this.editor.toolbar.onVertexMove(this.relatedGraphic,this._getInfo(),h)},_moveStopHandler:function(e){var t=e.shape,i=this.editor.toolbar,o=t.getTransform(),s=this.map,n=this.graphic,r=i._geo?l.geographicToWebMercator(n.geometry):n.geometry;s.enableScrollWheelZoom();var a,h=t._lines;if(h){for(a=0;a<h.length;a++)h[a][0].removeShape();t._lines=null}var c=!1,p=!0,d=this._getInfo();o&&(o.dx||o.dy)?this._placeholder&&(this._placeholder=!1,c=!0):p=!1;var g;s.snappingManager&&(g=s.snappingManager._snappingPoint);var _=g||s.toMap(s.toScreen(r).offset(o.dx,o.dy));s.snappingManager&&s.snappingManager._killOffSnapping(),t.setTransform(null),n.setGeometry(i._geo?l.webMercatorToGeographic(_,!0):_),this.constructor.onMoveStop(this,o),i.onVertexMoveStop(this.relatedGraphic,d,o),p||i.onVertexClick(this.relatedGraphic,d),c&&i.onVertexAdd(this.relatedGraphic,this._getInfo())},_getControlEdges:function(){var e=this.map,t=this.relatedGraphic.geometry,i=this.segIndex,o=this.ptIndex,s=this.segLength,n=this._scratchGL._div,r=n.getTransform(),a=r.dx,h=r.dy,c=e.toScreen(this.graphic.geometry),l=c.x-a,p=c.y-h,d=[],g=this.editor._getControlPoints(this,t,i,o,s);return g[0]&&d.push({x1:l,y1:p,x2:g[0].x-a,y2:g[0].y-h}),g[1]&&d.push({x1:l,y1:p,x2:g[1].x-a,y2:g[1].y-h}),d}});return o("extend-esri")&&t.setObject("toolbars.VertexMover",p,a),t.mixin(p,{onMoveStart:function(){},onFirstMove:function(){},onMoveStop:function(){}}),p});