// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["require","module","dojo/_base/array","dojo/_base/lang","dojo/has","dojo/Deferred","dojo/DeferredList","dojo/promise/all","dojo/when","dojo/on","../kernel","../Color","../numberUtils","../promiseList","../styles/type","../styles/size","../styles/choropleth","../styles/heatmap","../styles/predominance","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","./UniqueValueRenderer","./ClassBreaksRenderer","./HeatmapRenderer","./BlendRenderer","./utils","dojo/i18n!../nls/jsapi"],function(e,a,n,t,r,i,o,s,l,u,c,d,m,p,f,h,g,y,v,b,w,S,z,x,I,C,M,V){function R(n){return e.toAbsMid?e.toAbsMid(n):a.id.replace(/\/[^\/]*$/gi,"/")+n}function k(e,a){e.reject(new Error(a))}function F(e,a){e.loaded?a.call():u.once(e,"load",a)}function O(e,a,n,t){var r,i;switch(n){case"point":r=new b,r.setColor(a),r.setSize(null!=t?t:e.size),i=new w,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i);break;case"line":r=new w,r.setColor(a),r.setWidth(null!=t?t:e.width);break;case"polygon":r=new S,r.setColor(a),i=new w,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i)}return r}function T(e){var a=e.geometryType;return"esriGeometryPoint"===a||"esriGeometryMultipoint"===a?a="point":"esriGeometryPolyline"===a?a="line":"esriGeometryPolygon"===a&&(a="polygon"),a}function P(e,a){var n=e.scheme;return n?n=f.cloneScheme(n):(n=f.getSchemes({theme:e.theme||Sa,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function E(e,a){var n;return n=e.label<a.label?-1:e.label>a.label?1:0}function D(e,a){var n;return n=e.value<a.value?-1:e.value>a.value?1:0}function q(e,a){var n=a.count-e.count;return 0===n&&(n=E(e,a)),n}function B(e,a){var n=a.count-e.count;return 0===n&&(n=D(e,a)),n}function j(e,a,n){var r;t.isFunction(a)?r=a:"count"===a?(r=B,n&&n.codedValues&&(r=q)):"value"===a&&(r=D,n&&n.codedValues&&(r=E)),r&&e.sort(r)}function _(e,a,r){var i,o,s,l,u,c,d=r.layer,m=r.field,p=t.isFunction(m),f=m&&!p?d.getField(m):null,h=f?d.getDomain(f.name):null,g=-1,y=null==r.numTypes?10:-1===r.numTypes?e.length:r.numTypes,b=null==r.showOthers?!0:r.showOthers,w=null==r.sortBy?"count":r.sortBy,S=r&&r.labelCallback,x=T(d),I=P(r,x),C=new z(null,m),V=r.predominanceScheme,R=r.useSizeInfo;if(V){var k="polygon"===x,F=k&&R,E=V.sizeInfo,D=R?k?E.marker:E:null,q=F&&E?E.background:null;q&&(C.backgroundFillSymbol=O(q,q.color,"polygon")),c=k?F?D.size:null:"line"===x?V.width:V.size,u=c,I=V,x=F?"point":x}var B={domain:h,fieldInfo:f};for(n.forEach(e,function(e,a){B.value=e.value,e.label=M.createUniqueValueLabel(B),S&&(e.label=S(e)),null===e.value&&(g=a)}),g>-1&&(l=e.splice(g,1)[0]),j(e,w,h),f&&"esriFieldTypeDate"===f.type&&(B.dateFormatInterval=M.calculateDateFormatInterval(n.map(n.filter(e,function(e,a){return y>a}),function(e){return e.value}))),s=va.createColors(I.colors,e.length),n.forEach(e,function(e,a){B.value=e.value,e.label=M.createUniqueValueLabel(B),S&&(e.label=S(e)),e.symbol=O(I,s[a],x,c)}),r.valueExpression&&C.setValueExpression(r.valueExpression),s=va.createColors(I.colors,y),i=0;y>i;i++)o=e[i],o&&C.addValue({value:o.value,label:o.label,symbol:O(I,s[i],x,c)});return b&&(C.defaultSymbol=O(I,I.noDataColor,x,u),C.defaultLabel=wa.other),l&&(l.symbol=O(I,I.noDataColor,x,u),e.push(l)),a&&a.widthInfo&&C.setVisualVariables([a.widthInfo]),{renderer:C,uniqueValueInfos:e,othersStartIndex:C.infos.length===e.length?-1:C.infos.length,scheme:V?v.cloneScheme(V):P(r,x)}}function L(e,a,n,t){var r=_(e.uniqueValueInfos,a,n);r.source=e.source,t.resolve(r)}function W(e,a,n){var t=e.scheme;return t?t=g.cloneScheme(t):(t=g.getSchemes({theme:n||e.theme||za,basemap:e.basemap,geometryType:a}),t=t&&t.primaryScheme),t}function H(e){var a,n=e.avg,t=n-e.stddev,r=n+e.stddev;return t<e.min&&(t=e.min),r>e.max&&(r=e.max),a=m.round([t,r],{strictBounds:!0}),t=a[0],r=a[1],a=[t,t+(n-t)/2,n,n+(r-n)/2,r],m.round(a,{strictBounds:!0})}function Q(e,a,n){var t,r=(a-e)/(n-1),i=[e];for(t=1;n-2>=t;t++)i.push(e+t*r);return i.push(a),m.round(i,{strictBounds:!0})}function A(e,a){var n,t;return null==e.min?(n=0,t=100):e.min===e.max?e.min<0?(n=2*e.min,t=0):e.min>0?(n=0,t=2*e.min):(n=0,t=100):!a||null!=e.avg&&e.stddev||(n=e.min,t=e.max),null!=n?[n,t]:null}function U(e,a,t,r,i){var o=null==r.useDefaultStatistics?!0:r.useDefaultStatistics;if(e&&!e.count&&!o)return void k(i,"smartMapping.createColorInfo: cannot create renderer when statistics.count is 0.");var s,l,u,c=r.layer,p=r.field,f=T(c),h=W(r,f),g=r.semiContinuous,y=a&&a.classBreakInfos,v=y&&y.length,b=a?v:5;if(!h)return void k(i,"smartMapping.createColorInfo: unable to find the specified scheme.");var w=a&&h.id.indexOf("seq-")>-1?ea(h,{length:b}):va.createColors(h.colors,b);if(w.length<b)return void k(i,"smartMapping.createColorInfo: not enough colors in the scheme.");if(a){s=[];var S;1===v?(l=[y[0].minValue,y[0].maxValue],s=[0,1],S=va.createColors(w,b)[0],u=[S,new d(S)]):g?(l=[],u=[],n.forEach(y,function(e,a){var n=e.maxValue-e.minValue,t=.1*n;l.push(0===a?e.minValue:e.minValue+t),l.push(a===v-1?e.maxValue:e.maxValue-t),S=new d(w[a]),u.push(S),u.push(new d(S)),s.push(2*a),s.push(2*a+1)})):(l=n.map(y,function(e,a){return s.push(a),(e.minValue+e.maxValue)/2}),u=va.createColors(w,b)),l=m.round(l,{strictBounds:!0})}else{var z=o?A(e,!0):null;l=z?Q(z[0],z[1],5):H(e),s=[0,2,4],u=va.createColors(w,b)}var x={type:"colorInfo",field:p,normalizationField:t,stops:M.createColorStops({values:l,colors:u,labelIndexes:s})};i.resolve({colorInfo:x,statistics:e,classBreaks:a,scheme:W(r,f)})}function G(e,a,n,t,r,i){var o=r.layer,s=r.field,l=T(o),u=null==r.showOthers?!0:r.showOthers,c=g.cloneScheme(e.scheme),d=new x(null,s);u&&(d.defaultSymbol=O(c,c.noDataColor,l),d.defaultLabel=wa.other),d.addBreak({minValue:-ba,maxValue:ba,symbol:O(c,c.noDataColor,l)}),d.normalizationType=n,d.normalizationField=t;var m=[M.cloneColorInfo(e.colorInfo)];a&&a.widthInfo&&m.push(a.widthInfo),d.setVisualVariables(m),i.resolve({renderer:d,colorInfo:M.cloneColorInfo(e.colorInfo),statistics:e.statistics,classBreaks:e.classBreaks,scheme:g.cloneScheme(e.scheme)})}function N(e,a,n,t){var r=null==n.useDefaultStatistics?!0:n.useDefaultStatistics;if(e&&!e.count&&!r)return void k(t,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");var i=n.useStdDev,o=i?H(e):null,s=r?A(e,i):null,l=s||(i?[o[0],o[4]]:[e.min,e.max]),u={type:"opacityInfo",field:n.field,normalizationField:a,stops:[{value:l[0],opacity:.3},{value:l[1],opacity:.7}]};t.resolve({opacityInfo:u,statistics:e,defaultStatistics:!!s})}function $(e,a){var n=e.scheme;return n?n=h.cloneScheme(n):(n=h.getSchemes({theme:e.theme||xa,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function J(e,a){var n;switch(a){case"point":n=[e.minSize,e.maxSize];break;case"line":n=[e.minWidth,e.maxWidth];break;case"polygon":n=[e.marker.minSize,e.marker.maxSize]}return n}function K(e,a,n,t,r){var i=null==t.useDefaultStatistics?!0:t.useDefaultStatistics,o=a&&[a.minSize,a.maxSize];if(e&&!e.count&&!i)return void k(r,"smartMapping.createSizeInfo: cannot create renderer when statistics.count is 0.");var s=T(t.layer),l=$(t,s),u=o||J(l,s),c=t.useStdDev,d=c?H(e):null,m=i?A(e,c):null,p=m||(c?[d[0],d[4]]:[e.min,e.max]),f={type:"sizeInfo",field:t.field,valueExpression:t.valueExpression,valueUnit:"unknown",normalizationField:n,minSize:u[0],maxSize:u[1],minDataValue:p[0],maxDataValue:p[1]};r.resolve({sizeInfo:f,statistics:e,defaultStatistics:!!m,suggestedSizeRange:a,scheme:$(t,s)})}function X(e,a,n,t,r,i){var o=r.layer,s=r.field,l=T(o),u=null==r.showOthers?!0:r.showOthers,c=h.cloneScheme(e.scheme),d="polygon"===l,m=d?c.marker:c,p=d?c.background:null,f="line"===l?m.noDataWidth:m.noDataSize,g=new x(null,s);u&&(g.defaultSymbol=O(m,m.noDataColor,d?"point":l,f),g.defaultLabel=wa.other),g.addBreak({minValue:-ba,maxValue:ba,symbol:O(m,m.color,d?"point":l)}),p&&(g.backgroundFillSymbol=O(p,p.color,l)),g.normalizationType=n,g.normalizationField=t;var y=[M.cloneSizeInfo(e.sizeInfo)];a&&a.widthInfo&&y.push(a.widthInfo),g.setVisualVariables(y),i.resolve({renderer:g,sizeInfo:M.cloneSizeInfo(e.sizeInfo),statistics:e.statistics,defaultStatistics:e.defaultStatistics,suggestedSizeRange:e.suggestedSizeRange,scheme:h.cloneScheme(e.scheme)})}function Y(e,a,n){var t,r=[],i=1/(n+1);for(t=1;n>=t;t++)r.push(d.blendColors(e,a,i*t));return r}function Z(e,a){var n=[];if(1===a)n=[e[0]];else if(2===a)n=[e[0],e[2]];else if(3===a)n=e;else{var t,r,i=a-e.length,o=i/2;i%2===0?(t=Y(e[0],e[1],o),r=Y(e[1],e[2],o)):(t=Y(e[0],e[1],Math.floor(o)),r=Y(e[1],e[2],Math.ceil(o))),n=[e[0]].concat(t).concat([e[1]]).concat(r).concat([e[2]])}return n}function ea(e,a,t){var r,i=a.length,o=-1;if(t&&n.some(a,function(e,a){return e.hasAvg&&(o=a),o>-1}),o>-1){var s=e.colors,l=o+1,u=i-o,c=s.slice(0,3),d=s.slice(2);c.reverse(),c=Z(c,l),d=Z(d,u),c.reverse(),r=[].concat(c).concat(d.slice(1))}else{var m=e.colorsForClassBreaks;if(m&&m.length>0&&(n.some(m,function(e){return e.numClasses===i&&(r=e.colors),!!r}),!r)){var p=m[m.length-1],f=i-p.numClasses;if(f>0){var h,g=p.colors[p.numClasses-1];for(r=p.colors.splice(0),h=1;f>=h;h++)r.push(g)}}}return r&&(r=va.createColors(r,r.length)),r}function aa(e,a,t,r){var i,o,s,l=t.layer,u=t.field,c=T(l),d=null==t.showOthers?!0:t.showOthers,m=t.classificationMethod||"equal-interval",p="standard-deviation"===m,f=t.normalizationType,h="high-to-low",g=e.classBreakInfos;return(i=W(t,c,h))?(o=ea(i,g),o&&o.length==g.length?(s=new x(null,u),s.classificationMethod=m,s.normalizationType=f,s.normalizationField="field"===f?t.normalizationField:void 0,s.normalizationTotal="percent-of-total"===f?e.normalizationTotal:void 0,d&&(s.defaultSymbol=O(i,i.noDataColor,c),s.defaultLabel=wa.other),n.forEach(g,function(e,a){s.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:O(i,o[a],c),label:e.label})}),p||M.setLabelsForClassBreaks({classBreaks:s.infos,classificationMethod:m,normalizationType:f,round:!0}),a&&a.widthInfo&&s.setVisualVariables([a.widthInfo]),e.renderer=s,e.scheme=W(t,c,h),void r.resolve(e)):void k(r,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes.")):void k(r,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function na(e,a){return a.layer.statisticsPlugin.getClassBreaks(t.mixin(a,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:e[0],maxValue:e[1],normalizationTotal:e[0]+e[1]}))}function ta(e){var a=new i,n=e.layer,t=null==e.useDefaultBreaks?!0:e.useDefaultBreaks,r=e.optimizeOutline,s=[n.statisticsPlugin.getClassBreaks(e)];return r&&s.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof r?r:null)),new o(s).then(function(i){var o=i[0],s=i[1],u=r&&s[0]?s[1]:null;if(o[0]||t&&!n.graphics.length){var c=o[1],d=t?A(c?{min:c.minValue,max:c.maxValue}:{}):null;d&&(c=na(d,e)),l(c).then(function(e){e.defaultStatistics=!!d,a.resolve({cbResponse:e,suggestedOutline:u})}).otherwise(function(){k(a,"smartMapping: error when calculating default class breaks.")})}else k(a,"smartMapping: error when calculating class breaks.")}),a.promise}function ra(e,a,n,t){var r,i=t||J(e,a),o=i[0],s=i[1],l=(s-o)/(n>=4?n-1:n),u=[];for(r=0;n>r;r++)u.push(o+l*r);return u}function ia(e,a,t,r,i){var o,s=r.layer,l=r.field,u=T(s),c=null==r.showOthers?!0:r.showOthers,d=r.classificationMethod||"equal-interval",m=r.normalizationType,p=e.classBreakInfos,f=$(r,u),h=ra(f,u,p.length,a),g="polygon"===u,y=g?f.marker:f,v=g?f.background:null;o=new x(null,l),o.classificationMethod=d,o.normalizationType=m,o.normalizationField="field"===m?r.normalizationField:void 0,o.normalizationTotal="percent-of-total"===m?e.normalizationTotal:void 0,c&&(o.defaultSymbol=O(y,y.noDataColor,g?"point":u),o.defaultLabel=wa.other),v&&(o.backgroundFillSymbol=O(v,v.color,u)),n.forEach(p,function(e,a){o.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:O(y,y.color,g?"point":u,h[a]),label:e.label})}),"standard-deviation"!==d&&M.setLabelsForClassBreaks({classBreaks:o.infos,classificationMethod:d,normalizationType:m,round:!0}),t&&t.widthInfo&&o.setVisualVariables([t.widthInfo]),e.renderer=o,e.scheme=$(r,u),i.resolve(e)}function oa(e){var a=e.scheme;return a?a=y.cloneScheme(a):(a=y.getSchemes({theme:e.theme||Ia,basemap:e.basemap}),a=a&&a.primaryScheme),a}function sa(e,a,t){var r=null==a.useDefaultStatistics?!0:a.useDefaultStatistics;if(!e.count&&!r)return void k(t,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");var i=e.fieldOffset,o=null==a.blurRadius?10:a.blurRadius,s=null==a.minRatio?.01:a.minRatio,l=null==a.maxRatio?1:a.maxRatio,u=null==a.fadeToTransparent?!0:a.fadeToTransparent,c=oa(a),m=c.colors,p=m.length,f=!e.count&&r,h=f?[0,100]:[e.min,e.max],g=new I;g.setBlurRadius(o),g.setField(a.field),null!=i&&g.setFieldOffset(i),g.setMinPixelIntensity(h[0]),g.setMaxPixelIntensity(h[1]);var y=m[0],v=[{ratio:0,color:new d([y.r,y.g,y.b,0])},{ratio:Ca,color:new d([y.r,y.g,y.b,0])},{ratio:u?s:Ca,color:y}],b=(l-s)/(p-1);m=va.createColors(m,p),n.forEach(m,function(e,a){v.push({ratio:s+b*a,color:e})}),g.setColorStops(v),t.resolve({renderer:g,statistics:e,defaultStatistics:f,scheme:oa(a)})}function la(e,a){var n=e.scheme;return n?n=v.cloneScheme(n):(n=v.getSchemes({theme:e.theme||Sa,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function ua(e,a){var t={};return n.forEach(e,function(e){var n=a.getField(e.name);t[e.name]=e.label||n&&n.alias||e.name}),function(e){return t[e.value]}}function ca(e){return function(a,t){var r=n.indexOf(e,a.value),i=n.indexOf(e,t.value);return r-i}}function da(e,a,t,r,o){var s=new i,l=e.layer;return l.statisticsPlugin.getPredominantCategories({fields:a}).always(function(i){i&&i.predominantCategoryInfos||(i={predominantCategoryInfos:n.map(a,function(e){return{value:e,count:0}})});var u=_(i.predominantCategoryInfos,o,{layer:l,valueExpression:r.valueExpression,labelCallback:ua(e.fields,l),numTypes:-1,showOthers:e.showOthers,sortBy:ca(a),predominanceScheme:t,useSizeInfo:e.includeSizeInfo});u.predominantCategoryInfos=u.uniqueValueInfos,delete u.uniqueValueInfos,u.source=i.source,s.resolve(u)}),s.promise}function ma(e,a,n,t){var r=new i;return va.createSizeInfo({layer:e.layer,valueExpression:t.valueExpression,sqlExpression:t.statisticsQuery.sqlExpression,sqlWhere:t.statisticsQuery.sqlWhere,scheme:n,optimizeForScale:e.optimizeForScale}).then(function(e){e.sizeInfo.legendOptions={title:wa.sumOfCategories},r.resolve(e)}).otherwise(function(){k(r,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(size).")}),r.promise}function pa(e,a,n){var t=new i;return e.layer.statisticsPlugin.getFieldStatistics({valueExpression:n.valueExpression,sqlExpression:n.statisticsQuery.sqlExpression,sqlWhere:n.statisticsQuery.sqlWhere}).then(function(e){var r=null==e.avg||null==e.stddev,i=1/a.length*100,o=r?100:e.avg+1.285*e.stddev;o>100&&(o=100);var s=m.round([i,o],{strictBounds:!0});t.resolve({opacityInfo:{type:"opacityInfo",valueExpression:n.valueExpression,stops:[{value:s[0],opacity:.15},{value:s[1],opacity:1}],legendOptions:{title:wa.strengthOfPredominance}},statistics:e,defaultStatistics:r})}).otherwise(function(){k(t,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(opacity).")}),t.promise}function fa(e,a,n,t){var r=T(e.layer),i=la(e,r);e.layer.statisticsPlugin.getPredominanceExpressions({fields:a}).then(function(r){var o,s,l=da(e,a,i,r.predominantCategory,n);e.includeSizeInfo&&(o=ma(e,a,i.sizeInfo,r.size)),e.includeOpacityInfo&&(s=pa(e,a,r.opacity)),p([l,o,s]).then(function(e){var a,n=e[0],r=e[1],i=e[2],l=[];if(n instanceof Error)k(t,"smartMapping.createPredominanceRenderer: unable to create unique-value renderer.");else{if(a=n,o){if(r instanceof Error)return void k(t,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol size.");l.push(M.cloneSizeInfo(r.sizeInfo)),delete r.scheme,a.size=r}if(s){if(i instanceof Error)return void k(t,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol opacity.");l.push(M.cloneOpacityInfo(i.opacityInfo)),a.opacity=i}if(l.length){var u=a.renderer.visualVariables;u&&(Array.prototype.push.apply(u,l),l=u),a.renderer.setVisualVariables(l)}t.resolve(a)}})}).otherwise(function(){k(t,"smartMapping.createPredominanceRenderer: unable to generate expressions.")})}function ha(e,a){var t,r,i,o,s,l,u,c,d={};return t=n.filter(e,function(e){return r=e.name,i=r.toLowerCase(),l=r!==a&&-1===n.indexOf(Va,i),l&&(u=u||(n.indexOf(Fa,e.type)>-1?r:null),c=c||("esriFieldTypeString"===e.type?r:null)),l}),n.forEach(t,function(e){r=e.name,i=r.toLowerCase(),o=n.indexOf(Fa,e.type)>-1,o&&(d=ga(r,i,Ra,d,"number")),d.rank&&"string"!==d.fieldType||(s="esriFieldTypeString"===e.type,s&&(d=ga(r,i,ka,d,"string")))}),d.fieldName||u||c}function ga(e,a,n,t,r){var i=ya(a,n);return i.exactRank>-1&&(!t.rank||t.fieldType!==r||"exact"===t.matchType&&t.fieldType===r&&t.rank>i.exactRank)?t={rank:i.exactRank,matchType:"exact",fieldType:r,fieldName:e}:i.containRank>-1&&(!t.rank||t.fieldType===r&&"contains"===t.matchType&&t.rank>i.containRank)&&(t={rank:i.containRank,matchType:"contains",fieldType:r,fieldName:e}),t}function ya(e,a){var t,r=-1,i=-1;for(r=n.indexOf(a,e),t=0;t<a.length;t++)if(e.indexOf(a[t])>-1){i=t;break}return{exactRank:r,containRank:i}}var va={},ba=Math.pow(2,53)-1,wa=V.smartMapping,Sa="default",za="high-to-low",xa="default",Ia="default",Ca=.01,Ma=/https?:\/\/services.*\.arcgis\.com/i,Va=["id","fips","fid","objectid","_objectid","__objectid","x","y","lat","long","latitude","longitude","shape","shape_length","shape_leng","shape_area","perimeter","stretched_value","fnode_","tnode_","lpoly_","rpoly_","poly_","subclass","rings_ok","rings_nok","st_length(shape)","st_area(shape)"],Ra=["count","percent","sum","elevation","value","valore","valoare","total","gesamt","score","income","age","expected","average","median","size","cost","expenditure","revenue","profit","growth","sale","quantity","population","price","unit","length","width","difference","distance"],ka=["type","name","status","class","category","code","value","label","zone","symbol","color","owner","district","group","species","rating","score","party"],Fa=["esriFieldTypeInteger","esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeSmallInteger"],Oa=R("../plugins/FeatureLayerStatistics");return t.mixin(va,{createColors:function(e,a){var n,t=[],r=e.length;for(n=0;a>n;n++)t.push(new d(e[n%r]));return t},createTypeRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field&&(e.scheme||e.basemap)))return k(a,"smartMapping.createTypeRenderer: missing parameters."),a.promise;var n=e.layer,t=e.optimizeOutline;return n.addPlugin(Oa).then(function(){var r=[n.statisticsPlugin.getUniqueValues({field:e.field,includeAllCodedValues:e.includeAllCodedValues})];t&&r.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof t?t:null)),new o(r).then(function(n){var r=n[0],i=n[1],o=t&&i[0]?i[1]:null;r[0]?L(r[1],o,e,a):k(a,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(){k(a,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createColorInfo:function(e){var a=new i;if(!(e&&e.layer&&e.field))return k(a,"smartMapping.createColorInfo: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0;return e.statistics?U(e.statistics,null,t,e,a):n.addPlugin(Oa).then(function(){var i="group-similar"===e.theme||e.scheme&&0===e.scheme.id.indexOf("group-similar/"),o=i?n.statisticsPlugin.getClassBreaks({field:e.field,classificationMethod:"natural-breaks",numClasses:e.numGroups||5,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue}):n.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue});o.then(function(n){var r,o;i?r=n:o=n,U(o,r,t,e,a)}).otherwise(function(){k(a,i?"smartMapping.createColorInfo: error when calculating class breaks.":"smartMapping.createColorInfo: error when calculating field statistics.")})}).otherwise(function(){k(a,"smartMapping.createColorInfo: error when adding feature layer statistics plugin.")}),a.promise},createColorRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field))return k(a,"smartMapping.createColorRenderer: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0,s=e.optimizeOutline;return n.addPlugin(Oa).then(function(){var i=[va.createColorInfo(e)];s&&i.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof s?s:null)),new o(i).then(function(n){var i=n[0],o=n[1],l=s&&o[0]?o[1]:null;i[0]?G(i[1],l,r,t,e,a):k(a,"smartMapping.createColorRenderer: error when calculating colorInfo.")})}).otherwise(function(){k(a,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")}),a.promise},createOpacityInfo:function(e){var a=new i;if(!(e&&e.layer&&e.field))return k(a,"smartMapping.createOpacityInfo: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0;return e.statistics?N(e.statistics,t,e,a):n.addPlugin(Oa).then(function(){n.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue,features:e.features}).then(function(n){N(n,t,e,a)}).otherwise(function(){k(a,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(){k(a,"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")}),a.promise},createBlendRenderer:function(e){var a,t,r=new i,o=this,l=[],u={},c=[],m=[],p=e.opacityValueCombinationMethod||"avg",f={};return e&&e.layer&&e.blendedFields?(e.basemap=e.basemap||"topo",t=T(e.layer),a=P({basemap:e.basemap},t),a.colors=[new d("#e60000"),new d("#0000e6"),new d("#00e600"),new d("#e67300"),new d("#a900e6")],f.fields=[],f.normalizationField=e.normalizationField,f.blendMode=e.blendMode||"source-over",f.symbol=O(a,a.noDataColor,e.markers?"point":t),u.layer=e.layer,u.normalizationField=e.normalizationField,u.useStdDev=e.useStdDev||!1,l=n.map(e.blendedFields,function(e,n){return f.fields.push({field:e,color:a.colors[n]}),u.field=e,o.createOpacityInfo(u)}),s(l).then(function(t){m[0]=t[0].opacityInfo.stops[0].value,m[1]=t[1].opacityInfo.stops[1].value,n.forEach(t.slice(0,1),function(e){var a=e.opacityInfo.stops[0].value,n=e.opacityInfo.stops[1].value;"union"===p?(m[0]=a<m[0]?a:m[0],m[1]=n>m[1]?n:m[1]):"avg"===p&&(m[0]+=e.opacityInfo.stops[0].value,m[1]+=e.opacityInfo.stops[1].value)}),c[0]={value:"avg"===p?m[0]/t.length:m[0],opacity:e.minOpacity?e.minOpacity:t[0].opacityInfo.stops[0].opacity},c[1]={value:"avg"===p?m[1]/t.length:m[1],opacity:e.maxOpacity?e.maxOpacity:t[0].opacityInfo.stops[1].opacity},f.opacityStops=c,r.resolve({renderer:new C(f),scheme:a,opacityInfos:t})}),r.promise):(k(r,"smartMapping.createBlendRenderer: missing parameters."),r.promise)},createSizeInfo:function(e){var a=new i;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return k(a,"smartMapping.createSizeInfo: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0,s=e.optimizeForScale;return e.statistics?K(e.statistics,null,t,e,a):n.addPlugin(Oa).then(function(){var i=[n.statisticsPlugin.getFieldStatistics({field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue})];s&&i.push(n.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:s===!0?"map-scale":s})),new o(i).then(function(n){var r=n[0],i=s&&n[1],o=s&&i[0]?i[1]:null;r[0]?K(r[1],o,t,e,a):k(a,"smartMapping.createSizeInfo: error when calculating field statistics.")})}).otherwise(function(){k(a,"smartMapping.createSizeInfo: error when adding feature layer statistics plugin.")}),a.promise},createSizeRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field))return k(a,"smartMapping.createSizeRenderer: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0,s=e.optimizeOutline;return n.addPlugin(Oa).then(function(){var i=[va.createSizeInfo(e)];s&&i.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof s?s:null)),new o(i).then(function(n){var i=n[0],o=n[1],l=s&&o[0]?o[1]:null;i[0]?X(i[1],l,r,t,e,a):k(a,"smartMapping.createSizeRenderer: error when calculating sizeInfo.")})}).otherwise(function(){k(a,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createClassedColorRenderer:function(e){var a,n=new i,r=e.minValue,o=e.maxValue;if(!(e&&e.layer&&e.field))return k(n,"smartMapping.createClassedColorRenderer: missing parameters."),n.promise;if(a=null!=r&&null!=o,!a&&(null!=r||null!=o))return k(n,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),n.promise;e=t.mixin({analyzeData:!a},e);var s=e.layer;return s.addPlugin(Oa).then(function(){ta(e).then(function(a){aa(a.cbResponse,a.suggestedOutline,e,n)}).otherwise(function(){k(n,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(){k(n,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")}),n.promise},createClassedSizeRenderer:function(e){var a,n=new i,r=e.minValue,o=e.maxValue;if(!(e&&e.layer&&e.field))return k(n,"smartMapping.createClassedSizeRenderer: missing parameters."),n.promise;if(a=null!=r&&null!=o,!a&&(null!=r||null!=o))return k(n,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),n.promise;e=t.mixin({analyzeData:!a},e);var s=e.layer;return s.addPlugin(Oa).then(function(){ta(e).then(function(a){e.optimizeForScale?s.statisticsPlugin.getSuggestedSizeRange().then(function(t){var r=[t.minSize,t.maxSize];ia(a.cbResponse,r,a.suggestedOutline,e,n)}).otherwise(function(){ia(a.cbResponse,null,a.suggestedOutline,e,n)}):ia(a.cbResponse,null,a.suggestedOutline,e,n)}).otherwise(function(){k(n,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(){k(n,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")}),n.promise},createHeatmapRenderer:function(e){var a=new i;if(!e||!e.layer)return k(a,"smartMapping.createHeatmapRenderer: missing parameters."),a.promise;var n=e.layer;return e.statistics?sa(e.statistics,e,a):n.addPlugin(Oa).then(function(){n.statisticsPlugin.getHeatmapStatistics(e).then(function(n){sa(n,e,a)}).otherwise(function(){k(a,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(){k(a,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")}),a.promise},applyHeatmapScheme:function(e){if(!(e&&e.renderer&&e.scheme))return void console.log("smartMapping.applyHeatmapScheme: missing parameters.");var a=oa({scheme:e.scheme}),r=e.renderer,i=r.colorStops,o=a.colors;if(i.length!==o.length+3)return void console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");var s,l=new d(o[0]),u=n.map(i,function(e){return t.mixin({},e)});for(u[0].color=new d([l.r,l.g,l.b,0]),u[1].color=new d([l.r,l.g,l.b,0]),u[2].color=l,s=3;s<u.length;s++)u[s].color=o[s-3];r.setColorStops(u)},sampleSize:500,createPredominanceRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.fields&&e.fields.length>1))return k(a,"smartMapping.createPredominanceRenderer: missing parameters."),a.promise;if(e.fields.length>5)return k(a,"smartMapping.createPredominanceRenderer: too many fields. Maximum supported is 5."),a.promise;var t=e.layer;return t.addPlugin(Oa).then(function(){var r=(e.sampleSize||va.sampleSize,n.map(e.fields,function(e){return e.name}));F(t,function(){var i=t.getOutFields()||[],o=-1!==n.indexOf(i,"*"),s=e.optimizeOutline,u=o?null:n.filter(r,function(e){return-1===n.indexOf(i,e)}),c=t.advancedQueryCapabilities&&t.advancedQueryCapabilities.supportsSqlExpression;if(t.url)if(c&&(t.useStandardizedQueries||Ma.test(t.url)))if(u&&u.length)k(a,"smartMapping.createPredominanceRenderer: make sure the layer is configured to fetch all fields specified in parameters.");else{var d=s?t.statisticsPlugin.getSuggestedOutline("object"==typeof s?s:null):null;l(d).always(function(n){n&&!n.widthInfo&&(n=null),fa(e,r,n,a)})}else k(a,"smartMapping.createPredominanceRenderer: predominance renderer is not supported for this layer. Make sure the layer supports advanced SQL expressions and standardized queries.");else k(a,"smartMapping.createPredominanceRenderer: feature collection is not supported.")})}).otherwise(function(){k(a,"smartMapping.createPredominanceRenderer: error when adding feature layer statistics plugin.")}),a.promise},excludedFields:Va,getSuggestedField:function(e){var a=new i;return e&&(e.layer||e.fields&&e.objectIdField)?(e.layer?F(e.layer,function(){a.resolve(ha(e.layer.fields,e.layer.objectIdField))}):a.resolve(ha(e.fields,e.objectIdField)),a.promise):(k(a,"smartMapping.getSuggestedField: missing parameters."),a.promise)}}),r("extend-esri")&&t.setObject("renderer.smartMapping",va,c),va});