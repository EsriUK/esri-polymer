// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/array","dojo/has","dojo/date/locale","../kernel","../numberUtils","../Color","dojo/i18n!../nls/jsapi","dojo/i18n!dojo/cldr/nls/gregorian"],function(e,a,t,n,o,r,l,i,s){function u(e){return e&&a.map(e,function(e){return new l(e)})}var c={},m={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%"},d={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},f="dateTimeFormat-medium",g={millisecond:[{formatLength:"long",selector:"date"},{formatLength:"medium",selector:"time"}],second:[{formatLength:"long",selector:"date"},{formatLength:"medium",selector:"time"}],minute:[{formatLength:"long",selector:"date"},{formatLength:"short",selector:"time"}],hour:[{formatLength:"long",selector:"date"},{formatLength:"short",selector:"time"}],day:[{formatLength:"long",selector:"date"}],month:[{formatLength:"long",selector:"date"}],year:[{selector:"year"}]};return e.mixin(c,{createColorStops:function(e){var t=e.values,n=e.colors,o=e.labelIndexes,l=[];return l=a.map(t,function(e,l){var i="";return 0===l?i=m.lt+" ":l===t.length-1&&(i=m.gt+" "),{value:e,color:n[l],label:!o||a.indexOf(o,l)>-1?i+r.format(e):null}})},updateColorStops:function(e){var t,n=e.stops,o=e.changes,l=[],i=a.map(n,function(e){return e.value});a.forEach(o,function(e){l.push(e.index),i[e.index]=e.value}),t=r.round(i,{indexes:l}),a.forEach(n,function(e,a){e.value=i[a];var o="";0===a?o=m.lt+" ":a===n.length-1&&(o=m.gt+" "),e.label=null!=e.label?o+r.format(t[a]):null})},createClassBreakLabel:function(e){var a=e.minValue,t=e.maxValue,n=e.isFirstBreak,o=e.normalizationType,l=n?"":m.gt+" ",s="percent-of-total"===o?m.pct:"";return a=null==a?"":r.format(a),t=null==t?"":r.format(t),l+a+s+" "+i.smartMapping.minToMax+" "+t+s},setLabelsForClassBreaks:function(e){var t=e.classBreaks,n=e.classificationMethod,o=e.normalizationType,l=[];t&&t.length&&("standard-deviation"===n?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):e.round?(l.push(t[0].minValue),a.forEach(t,function(e){l.push(e.maxValue)}),l=r.round(l),a.forEach(t,function(e,a){e.label=c.createClassBreakLabel({minValue:0===a?l[0]:l[a],maxValue:l[a+1],isFirstBreak:0===a,normalizationType:o})})):a.forEach(t,function(e,a){e.label=c.createClassBreakLabel({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===a,normalizationType:o})}))},updateClassBreak:function(e){var a,t=e.classBreaks,n=e.classificationMethod,o=e.normalizationType,r=e.change,l=r.index,i=r.value,s=-1,u=-1,m=t.length;return"standard-deviation"===n?void console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===l?s=l:l===m?u=l-1:(u=l-1,s=l),s>-1&&m>s&&(a=t[s],a.minValue=i,a.label=c.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===s,normalizationType:o})),void(u>-1&&m>u&&(a=t[u],a.maxValue=i,a.label=c.createClassBreakLabel({minValue:a.minValue,maxValue:a.maxValue,isFirstBreak:0===u,normalizationType:o}))))},calculateDateFormatInterval:function(e){var t,n,o,r,l,i,s,u,c,m,f=e.length,g=1/0;for(e=a.map(e,function(e){return new Date(e)}),t=0;f-1>t;t++){for(o=e[t],l=[],u=1/0,c="",n=t+1;f>n;n++)r=e[n],i=o.getFullYear()!==r.getFullYear()&&"year"||o.getMonth()!==r.getMonth()&&"month"||o.getDate()!==r.getDate()&&"day"||o.getHours()!==r.getHours()&&"hour"||o.getMinutes()!==r.getMinutes()&&"minute"||o.getSeconds()!==r.getSeconds()&&"second"||"millisecond",s=d[i],u>s&&(u=s,c=i),l.push(i);g>u&&(g=u,m=c)}return m},createUniqueValueLabel:function(e){var t=e.value,o=e.fieldInfo,l=e.domain,i=e.dateFormatInterval,u=String(t),c=l&&l.codedValues?l.getName(t):null;if(c)u=c;else if("number"==typeof t)if(o&&"esriFieldTypeDate"===o.type){var m=new Date(t);if(i&&g[i]){var d=a.map(g[i],function(e){return n.format(m,e)}).reverse();u=1==d.length?d[0]:s[f].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(e,a){return d[a]})}else u=n.format(m)}else u=r.format(t);return u},cloneColorInfo:function(t){var n;return t&&(n=e.mixin({},t),n.colors=u(n.colors),n.stops=n.stops&&a.map(n.stops,function(a){return a=e.mixin({},a),a.color&&(a.color=new l(a.color)),a})),n},cloneOpacityInfo:function(t){var n;if(t){n=e.mixin({},t);var o=n.opacityValues;o&&(n.opacityValues=o.slice(0)),o=n.stops,o&&(n.stops=a.map(o,function(a){return e.mixin({},a)})),o=n.legendOptions,o&&(n.legendOptions=e.mixin({},o))}return n},cloneSizeInfo:function(t){var n;if(t){n=e.mixin({},t),n.stops&&(n.stops=a.map(n.stops,function(a){return e.mixin({},a)}));var o=n.minSize;o&&"object"==typeof o&&(n.minSize=c.cloneSizeInfo(o)),o=n.maxSize,o&&"object"==typeof o&&(n.maxSize=c.cloneSizeInfo(o)),o=n.legendOptions,o&&(n.legendOptions=e.mixin({},o),o=o.customValues,o&&(n.legendOptions.customValues=o.slice(0)))}return n}}),t("extend-esri")&&e.setObject("renderer.utils",c,o),c});