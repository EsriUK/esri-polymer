// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.16/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojox/gfx/_base","../kernel","../Color","../arcade/arcade"],function(t,e,o,i,n,r,a,s){var l=Math.PI,c=t(null,{declaredClass:"esri.renderer.Renderer",constructor:function(t){if(this._cache={},t&&!t.declaredClass){if(this.rotationInfo=t.rotationInfo,!this.rotationInfo){var o=t.rotationType,i=t.rotationExpression;(o||i)&&(this.rotationInfo={type:o,expression:i})}this.setRotationInfo(this.rotationInfo),this.setSizeInfo(this._readSizeInfo(t.sizeInfo)),this.setColorInfo(this._readColorInfo(t.colorInfo)),this.setOpacityInfo(this._readOpacityInfo(t.transparencyInfo)),this.setVisualVariables(this._readVariables(t.visualVariables)),this.setAuthoringInfo(t.authoringInfo)}this.getSymbol=e.hitch(this,this.getSymbol)},getSymbol:function(){},_readSizeInfo:function(t){if(t){var e=t.minSize,o=t.maxSize;e&&"number"==typeof e&&(t.minSize=n.pt2px(e)),o&&"number"==typeof o&&(t.maxSize=n.pt2px(o))}return t},_readColorInfo:function(t){return t&&(o.forEach(t.colors,function(o,i){e.isArray(o)&&(t.colors[i]=a.toDojoColor(o))}),o.forEach(t.stops,function(o,i){o.color&&e.isArray(o.color)&&(t.stops[i].color=a.toDojoColor(o.color))})),t},_readOpacityInfo:function(t){var i;return t&&(i=e.mixin({},t),i.transparencyValues&&(i.opacityValues=o.map(i.transparencyValues,function(t){return 1-t/100}),delete i.transparencyValues),i.stops&&(i.stops=o.map(i.stops,function(t){return t=e.mixin({},t),t.opacity=1-t.transparency/100,delete t.transparency,t}))),i},_readVariables:function(t){return t&&(t=o.map(t,function(t){return"sizeInfo"===t.type?t=this._readSizeInfo(t):"colorInfo"===t.type?t=this._readColorInfo(t):"transparencyInfo"===t.type&&(t=this._readOpacityInfo(t),t.type="opacityInfo"),t},this)),t},setAuthoringInfo:function(t){this.authoringInfo=t},setRotationInfo:function(t){var o=this.rotationInfo="string"==typeof t?{field:t}:t;if(o){if(o.expression&&!e.isFunction(o.expression)&&!o.field){var i=o.expression.match(this.rotationRE);i&&i[1]&&(o.field=i[1])}o.rotationType=o.type}return this},rotationRE:/^\[([^\]]+)\]$/i,getRotationAngle:function(t,o){var i=this._getVarInfo(o&&o.rotationInfo,"rotationInfo"),n=i.variable,r="arithmetic"===this._getRotationType(n),a=n.field,s=t.attributes,l=0;return a&&(e.isFunction(a)?l=a.apply(this,arguments):s&&(l=s[a]||0),l=(l+(r?-90:0))*(r?-1:1)),l},_getRotationType:function(t){return t&&("rotationInfo"===t.type?t.rotationType:t.type)},setVisualVariables:function(t){var e=this._cache;o.forEach(this.visualVariables,function(t,o){e.hasOwnProperty(o)&&(e[o]=null)},this),this.visualVariables=t;var i=o.some(t,function(t){return!!t.target});return i&&t.sort(function(t,e){var o;return o=t.target===e.target?0:t.target?1:-1}),o.forEach(t,function(t,o){"colorInfo"===t.type?e[o]=this._processColorInfo(t):"opacityInfo"===t.type?e[o]=this._processOpacityInfo(t):"sizeInfo"===t.type&&(e[o]=this._processSizeInfo(t))},this),this},getVisualVariableValues:function(t){var e,i=this.visualVariables;return i&&(e=o.map(i,function(e){var o;switch(e.type){case"sizeInfo":o=this.getSize(t,{sizeInfo:e});break;case"colorInfo":o=this.getColor(t,{colorInfo:e});break;case"opacityInfo":o=this.getOpacity(t,{opacityInfo:e});break;case"rotationInfo":o=this.getRotationAngle(t,{rotationInfo:e})}return{variable:e,value:o}},this)),e},hasVisualVariables:function(t,e){return t?!!this.getVisualVariablesForType(t,e):!!(this.getVisualVariablesForType("sizeInfo",e)||this.getVisualVariablesForType("colorInfo",e)||this.getVisualVariablesForType("opacityInfo",e)||this.getVisualVariablesForType("rotationInfo",e))},getVisualVariablesForType:function(t,e){var i,n=this.visualVariables;return!e&&this[t]?("rotationInfo"===t&&(this[t].rotationType=this[t].type),i=[this[t]]):n&&(i=o.filter(n,function(o){return o.type===t&&("string"==typeof e?o.target===e:e===!1?!o.target:!0)}),i&&0===i.length&&(i=void 0)),i},setSizeInfo:function(t){return this.sizeInfo=this.proportionalSymbolInfo=t,this._cache.sizeInfo=this._processSizeInfo(t),this},_processSizeInfo:function(t){return t&&{root:this._createCache(t),minSize:this._createCache(t.minSize),maxSize:this._createCache(t.maxSize)}},_getVarInfo:function(t,e){var i;return t&&t.type===e?(i=o.indexOf(this.visualVariables,t),t=this.visualVariables[i]):(i=e,t=this[e]),{variable:t,cacheKey:i}},setProportionalSymbolInfo:function(t){return this.setSizeInfo(t),this},getSize:function(t,e){var o=this._getVarInfo(e&&e.sizeInfo,"sizeInfo"),i=o.variable,n=this._cache[o.cacheKey],r=null;if(i){var a=i.minSize,s=i.maxSize,l="object"==typeof a&&a?this._getSize(t,a,n&&n.minSize,e):a,c="object"==typeof s&&s?this._getSize(t,s,n&&n.maxSize,e):s;r=this._getSize(t,i,n&&n.root,e,[l,c])}return r},_getSize:function(t,o,i,n,r){var a=t.attributes,s=o.field,c=o.expression,u=o.stops,f=0,p=i&&i.exprTree,h=i&&i.ipData,y="number"==typeof t,I=y?t:null;if(s||c||p){var _,m=n&&n.scale,g=r?r[0]:o.minSize,v=r?r[1]:o.maxSize,z=o.minDataValue,V=o.maxDataValue,b=o.valueUnit||"unknown",d=o.valueRepresentation,x=o.scaleBy,S=o.normalizationField,C=a?parseFloat(a[S]):void 0,O=n&&n.shape;if(c?I="view.scale"===c.toLowerCase()?m:null:"number"!=typeof I&&(p?I=this._executeExpr(p,this._createExprContext(t)):e.isFunction(s)?I=s.apply(this,arguments):a&&(I=a[s])),null==I||S&&!y&&(isNaN(C)||0===C))return null;if(isNaN(C)||y||(I/=C),u){var w,E,T=this._lookupData(I,h),F=T[0],j=T[1];F===j?f=u[F].size:(w=u[F].size,E=u[j].size,f=w+(E-w)*T[2])}else if(null!=g&&null!=v&&null!=z&&null!=V)if(z>=I)f=g;else if(I>=V)f=v;else if(_=(I-z)/(V-z),"area"===x&&O){var D="circle"===O,R=D?l*Math.pow(g/2,2):g*g,k=D?l*Math.pow(v/2,2):v*v,M=R+_*(k-R);f=D?2*Math.sqrt(M/l):Math.sqrt(M)}else f=g+_*(v-g);else if("unknown"===b)null!=g&&null!=z&&(g&&z?(_=I/z,f="circle"===O?2*Math.sqrt(_*Math.pow(g/2,2)):"square"===O||"diamond"===O||"image"===O?Math.sqrt(_*Math.pow(g,2)):_*g):f=I+(g||z),f=g>f?g:f,null!=v&&f>v&&(f=v));else{var N=(n&&n.resolution?n.resolution:1)*this._meterIn[b];"area"===d?(f=Math.sqrt(I/l)/N,f*=2):(f=I/N,("radius"===d||"distance"===d)&&(f*=2)),null!=g&&g>f&&(f=g),null!=v&&f>v&&(f=v)}}else f=u&&u[0]&&u[0].size,null==f&&(f=o.minSize);return f=isNaN(f)?0:f},getSizeRangeAtScale:function(t,e){var o,i=this._getVarInfo(t,"sizeInfo"),n=this._cache[i.cacheKey],r={scale:e};if(t=i.variable,t&&e){var a=t.minSize,s=t.maxSize,l="object"==typeof a&&a?this._getSize({},a,n&&n.minSize,r):a,c="object"==typeof s&&s?this._getSize({},s,n&&n.maxSize,r):s;(null!=l||null!=c)&&(o={minSize:l,maxSize:c})}return o},setColorInfo:function(t){return this.colorInfo=t,this._cache.colorInfo=this._processColorInfo(t),this},_createCache:function(t){return{ipData:this._interpolateData(t),exprTree:this._parseExpr(t&&t.valueExpression,{vars:{feature:"any"}})}},_processColorInfo:function(t){return t&&(o.forEach(t.colors,function(o,i){e.isArray(o)&&(t.colors[i]=new a(o))}),o.forEach(t.stops,function(o,i){o.color&&e.isArray(o.color)&&(t.stops[i].color=new a(o.color))})),this._createCache(t)},getColor:function(t,e){var o=this._getVarInfo(e&&e.colorInfo,"colorInfo");return this._getColorComponent(t,o.variable,this._cache[o.cacheKey])},setOpacityInfo:function(t){return this.opacityInfo=t,this._cache.opacityInfo=this._processOpacityInfo(t),this},_processOpacityInfo:function(t){return this._createCache(t)},getOpacity:function(t,e){var o=this._getVarInfo(e&&e.opacityInfo,"opacityInfo");return this._getColorComponent(t,o.variable,this._cache[o.cacheKey],!0)},_getColorComponent:function(t,o,i,n,r){var a,s=t.attributes,l=o&&o.field,c="number"==typeof t,u=c?t:null,f=i&&i.exprTree,p=i&&i.ipData;if(l||f){var h=o.normalizationField,y=s?parseFloat(s[h]):void 0;"number"!=typeof u&&(f?u=this._executeExpr(f,this._createExprContext(t)):e.isFunction(l)?u=l.apply(this,arguments):s&&(u=s[l])),null==u||h&&!c&&(isNaN(y)||0===y)||(isNaN(y)||c||(u/=y),a=n?this._getOpacity(u,o,p):this._getColor(u,o,p))}else if(o){var I=o.stops;n?(a=I&&I[0]&&I[0].opacity,null==a&&(a=o.opacityValues&&o.opacityValues[0])):a=I&&I[0]&&I[0].color||o.colors&&o.colors[0]}return r&&(r.data=u,r.value=a),r||a},_interpolateData:function(t){var e;if(t)if(t.colors||t.opacityValues){var i,n=(t.colors||t.opacityValues).length,r=t.minDataValue,a=(t.maxDataValue-r)/(n-1);for(e=[],i=0;n>i;i++)e[i]=r+i*a}else t.stops&&(e=o.map(t.stops,function(t){return t.value}));return e},_getOpacity:function(t,e,o){var i,n=this._lookupData(t,o);if(e=e||this.opacityInfo,n){var r,a,s=n[0],l=n[1];s===l?i=this._getOpacValue(e,s):(r=this._getOpacValue(e,s),a=this._getOpacValue(e,l),i=r+(a-r)*n[2])}return i},_getOpacValue:function(t,e){return t.opacityValues?t.opacityValues[e]:t.stops[e].opacity},_getColor:function(t,e,o){var i,n=this._lookupData(t,o);if(e=e||this.colorInfo,n){var r=n[0],s=n[1];i=r===s?this._getColorObj(e,r):a.blendColors(this._getColorObj(e,r),this._getColorObj(e,s),n[2])}return i},_getColorObj:function(t,e){return t.colors?t.colors[e]:t.stops[e].color},_lookupData:function(t,e){var i;if(e){var n=0,r=e.length-1;o.some(e,function(e,o){return e>t?(r=o,!0):(n=o,!1)}),i=[n,r,(t-e[n])/(e[r]-e[n])]}return i},_createExprContext:function(t){return{vars:{$feature:s.constructFeature(t)}}},_parseExpr:function(t,e){return t?s.parseScript(t,e):null},_executeExpr:function(t,e){return s.executeScript(t,e,-1)},_meterIn:{inches:39.3701,feet:3.28084,yards:1.09361,miles:621371e-9,"nautical-miles":539957e-9,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_writeSizeInfo:function(t){if(t){t=e.mixin({},t);var o=t.minSize,i=t.maxSize;o&&(t.minSize="number"==typeof o?n.px2pt(o):e.clone(o)),i&&(t.maxSize="number"==typeof i?n.px2pt(i):e.clone(i));var r=t.legendOptions;r&&(t.legendOptions=e.mixin({},r),r=r.customValues,r&&(t.legendOptions.customValues=r.slice(0)))}return t},_writeColorInfo:function(t){return t&&(t=e.mixin({},t),t.colors&&(t.colors=o.map(t.colors,function(t){return a.toJsonColor(t)})),t.stops&&(t.stops=o.map(t.stops,function(t){return t=e.mixin({},t),t.color&&(t.color=a.toJsonColor(t.color)),t}))),t},_writeOpacityInfo:function(t){var i;return t&&(i=e.mixin({},t),i.opacityValues&&(i.transparencyValues=o.map(i.opacityValues,function(t){return 100*(1-t)}),delete i.opacityValues),i.stops&&(i.stops=o.map(i.stops,function(t){return t=e.mixin({},t),t.transparency=100*(1-t.opacity),delete t.opacity,t})),i.legendOptions&&(i.legendOptions=e.mixin({},i.legendOptions))),i},toJson:function(){var t=this.visualVariables,i=e.clone(this.authoringInfo),n=this.getVisualVariablesForType("rotationInfo",!1),r=n&&n[0],a=r&&r.field,s=r&&(r.expression||a&&(e.isFunction(a)?a:"["+a+"]"));return t&&(t=o.map(t,function(t){return"sizeInfo"===t.type?t=this._writeSizeInfo(t):"colorInfo"===t.type?t=this._writeColorInfo(t):"opacityInfo"===t.type?(t=this._writeOpacityInfo(t),t.type="transparencyInfo"):"rotationInfo"===t.type&&(t=e.mixin({},t)),t},this)),i&&o.forEach(i.visualVariables,function(t){"opacityInfo"===t.type&&(t.type="transparencyInfo")}),{rotationType:s&&(this._getRotationType(r)||"geographic"),rotationExpression:s,colorInfo:this._writeColorInfo(this.colorInfo),transparencyInfo:this._writeOpacityInfo(this.opacityInfo),sizeInfo:this._writeSizeInfo(this.sizeInfo),visualVariables:t,authoringInfo:i}}});return i("extend-esri")&&e.setObject("renderer.Renderer",c,r),c});